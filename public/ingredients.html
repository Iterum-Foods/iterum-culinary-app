<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Ingredient Database | Iterum R&D Chef Notebook</title>
    
    <!-- Auth System (v2.0) -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/auth-api-helper.js"></script>
    <script src="assets/js/auth-diagnostics.js"></script>
    <script src="assets/js/auth_guard.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shadows+Into+Light:wght@400&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- UNIFIED COLOR SYSTEM - MUST LOAD FIRST -->
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/modal-high-contrast.css">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="stylesheet" href="assets/css/premium-ui-system.css">
    <link rel="stylesheet" href="assets/css/unified-cards.css">
    <link rel="stylesheet" href="assets/css/page-layouts.css">
    <link rel="stylesheet" href="assets/css/high-contrast-universal.css">
    <link rel="stylesheet" href="assets/css/nordic-design-system.css">
    <link rel="stylesheet" href="assets/css/modern-nordic-vintage.css">
    <link rel="stylesheet" href="assets/css/dark-mode-enhancements.css">
    <link rel="stylesheet" href="assets/css/ui-polish.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
    
    
    <!-- Load Enhanced User Management System -->
    <!-- Enhanced User Management now handled by Firebase Auth -->
    <script src="assets/js/project-management-system.js"></script>
    <!-- Project management now handled by new system -->
    <script src="assets/js/error_handler.js"></script>
    
    <!-- Base Ingredients Loader -->
    <script src="assets/js/base-ingredients-loader.js"></script>
    <!-- Enhanced Ingredients Manager -->
    <script src="assets/js/ingredients-manager-enhanced.js"></script>
    <!-- Unit Converter -->
    <script src="assets/js/unit-converter.js"></script>
    <!-- Vendor Price Comparator -->
    <script src="assets/js/vendor-price-comparator.js"></script>
    
    <!-- State Persistence -->
    <script src="assets/js/state-persistence-manager.js"></script>
    <script src="assets/js/unified-nav-header.js" defer></script>
    <script src="assets/js/unified-project-selector.js" defer></script>
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/header-universal.css">
</head>
<body class="bg-gray-50 min-h-screen" style="padding-top: 80px;">
    <!-- Header injected by unified-nav-header.js -->

    <!-- Main Content -->
    <main style="padding: 20px;">
        <div class="container">
            <div class="page-header">
                <h1 class="heading-1">Master Ingredient Database</h1>
                <p class="body-large">Comprehensive ingredient management with nutritional data, suppliers, and cost tracking.</p>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 12px; margin-bottom: 30px; flex-wrap: wrap;">
                <button onclick="window.baseIngredientsLoader.showImportModal()" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span>üì¶</span>
                    <span>Import Base Database (100+ Ingredients)</span>
                </button>
                <button onclick="window.location.href='bulk-ingredient-import.html'" class="btn btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <span>üì•</span>
                    <span>Bulk Import Ingredients</span>
                </button>
                <button onclick="window.location.href='price-list-upload.html'" class="btn btn-primary" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <span>üí∞</span>
                    <span>Upload Price List</span>
                </button>
            </div>

            <!-- Add New Ingredient Section -->
            <div class="card mb-6">
                <h2 class="heading-2">Add Single Ingredient</h2>
                <form id="add-ingredient-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredient-name" class="form-label">Ingredient Name</label>
                            <input type="text" id="ingredient-name" class="form-input" placeholder="e.g., Organic Kale" required>
                        </div>
                        <div class="form-group">
                            <label for="ingredient-category" class="form-label">Category</label>
                            <select id="ingredient-category" class="form-select" required onchange="updateSubcategoryOptions()">
                                <option value="">Select category</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                                <option value="proteins">Proteins</option>
                                <option value="grains">Grains</option>
                                <option value="dairy">Dairy</option>
                                <option value="spices">Spices & Herbs</option>
                                <option value="oils">Oils & Fats</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ingredient-subcategory" class="form-label">Subcategory / Type / Brand</label>
                            <input type="text" id="ingredient-subcategory" class="form-input" placeholder="e.g., Organic, Premium Brand, Extra Virgin" list="subcategory-suggestions">
                            <datalist id="subcategory-suggestions">
                                <!-- Options will be populated dynamically -->
                            </datalist>
                            <small style="color: #64748b; font-size: 0.875rem; display: block; margin-top: 4px;">Optional: Specify type, brand, or specific variety</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredient-unit" class="form-label">Base Unit <span style="color: #64748b; font-weight: 400;">(for recipes)</span></label>
                            <select id="ingredient-unit" class="form-select" required>
                                <option value="g">Grams (g)</option>
                                <option value="kg">Kilograms (kg)</option>
                                <option value="ml">Milliliters (ml)</option>
                                <option value="l">Liters (l)</option>
                                <option value="piece">Piece</option>
                                <option value="bunch">Bunch</option>
                                <option value="oz">Ounces (oz)</option>
                                <option value="lb">Pounds (lb)</option>
                                <option value="cup">Cups</option>
                            </select>
                            <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">Standard unit used in all recipes</small>
                        </div>
                        <div class="form-group">
                            <label for="ingredient-cost" class="form-label">Cost per Base Unit</label>
                            <input type="number" id="ingredient-cost" class="form-input" step="0.01" min="0" placeholder="0.00" readonly>
                            <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">Auto-calculated from case pricing</small>
                        </div>
                    </div>
                    
                    <!-- Phase 1: Case Pricing Fields -->
                    <div class="card" style="background: #F5F7F9; border: 2px solid #5B9BAD; margin: 20px 0; padding: 20px;">
                        <h3 style="color: #1F2D35; font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <span>üì¶</span> Phase 1: Vendor Case Pricing (Source of Truth)
                        </h3>
                        <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 16px;">Enter vendor invoice pricing to calculate accurate unit costs</p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="price-per-case" class="form-label">Price per Case ($)</label>
                                <input type="number" id="price-per-case" class="form-input" step="0.01" min="0" placeholder="0.00" onchange="calculateBaseUnitCost()" oninput="calculateBaseUnitCost()">
                                <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">From vendor invoice (e.g., $45.99)</small>
                            </div>
                            <div class="form-group">
                                <label for="case-size" class="form-label">Case Size</label>
                                <input type="number" id="case-size" class="form-input" step="0.01" min="0" placeholder="e.g., 12" onchange="calculateBaseUnitCost()" oninput="calculateBaseUnitCost()">
                                <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">Quantity in case (e.g., 12 pieces, 50 lbs)</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="case-unit" class="form-label">Case Unit</label>
                                <select id="case-unit" class="form-select" onchange="calculateBaseUnitCost()" oninput="calculateBaseUnitCost()">
                                    <option value="each">Each (pieces)</option>
                                    <option value="lb">Pounds (lb)</option>
                                    <option value="oz">Ounces (oz)</option>
                                    <option value="g">Grams (g)</option>
                                    <option value="kg">Kilograms (kg)</option>
                                    <option value="gal">Gallons (gal)</option>
                                    <option value="qt">Quarts (qt)</option>
                                    <option value="l">Liters (l)</option>
                                    <option value="ml">Milliliters (ml)</option>
                                    <option value="case">Case</option>
                                </select>
                                <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">Unit sold by vendor</small>
                            </div>
                            <div class="form-group">
                                <label for="conversion-factor" class="form-label">Conversion Factor</label>
                                <input type="number" id="conversion-factor" class="form-input" step="0.01" min="0" placeholder="1.0" value="1.0" onchange="calculateBaseUnitCost()" oninput="calculateBaseUnitCost()">
                                <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                                    To convert case unit to base unit
                                    <span style="display: block; margin-top: 2px; color: #8A9299; font-size: 0.7rem;">
                                        Example: If case is in lbs and base unit is grams, use 453.592 (1 lb = 453.592 g)
                                    </span>
                                </small>
                            </div>
                        </div>
                        
                        <div id="calculation-error" style="display: none;"></div>
                        
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid #E5E9EC;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #3E4C54; font-weight: 600; font-size: 0.875rem;">Cost per Base Unit:</span>
                                <span id="calculated-base-cost" style="color: #8A9299; font-weight: 700; font-size: 1.1rem;">$0.00</span>
                            </div>
                            <small style="color: #8A9299; font-size: 0.7rem; display: block; margin-top: 4px;">Formula: (Price per Case) √∑ (Case Size √ó Conversion Factor)</small>
                            <div id="calculation-formula"></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ingredient-supplier" class="form-label">Primary Supplier</label>
                            <input type="text" id="ingredient-supplier" class="form-input" placeholder="Supplier name">
                        </div>
                        <div class="form-group">
                            <label for="ingredient-url" class="form-label">URL Import</label>
                            <div class="flex gap-2">
                                <input type="url" id="ingredient-url" class="form-input" placeholder="Paste ingredient URL">
                                <button type="button" class="btn btn-secondary" onclick="previewURLImport()">Preview</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">‚ûï Add Ingredient</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Search and Filter Section -->
            <div class="card mb-6">
                <h2 class="heading-2">Search Ingredients</h2>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="search-query" class="form-label">Search</label>
                        <input type="text" id="search-query" class="form-input" placeholder="Search ingredients...">
                    </div>
                    <div class="form-group">
                        <label for="filter-category" class="form-label">Category</label>
                        <select id="filter-category" class="form-select" onchange="updateSubcategoryFilterOptions()">
                            <option value="">All Categories</option>
                            <option value="vegetables">Vegetables</option>
                            <option value="fruits">Fruits</option>
                            <option value="proteins">Proteins</option>
                            <option value="grains">Grains</option>
                            <option value="dairy">Dairy</option>
                            <option value="spices">Spices & Herbs</option>
                            <option value="oils">Oils & Fats</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-subcategory" class="form-label">Subcategory / Type / Brand</label>
                        <select id="filter-subcategory" class="form-select">
                            <option value="">All Subcategories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-supplier" class="form-label">Supplier</label>
                        <select id="filter-supplier" class="form-select">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sort-by" class="form-label">Sort By</label>
                        <select id="sort-by" class="form-select">
                            <option value="name">Name</option>
                            <option value="category">Category</option>
                            <option value="cost">Cost</option>
                            <option value="date-added">Date Added</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="searchIngredients()">üîç Search</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
            </div>

            <!-- View Toggle and Section Toggle -->
            <div style="display: flex; justify-content: space-between; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span style="color: #64748b; font-weight: 500; font-size: 0.875rem;">Show:</span>
                    <button id="show-all-btn" class="btn btn-primary" onclick="filterIngredients('all')" style="padding: 8px 16px; font-size: 0.875rem;">
                        <span>üìö</span> All
                    </button>
                    <button id="show-builtin-btn" class="btn btn-secondary" onclick="filterIngredients('builtin')" style="padding: 8px 16px; font-size: 0.875rem;">
                        <span>üì¶</span> Built-in
                    </button>
                    <button id="show-custom-btn" class="btn btn-secondary" onclick="filterIngredients('custom')" style="padding: 8px 16px; font-size: 0.875rem;">
                        <span>‚ûï</span> My Products
                    </button>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span style="color: #64748b; font-weight: 500; font-size: 0.875rem;">View:</span>
                    <button id="grid-view-btn" class="btn btn-secondary" onclick="switchView('grid')" style="padding: 8px 16px; font-size: 0.875rem;">
                        <span>üÉè</span> Cards
                    </button>
                    <button id="table-view-btn" class="btn btn-primary" onclick="switchView('table')" style="padding: 8px 16px; font-size: 0.875rem;">
                        <span>üìä</span> Spreadsheet
                    </button>
                </div>
            </div>

            <!-- Ingredients Grid View -->
            <div id="ingredients-grid-container" style="display: none;">
                <div class="grid-3-col" id="ingredients-grid">
                    <!-- Ingredients will be populated here -->
                </div>
            </div>

            <!-- Ingredients Table View (Spreadsheet Style) -->
            <div id="ingredients-table-container">
                <div class="card" style="overflow-x: auto;">
                    <table id="ingredients-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #5B9BAD 0%, #6B8E6F 100%); color: white;">
                                <th style="padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.875rem; white-space: nowrap; position: sticky; left: 0; z-index: 10;">Ingredient Name</th>
                                <th style="padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.875rem; white-space: nowrap;">Category</th>
                                <th style="padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.875rem; white-space: nowrap;">Subcategory</th>
                                <th style="padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.875rem; white-space: nowrap;">Unit</th>
                                <th style="padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.875rem; white-space: nowrap;">Cost</th>
                                <th style="padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.875rem; white-space: nowrap;">Supplier</th>
                                <th style="padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.875rem; white-space: nowrap;">Date Added</th>
                                <th style="padding: 14px 16px; text-align: center; font-weight: 600; font-size: 0.875rem; white-space: nowrap;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredients-table-body">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Essential Scripts -->
    <script>
        // Main initialization - Single entry point
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOM Loaded - Initializing Ingredients Page');
            
            // Setup event listeners first
            setupEventListeners();
            
            // Wait a moment for auth to be ready
            await waitForAuth();
            
            // Initialize ingredients manager
            await window.ingredientsManager.init();
            
            // Load ingredients FIRST
            await loadIngredientsDatabase();
            
            // THEN initialize view mode (which will display the loaded ingredients)
            switchView(currentView);
            
            console.log('‚úÖ Ingredients Page Ready');
        });

        async function waitForAuth() {
            console.log('‚è≥ Waiting for auth...');
            let attempts = 0;
            while (attempts < 30 && !window.authManager?.currentUser) {
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
            console.log('‚úÖ Auth ready');
        }

        async function loadIngredientsDatabase() {
            console.log('ü•¨ Loading Ingredients Database...');
            
            // Check if ingredients already exist in localStorage
            const storedIngredients = localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients');
            
            if (storedIngredients && storedIngredients !== '[]') {
                // Load from cache immediately
                try {
                    const cached = JSON.parse(storedIngredients);
                    console.log(`üì¶ Found ${cached.length} cached ingredients in localStorage`);
                    if (cached && Array.isArray(cached) && cached.length > 0) {
                        console.log('‚úÖ Valid ingredients array found, will display after view initialization');
                        // Store in a global variable so it can be accessed by displayIngredients
                        window._loadedIngredients = cached;
                        updateStats(cached);
                        return;
                    } else {
                        console.warn('‚ö†Ô∏è Cached ingredients array is empty or invalid');
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing cached ingredients:', e);
                }
            }
            
            // Show loading and fetch from database
            console.log('üì• No valid ingredients found in localStorage, fetching from database...');
            showLoadingState();
            await directImportAndDisplay();
        }
        
        function showLoadingState() {
            const grid = document.getElementById('ingredients-grid');
            if (grid) {
                grid.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px; grid-column: 1 / -1;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üì¶</div>
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: #0f172a;">Loading Ingredients...</h2>
                        <p style="color: #64748b; margin-bottom: 15px;">Please wait while we import the ingredient database.</p>
                        <div class="loading-spinner" style="margin: 20px auto; width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #5a67d8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                `;
            }
        }
        
        async function directImportAndDisplay() {
            console.log('üöÄ Fetching ingredients database from file...');
            
            try {
                // Direct fetch with absolute path
                const response = await fetch('data/base-ingredients-database.json');
                
                console.log('üì° Fetch response:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Database file not found (${response.status})`);
                }
                
                const database = await response.json();
                
                if (!database || !database.ingredients) {
                    throw new Error('Invalid database format');
                }
                
                const ingredients = database.ingredients;
                console.log(`‚úÖ Loaded ${ingredients.length} ingredients from database`);
                
                // Ensure it's an array
                if (!Array.isArray(ingredients)) {
                    throw new Error('Ingredients is not an array');
                }
                
                // Save to localStorage (both keys for compatibility)
                localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
                localStorage.setItem('ingredients', JSON.stringify(ingredients));
                
                // Store in global variable for immediate access
                window._loadedIngredients = ingredients;
                
                console.log(`üíæ Saved ${ingredients.length} ingredients to localStorage`);
                
                // Display immediately if view is already initialized
                if (document.getElementById('ingredients-table-body') || document.getElementById('ingredients-grid')) {
                    console.log(`üé® Displaying ${ingredients.length} ingredients...`);
                    displayIngredients(ingredients);
                    updateStats(ingredients);
                } else {
                    console.log('‚è≥ View containers not ready yet, ingredients will display when view initializes');
                }
                
                console.log(`‚úÖ SUCCESS: ${ingredients.length} ingredients displayed!`);
                
            } catch (error) {
                console.error('‚ùå Error loading ingredients:', error);
                
                // Try to load from localStorage as fallback
                const stored = localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients');
                if (stored && stored !== '[]') {
                    try {
                        const ingredients = JSON.parse(stored);
                        console.log(`üì¶ Fallback: Loaded ${ingredients.length} ingredients from cache`);
                        displayIngredients(ingredients);
                        updateStats(ingredients);
                    } catch (parseError) {
                        console.error('‚ùå Error parsing cached ingredients:', parseError);
                        showErrorState(error);
                    }
                } else {
                    showErrorState(error);
                }
            }
        }
        
        function showErrorState(error) {
            const grid = document.getElementById('ingredients-grid');
            if (grid) {
                grid.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px; grid-column: 1 / -1;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚ùå</div>
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: #dc2626;">Error Loading Ingredients</h2>
                        <p style="color: #64748b; margin-bottom: 15px;">Could not load ingredient database.</p>
                        <p style="color: #64748b; margin-bottom: 25px; font-family: monospace; background: #fee2e2; padding: 12px; border-radius: 8px;">Error: ${error.message}</p>
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="location.reload()">üîÑ Reload Page</button>
                            <button class="btn btn-secondary" onclick="directImportAndDisplay()">üì• Try Import Again</button>
                            <button class="btn btn-secondary" onclick="window.open('https://console.firebase.google.com/project/iterum-culinary-app', '_blank')">üîß Check Firebase</button>
                        </div>
                    </div>
                `;
            }
        }

        // Check and auto-import ingredients on first load
        function checkAndAutoImportIngredients() {
            const ingredientsDb = localStorage.getItem('ingredients_database');
            const ingredients = localStorage.getItem('ingredients');
            
            // If both are empty or null, trigger auto-import
            if ((!ingredientsDb || ingredientsDb === '[]') && (!ingredients || ingredients === '[]')) {
                console.log('üì¶ No ingredients found, triggering auto-import...');
                
                // Show loading message
                const grid = document.getElementById('ingredients-grid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Loading Ingredients Database...</div>
                            <div style="color: #64748b;">Importing professional culinary ingredients</div>
                        </div>
                    `;
                }
                
                // Auto-import after a brief delay to let scripts load
                setTimeout(() => {
                    autoImportBaseIngredients();
                }, 500);
            }
        }

        function updateUserInfo() {
            const currentUser = window.userSystem?.getCurrentUser();
            if (currentUser) {
                document.getElementById('current-user').textContent = currentUser.name || 'User';
                document.getElementById('dropdown-user-name').textContent = currentUser.name || 'User';
                document.getElementById('user-avatar-initial').textContent = (currentUser.name || 'U')[0].toUpperCase();
            }
        }

        function initializeProjectSelector() {
            if (window.projectManager) {
                window.projectManager.loadUserProjects();
            }
        }

        function setupEventListeners() {
            // Form submission
            document.getElementById('add-ingredient-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addIngredient();
            });

            // Search input
            document.getElementById('search-query').addEventListener('input', function() {
                searchIngredients();
            });

            // Filter changes
            document.getElementById('filter-category').addEventListener('change', searchIngredients);
            document.getElementById('filter-supplier').addEventListener('change', searchIngredients);
            document.getElementById('sort-by').addEventListener('change', searchIngredients);
        }

        function loadIngredients() {
            // Load ingredients from localStorage or global variable
            let ingredients = null;
            if (window._loadedIngredients && Array.isArray(window._loadedIngredients)) {
                ingredients = window._loadedIngredients;
                console.log(`üìä Using cached ingredients from memory: ${ingredients.length}`);
            } else {
                const stored = localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients');
                ingredients = stored ? JSON.parse(stored) : [];
                
                // Fallback to old key if database is empty
                if (!ingredients || ingredients.length === 0) {
                    const oldKey = localStorage.getItem('ingredients');
                    ingredients = oldKey ? JSON.parse(oldKey) : [];
                }
                
                // Store in global for future use
                window._loadedIngredients = ingredients;
                console.log(`üìä Loaded ${ingredients.length} ingredients from localStorage`);
            }
            
            if (!ingredients || !Array.isArray(ingredients)) {
                console.warn('‚ö†Ô∏è Invalid ingredients data, resetting to empty array');
                ingredients = [];
            }
            
            displayIngredients(ingredients);
            updateStats(ingredients);
        }
        
        function updateStats(ingredients) {
            // Update stats at top of page
            const totalEl = document.querySelector('.stat-value');
            if (totalEl) {
                totalEl.textContent = ingredients.length;
            }
        }

        // Current view mode (grid or table)
        let currentView = localStorage.getItem('ingredients_view_mode') || 'table';

        function switchView(mode) {
            currentView = mode;
            localStorage.setItem('ingredients_view_mode', mode);
            
            const gridContainer = document.getElementById('ingredients-grid-container');
            const tableContainer = document.getElementById('ingredients-table-container');
            const gridBtn = document.getElementById('grid-view-btn');
            const tableBtn = document.getElementById('table-view-btn');
            
            if (mode === 'grid') {
                gridContainer.style.display = 'block';
                tableContainer.style.display = 'none';
                gridBtn.classList.add('btn-primary');
                gridBtn.classList.remove('btn-secondary');
                tableBtn.classList.add('btn-secondary');
                tableBtn.classList.remove('btn-primary');
            } else {
                gridContainer.style.display = 'none';
                tableContainer.style.display = 'block';
                tableBtn.classList.add('btn-primary');
                tableBtn.classList.remove('btn-secondary');
                gridBtn.classList.add('btn-secondary');
                gridBtn.classList.remove('btn-primary');
            }
            
            // Reload ingredients in the current view
            let ingredients = null;
            if (window._loadedIngredients && Array.isArray(window._loadedIngredients)) {
                ingredients = window._loadedIngredients;
            } else {
                const stored = localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients');
                ingredients = stored ? JSON.parse(stored) : [];
            }
            displayIngredients(ingredients);
        }

        function displayIngredients(ingredients) {
            // Ensure ingredients is an array
            if (!ingredients || !Array.isArray(ingredients)) {
                console.warn('‚ö†Ô∏è displayIngredients called with invalid data:', ingredients);
                ingredients = [];
            }
            
            console.log(`üìä Displaying ${ingredients.length} ingredients in ${currentView} view`);
            
            // Show in table view by default, grid view as option
            if (currentView === 'table') {
                displayIngredientsTable(ingredients);
            } else {
                displayIngredientsGrid(ingredients);
            }
        }

        function displayIngredientsGrid(ingredients) {
            const grid = document.getElementById('ingredients-grid');
            
            if (!grid) {
                console.error('‚ùå Ingredients grid not found');
                return;
            }
            
            grid.innerHTML = '';

            if (!ingredients || ingredients.length === 0) {
                // Check if we're still loading
                const isLoading = !localStorage.getItem('ingredients_database') && !localStorage.getItem('ingredients');
                
                if (isLoading) {
                    grid.innerHTML = `
                        <div class="card" style="text-align: center; padding: 60px; grid-column: 1 / -1;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üì¶</div>
                            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">Loading Ingredients...</h2>
                            <p style="color: #64748b; margin-bottom: 15px;">Please wait while we import the ingredient database.</p>
                            <div class="loading-spinner" style="margin: 20px auto;"></div>
                        </div>
                    `;
                } else {
                    grid.innerHTML = `
                        <div class="card" style="text-align: center; padding: 60px; grid-column: 1 / -1;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">ü•¨</div>
                            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">No Ingredients Found</h2>
                            <p style="color: #64748b; margin-bottom: 25px;">The ingredient database appears to be empty.</p>
                            <button class="btn" onclick="directImportAndDisplay()">üîÑ Reload Database</button>
                        </div>
                    `;
                }
                return;
            }

            console.log(`‚úÖ Displaying ${filteredIngredients.length} ingredients in grid view (filter: ${currentFilter})`);
            
            // Show section headers if showing all
            if (currentFilter === 'all') {
                const builtIn = filteredIngredients.filter(ing => ingredientsManager.isBuiltIn(ing));
                const custom = filteredIngredients.filter(ing => ingredientsManager.isCustom(ing));
                
                if (builtIn.length > 0) {
                    grid.innerHTML += `
                        <div class="card" style="grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin-bottom: 10px;">
                            <h2 style="font-size: 1.3rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px;">
                                <span>üì¶</span> Built-in Ingredients (${builtIn.length})
                            </h2>
                            <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Professional culinary ingredients database</p>
                        </div>
                    `;
                }
                
                builtIn.forEach(ingredient => {
                    const card = createIngredientCard(ingredient, true); // true = isBuiltIn
                    grid.appendChild(card);
                });
                
                if (custom.length > 0) {
                    grid.innerHTML += `
                        <div class="card" style="grid-column: 1 / -1; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; margin: 20px 0 10px 0;">
                            <h2 style="font-size: 1.3rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px;">
                                <span>‚ûï</span> My Products (${custom.length})
                            </h2>
                            <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Your custom ingredients and products</p>
                        </div>
                    `;
                }
                
                custom.forEach(ingredient => {
                    const card = createIngredientCard(ingredient, false); // false = isCustom
                    grid.appendChild(card);
                });
            } else {
                // Show filtered list without section headers
                filteredIngredients.forEach(ingredient => {
                    const isBuiltIn = ingredientsManager.isBuiltIn(ingredient);
                    const card = createIngredientCard(ingredient, isBuiltIn);
                    grid.appendChild(card);
                });
            }
        }

        function displayIngredientsTable(ingredients) {
            const tbody = document.getElementById('ingredients-table-body');
            
            if (!tbody) {
                console.error('‚ùå Ingredients table body not found');
                return;
            }
            
            tbody.innerHTML = '';

            if (!ingredients || ingredients.length === 0) {
                const isLoading = !localStorage.getItem('ingredients_database') && !localStorage.getItem('ingredients');
                
                if (isLoading) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 60px; color: #64748b;">
                                <div style="font-size: 4rem; margin-bottom: 20px;">üì¶</div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 10px;">Loading Ingredients...</h3>
                                <p>Please wait while we import the ingredient database.</p>
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 60px; color: #64748b;">
                                <div style="font-size: 4rem; margin-bottom: 20px;">ü•¨</div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 10px;">No Ingredients Found</h3>
                                <p style="margin-bottom: 25px;">The ingredient database appears to be empty.</p>
                                <button class="btn btn-primary" onclick="directImportAndDisplay()">üîÑ Reload Database</button>
                            </td>
                        </tr>
                    `;
                }
                return;
            }

            console.log(`‚úÖ Displaying ${ingredients.length} ingredients in table view`);

            // Organize ingredients: main ingredients first, then their variants
            const organizedIngredients = organizeIngredientsWithVariants(ingredients);
            
            tbody.innerHTML = organizedIngredients.map(item => {
                if (item.isVariant) {
                    // Render variant row (indented)
                    return `
                        <tr style="border-bottom: 1px solid #e8f0f6; transition: background 0.2s; background: #FAFBFC;">
                            <td style="padding: 12px 16px 12px 48px; font-weight: 500; color: #64748b; position: sticky; left: 0; background: #FAFBFC; z-index: 1; font-size: 0.9rem;">
                                <span style="color: #8A9299;">‚îî‚îÄ</span> ${item.supplier || 'Unknown Vendor'}
                            </td>
                            <td style="padding: 12px 16px; color: #64748b; font-size: 0.875rem;">-</td>
                            <td style="padding: 12px 16px; color: #64748b; font-size: 0.875rem;">-</td>
                            <td style="padding: 12px 16px; color: #64748b; font-size: 0.875rem;">${item.unit || 'g'}</td>
                            <td style="padding: 12px 16px; color: #3E4C54; font-weight: 600;">
                                $${(item.cost || 0).toFixed(2)}
                                ${item.priceHistory && item.priceHistory.length > 1 ? 
                                    `<span style="color: #8A9299; font-size: 0.75rem; margin-left: 4px;">(${item.priceHistory.length} prices)</span>` : ''}
                            </td>
                            <td style="padding: 12px 16px; color: #64748b; font-size: 0.875rem; font-weight: 500;">${item.supplier || '-'}</td>
                            <td style="padding: 12px 16px; color: #64748b; font-size: 0.875rem;">
                                ${item.dateAdded ? new Date(item.dateAdded).toLocaleDateString() : '-'}
                            </td>
                            <td style="padding: 12px 16px; text-align: center;">
                                <div style="display: flex; gap: 6px; justify-content: center;">
                                    <button onclick="editVariant('${item.id}')" title="Edit Variant" style="padding: 4px 10px; background: #5B9BAD; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.7rem;">‚úèÔ∏è</button>
                                    <button onclick="viewPriceHistory('${item.id}')" title="Price History" style="padding: 4px 10px; background: #6B8E6F; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.7rem;">üìä</button>
                                    <button onclick="addVariantPrice('${item.parentIngredientId || item.id}')" title="Add New Price" style="padding: 4px 10px; background: #D4A574; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.7rem;">üí∞</button>
                                    <button onclick="deleteIngredient('${item.id}')" title="Delete Variant" style="padding: 4px 10px; background: #C97676; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.7rem;">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    // Render main ingredient row
                    const variants = item.variants || [];
                    const variantCount = variants.length;
                    return `
                        <tr style="border-bottom: ${variantCount > 0 ? 'none' : '1px solid #e2e8f0'}; transition: background 0.2s; background: white;">
                            <td style="padding: 14px 16px; font-weight: 700; color: #2C4A52; position: sticky; left: 0; background: white; z-index: 1; font-size: 1rem;">
                                ${item.name || 'N/A'}
                                ${ingredientsManager.isBuiltIn(item) ? `<span style="display: inline-block; padding: 2px 8px; background: #667eea; color: white; border-radius: 8px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;">üì¶ Built-in</span>` : `<span style="display: inline-block; padding: 2px 8px; background: #10b981; color: white; border-radius: 8px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;">‚ûï My Product</span>`}
                                ${variantCount > 0 ? `<span style="color: #64748b; font-weight: 500; font-size: 0.75rem; margin-left: 8px;">(${variantCount} vendor${variantCount !== 1 ? 's' : ''})</span>` : ''}
                            </td>
                            <td style="padding: 14px 16px; color: #3E4C54; font-weight: 500;">
                                ${item.category || 'Uncategorized'}
                            </td>
                            <td style="padding: 14px 16px; color: #64748b;">
                                ${item.subcategory || '-'}
                            </td>
                            <td style="padding: 14px 16px; color: #3E4C54;">
                                ${item.unit || 'g'}
                            </td>
                            <td style="padding: 14px 16px; color: #3E4C54; font-weight: 600;">
                                ${item.cost > 0 ? `
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <span style="color: #6B8E6F; font-weight: 700; font-size: 1rem;">$${item.cost.toFixed(4)}</span>
                                        <span style="color: #8A9299; font-size: 0.7rem;">per ${item.unit || 'unit'}</span>
                                    </div>
                                ` : '-'}
                                ${item.casePricing ? `
                                    <div style="margin-top: 6px; padding: 6px 8px; background: #F5F7F9; border-radius: 6px; border-left: 3px solid #5B9BAD;">
                                        <div style="color: #3E4C54; font-size: 0.7rem; font-weight: 600; margin-bottom: 2px;">üì¶ Case Pricing:</div>
                                        <div style="color: #64748b; font-size: 0.65rem; line-height: 1.4;">
                                            $${item.casePricing.pricePerCase.toFixed(2)} / ${item.casePricing.caseSize} ${item.casePricing.caseUnit}
                                            ${item.casePricing.conversionFactor !== 1 ? `<br>Conv: ${item.casePricing.conversionFactor}` : ''}
                                        </div>
                                        ${item.casePricing.lastUpdated ? `
                                            <div style="color: #8A9299; font-size: 0.6rem; margin-top: 2px;">
                                                Updated: ${new Date(item.casePricing.lastUpdated).toLocaleDateString()}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                ${variantCount > 0 ? `<span style="color: #8A9299; font-size: 0.75rem; display: block; margin-top: 2px;">See variants below</span>` : ''}
                            </td>
                            <td style="padding: 14px 16px; color: #64748b;">
                                ${item.supplier || '-'}
                            </td>
                            <td style="padding: 14px 16px; color: #64748b; font-size: 0.875rem;">
                                ${item.dateAdded ? new Date(item.dateAdded).toLocaleDateString() : '-'}
                            </td>
                            <td style="padding: 14px 16px; text-align: center;">
                                <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="editIngredient('${item.id}')" style="padding: 6px 12px; background: #5B9BAD; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">‚úèÔ∏è Edit</button>
                                    <button onclick="addVariantPrice('${item.id}')" style="padding: 6px 12px; background: #D4A574; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">üí∞ Add Vendor</button>
                                    <button onclick="viewIngredient('${item.id}')" style="padding: 6px 12px; background: #6B8E6F; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">üëÅÔ∏è View</button>
                                    <button onclick="deleteIngredient('${item.id}')" style="padding: 6px 12px; background: #C97676; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">üóëÔ∏è Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }).join('');

            // Add hover effects
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.background = '#E8F4F8';
                    // Also update sticky column
                    const stickyCell = this.querySelector('td:first-child');
                    if (stickyCell) stickyCell.style.background = '#E8F4F8';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.background = '';
                    const stickyCell = this.querySelector('td:first-child');
                    if (stickyCell) stickyCell.style.background = 'white';
                });
            });
        }

        function createIngredientCard(ingredient, isBuiltIn = false) {
            const card = document.createElement('div');
            card.className = 'card card-hover';
            const subcategoryBadge = ingredient.subcategory 
                ? `<span style="display: inline-block; padding: 4px 10px; background: #E8F4F8; color: #5B9BAD; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">${ingredient.subcategory}</span>` 
                : '';
            // Badge for built-in vs custom
            const typeBadge = isBuiltIn 
                ? `<span style="display: inline-block; padding: 4px 10px; background: #667eea; color: white; border-radius: 12px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;">üì¶ Built-in</span>`
                : `<span style="display: inline-block; padding: 4px 10px; background: #10b981; color: white; border-radius: 12px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;">‚ûï My Product</span>`;

            // Vendor prices info
            const vendorCount = ingredient.vendorPrices?.length || 0;
            const bestPrice = ingredient.bestPrice;
            const vendorInfo = vendorCount > 0 
                ? `<div style="padding: 8px; background: #f0f9ff; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #3b82f6;">
                    <div style="font-size: 0.7rem; color: #1e40af; font-weight: 600; margin-bottom: 2px;">üí∞ ${vendorCount} Vendor${vendorCount !== 1 ? 's' : ''}</div>
                    ${bestPrice ? `<div style="font-size: 0.65rem; color: #64748b;">Best: $${bestPrice.price.toFixed(2)}/${bestPrice.unit} from ${bestPrice.vendor}</div>` : ''}
                </div>`
                : '';

            card.innerHTML = `
                <div class="card-header-gradient">
                    <div class="card-title">${ingredient.name}${typeBadge}</div>
                    <div class="card-subtitle">${ingredient.category || 'Uncategorized'}${subcategoryBadge}</div>
                </div>
                <div class="card-body">
                    <div class="stats-row mb-4">
                        <div class="stat-item-centered">
                            <div class="stat-value text-primary">$${(ingredient.cost || 0).toFixed(4)}</div>
                            <div class="stat-label">Cost per ${ingredient.unit || 'unit'}</div>
                        </div>
                        <div class="stat-item-centered">
                            <div class="stat-value text-primary">${ingredient.unit || 'g'}</div>
                            <div class="stat-label">Base Unit</div>
                        </div>
                    </div>
                    ${vendorInfo}
                    ${ingredient.casePricing ? `
                        <div style="padding: 10px; background: #F5F7F9; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #5B9BAD;">
                            <div style="font-size: 0.7rem; color: #3E4C54; font-weight: 600; margin-bottom: 4px;">üì¶ Case Pricing:</div>
                            <div style="font-size: 0.65rem; color: #64748b; line-height: 1.4;">
                                $${ingredient.casePricing.pricePerCase.toFixed(2)} / ${ingredient.casePricing.caseSize} ${ingredient.casePricing.caseUnit}
                            </div>
                        </div>
                    ` : ''}
                    <div class="button-group">
                        ${!isBuiltIn ? `<button class="btn btn-sm btn-secondary" onclick="editIngredient('${ingredient.id}')">‚úèÔ∏è Edit</button>` : ''}
                        <button class="btn btn-sm btn-secondary" onclick="viewIngredient('${ingredient.id}')">üëÅÔ∏è View</button>
                        <button class="btn btn-sm btn-secondary" onclick="manageVendorPrices('${ingredient.id}')">üí∞ Vendors</button>
                        ${!isBuiltIn ? `<button class="btn btn-sm btn-danger" onclick="deleteIngredient('${ingredient.id}')">üóëÔ∏è Delete</button>` : ''}
                    </div>
                </div>
            `;
            return card;
        }

        // Phase 1: Calculate Cost per Base Unit from Case Pricing
        function calculateBaseUnitCost() {
            const pricePerCase = parseFloat(document.getElementById('price-per-case').value) || 0;
            const caseSize = parseFloat(document.getElementById('case-size').value) || 0;
            const conversionFactor = parseFloat(document.getElementById('conversion-factor').value) || 1.0;
            const baseUnit = document.getElementById('ingredient-unit').value;
            const calculatedDisplay = document.getElementById('calculated-base-cost');
            const costInput = document.getElementById('ingredient-cost');
            const formulaDisplay = document.getElementById('calculation-formula');
            
            // Validation
            let errors = [];
            if (pricePerCase < 0) errors.push('Price per Case cannot be negative');
            if (caseSize < 0) errors.push('Case Size cannot be negative');
            if (conversionFactor < 0) errors.push('Conversion Factor cannot be negative');
            if (pricePerCase > 0 && caseSize === 0) errors.push('Case Size is required when Price per Case is entered');
            if (pricePerCase > 0 && conversionFactor === 0) errors.push('Conversion Factor cannot be zero');
            
            // Show errors if any
            const errorDisplay = document.getElementById('calculation-error');
            if (errorDisplay) {
                if (errors.length > 0) {
                    errorDisplay.innerHTML = '<div style="color: #C97676; font-size: 0.75rem; margin-top: 4px;">‚ö†Ô∏è ' + errors.join('<br>') + '</div>';
                    errorDisplay.style.display = 'block';
                    calculatedDisplay.textContent = '$0.00';
                    if (costInput) costInput.value = '';
                    return;
                } else {
                    errorDisplay.style.display = 'none';
                }
            }
            
            if (pricePerCase > 0 && caseSize > 0 && conversionFactor > 0) {
                // Formula: COST PER BASE UNIT = PRICE PER CASE / (CASE SIZE √ó CONVERSION FACTOR)
                const costPerBaseUnit = pricePerCase / (caseSize * conversionFactor);
                const denominator = caseSize * conversionFactor;
                
                if (costInput) costInput.value = costPerBaseUnit.toFixed(4);
                calculatedDisplay.textContent = '$' + costPerBaseUnit.toFixed(4) + ' / ' + baseUnit;
                calculatedDisplay.style.color = '#6B8E6F';
                
                // Show detailed calculation breakdown
                if (formulaDisplay) {
                    formulaDisplay.innerHTML = `
                        <div style="margin-top: 8px; padding: 8px; background: #FAFBFC; border-radius: 6px; font-size: 0.7rem; color: #64748b; line-height: 1.6;">
                            <strong>Calculation:</strong><br>
                            $${pricePerCase.toFixed(2)} √∑ (${caseSize} √ó ${conversionFactor}) = $${pricePerCase.toFixed(2)} √∑ ${denominator.toFixed(2)} = <strong style="color: #6B8E6F;">$${costPerBaseUnit.toFixed(4)}</strong>
                        </div>
                    `;
                }
            } else {
                if (costInput) costInput.value = '';
                calculatedDisplay.textContent = '$0.00';
                calculatedDisplay.style.color = '#8A9299';
                if (formulaDisplay) formulaDisplay.innerHTML = '';
            }
        }

        function addIngredient() {
            const formData = new FormData(document.getElementById('add-ingredient-form'));
            const ingredientName = document.getElementById('ingredient-name').value.trim();
            const category = document.getElementById('ingredient-category').value;
            const subcategory = document.getElementById('ingredient-subcategory').value.trim() || null;
            const unit = document.getElementById('ingredient-unit').value;
            const cost = parseFloat(document.getElementById('ingredient-cost').value) || 0;
            const supplier = document.getElementById('ingredient-supplier').value.trim();
            
            // Phase 1: Case pricing data
            const pricePerCase = parseFloat(document.getElementById('price-per-case').value) || 0;
            const caseSize = parseFloat(document.getElementById('case-size').value) || 0;
            const caseUnit = document.getElementById('case-unit').value;
            const conversionFactor = parseFloat(document.getElementById('conversion-factor').value) || 1.0;

            // Validate required fields
            if (!ingredientName || !category) {
                alert('Please fill in ingredient name and category');
                return;
            }
            
            // Validate case pricing if provided
            if (pricePerCase > 0 && (caseSize === 0 || conversionFactor === 0)) {
                alert('Please provide Case Size and Conversion Factor when entering Price per Case');
                return;
            }

            // Calculate cost from case pricing if provided
            let calculatedCost = cost;
            if (pricePerCase > 0 && caseSize > 0 && conversionFactor > 0) {
                calculatedCost = pricePerCase / (caseSize * conversionFactor);
            }

            // Create new custom ingredient (user-added product)
            const newIngredient = {
                name: ingredientName,
                category: category,
                subcategory: subcategory,
                unit: unit, // Base unit (for recipes)
                cost: calculatedCost, // Cost per base unit (calculated)
                supplier: supplier,
                dateAdded: new Date().toISOString(),
                priceHistory: calculatedCost > 0 ? [{
                    price: calculatedCost,
                    date: new Date().toISOString(),
                    vendor: supplier || 'Default'
                }] : [],
                // Phase 1: Case pricing data (Source of Truth)
                casePricing: pricePerCase > 0 ? {
                    pricePerCase: pricePerCase,
                    caseSize: caseSize,
                    caseUnit: caseUnit,
                    conversionFactor: conversionFactor,
                    lastUpdated: new Date().toISOString()
                } : null
            };

            // Use enhanced ingredients manager to add as custom ingredient
            const ingredientsManager = window.ingredientsManager;
            ingredientsManager.addCustomIngredient(newIngredient);

            // Refresh display
            loadIngredients();
            clearForm();
            
            console.log('‚úÖ Custom ingredient added:', ingredientName);
            alert(`‚úÖ Product "${ingredientName}" added to your products!`);
        }

        function clearForm() {
            document.getElementById('add-ingredient-form').reset();
            // Phase 1: Reset case pricing fields
            document.getElementById('price-per-case').value = '';
            document.getElementById('case-size').value = '';
            document.getElementById('case-unit').value = 'each';
            document.getElementById('conversion-factor').value = '1.0';
            document.getElementById('calculated-base-cost').textContent = '$0.00';
            document.getElementById('ingredient-cost').value = '';
        }

        function autoImportBaseIngredients() {
            console.log('üöÄ Auto-importing base ingredients...');
            
            if (window.baseIngredientsLoader) {
                // Check if base database exists
                window.baseIngredientsLoader.loadBaseDatabase().then(database => {
                    if (database && database.ingredients && database.ingredients.length > 0) {
                        console.log(`üì¶ Found ${database.ingredients.length} base ingredients, importing...`);
                        
                        // Import without confirmation
                        window.baseIngredientsLoader.importToLocalStorage(false).then(result => {
                            if (result.success) {
                                console.log(`‚úÖ Auto-imported ${result.total} ingredients!`);
                                loadIngredients(); // Reload display
                            }
                        });
                    } else {
                        console.log('‚ö†Ô∏è No base ingredients database found');
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è Base ingredients loader not available');
            }
        }

        function searchIngredients() {
            const query = document.getElementById('search-query').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            const subcategory = document.getElementById('filter-subcategory').value;
            const supplier = document.getElementById('filter-supplier').value;
            const sortBy = document.getElementById('sort-by').value;

            let ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');

            // Filter
            ingredients = ingredients.filter(ingredient => {
                const matchesQuery = !query || 
                    ingredient.name.toLowerCase().includes(query) ||
                    (ingredient.subcategory && ingredient.subcategory.toLowerCase().includes(query));
                const matchesCategory = !category || ingredient.category === category;
                const matchesSubcategory = !subcategory || ingredient.subcategory === subcategory;
                const matchesSupplier = !supplier || ingredient.supplier === supplier;
                return matchesQuery && matchesCategory && matchesSubcategory && matchesSupplier;
            });

            // Sort
            ingredients.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'category': return a.category.localeCompare(b.category);
                    case 'cost': return a.cost - b.cost;
                    case 'date-added': return new Date(b.dateAdded) - new Date(a.dateAdded);
                    default: return 0;
                }
            });

            displayIngredients(ingredients);
        }

        function resetFilters() {
            document.getElementById('search-query').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-subcategory').value = '';
            document.getElementById('filter-supplier').value = '';
            document.getElementById('sort-by').value = 'name';
            updateSubcategoryFilterOptions();
            searchIngredients();
        }

        // Organize ingredients with their variants grouped
        function organizeIngredientsWithVariants(ingredients) {
            const mainIngredients = [];
            const variants = [];
            
            // Separate main ingredients and variants
            ingredients.forEach(ing => {
                if (ing.isVariant || ing.parentIngredientId) {
                    variants.push(ing);
                } else {
                    mainIngredients.push(ing);
                }
            });
            
            // Sort main ingredients
            mainIngredients.sort((a, b) => a.name.localeCompare(b.name));
            
            // Group variants under their parents
            const organized = [];
            mainIngredients.forEach(main => {
                // Find variants for this ingredient
                const ingredientVariants = variants.filter(v => 
                    v.parentIngredientId === main.id || 
                    (v.baseName && v.baseName.toLowerCase() === main.name.toLowerCase())
                );
                
                // Attach variants to main ingredient
                main.variants = ingredientVariants;
                
                // Add main ingredient
                organized.push(main);
                
                // Add variants immediately after
                ingredientVariants.forEach(variant => {
                    organized.push({ ...variant, isVariant: true });
                });
            });
            
            // Add any orphaned variants
            variants.forEach(variant => {
                if (!variant.parentIngredientId && !variant.baseName) {
                    organized.push({ ...variant, isVariant: false });
                } else if (!mainIngredients.find(m => 
                    m.id === variant.parentIngredientId || 
                    (variant.baseName && variant.baseName.toLowerCase() === m.name.toLowerCase())
                )) {
                    organized.push({ ...variant, isVariant: false });
                }
            });
            
            return organized;
        }

        // Add new vendor variant/price to existing ingredient
        function addVariantPrice(parentIngredientId) {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            const parentIngredient = ingredients.find(ing => ing.id === parentIngredientId);
            
            if (!parentIngredient) {
                alert('Parent ingredient not found');
                return;
            }
            
            const supplier = prompt(`Enter vendor/supplier name for "${parentIngredient.name}":`);
            if (!supplier || !supplier.trim()) return;
            
            const priceInput = prompt(`Enter price for ${supplier}:`);
            const price = parseFloat(priceInput);
            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            // Check if variant already exists for this vendor
            const existingVariant = ingredients.find(ing => 
                (ing.parentIngredientId === parentIngredientId || ing.baseName?.toLowerCase() === parentIngredient.name.toLowerCase()) &&
                ing.supplier?.toLowerCase() === supplier.toLowerCase().trim() &&
                ing.isVariant
            );
            
            if (existingVariant) {
                // Add to price history instead of creating new variant
                if (!existingVariant.priceHistory) {
                    existingVariant.priceHistory = [];
                }
                
                // Only add if price changed
                const lastPrice = existingVariant.priceHistory[existingVariant.priceHistory.length - 1];
                if (!lastPrice || lastPrice.price !== price) {
                    existingVariant.priceHistory.push({
                        price: price,
                        date: new Date().toISOString(),
                        vendor: supplier.trim()
                    });
                    existingVariant.cost = price;
                    existingVariant.lastPriceUpdate = new Date().toISOString();
                    
                    localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
                    localStorage.setItem('ingredients', JSON.stringify(ingredients));
                    
                    loadIngredients();
                    alert(`‚úÖ Price updated for ${supplier}. Total price history: ${existingVariant.priceHistory.length} entries.`);
                } else {
                    alert('Price is the same as the last entry.');
                }
            } else {
                // Create new variant
                const variant = {
                    id: 'ing_variant_' + Date.now(),
                    parentIngredientId: parentIngredientId,
                    isVariant: true,
                    name: `${parentIngredient.name} - ${supplier.trim()}`,
                    baseName: parentIngredient.name,
                    category: parentIngredient.category,
                    subcategory: parentIngredient.subcategory,
                    unit: parentIngredient.unit,
                    cost: price,
                    supplier: supplier.trim(),
                    dateAdded: new Date().toISOString(),
                    priceHistory: [{
                        price: price,
                        date: new Date().toISOString(),
                        vendor: supplier.trim()
                    }]
                };
                
                ingredients.push(variant);
                localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
                localStorage.setItem('ingredients', JSON.stringify(ingredients));
                
                loadIngredients();
                alert(`‚úÖ New vendor variant added: ${supplier} at $${price.toFixed(2)}`);
            }
        }

        // View price history for a variant
        function viewPriceHistory(variantId) {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            const variant = ingredients.find(ing => ing.id === variantId);
            
            if (!variant || !variant.priceHistory || variant.priceHistory.length === 0) {
                alert('No price history available for this variant.');
                return;
            }
            
            const historyText = variant.priceHistory
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map((entry, idx) => 
                    `${idx + 1}. $${entry.price.toFixed(2)} on ${new Date(entry.date).toLocaleDateString()}${entry.vendor ? ` (${entry.vendor})` : ''}`
                ).join('\n');
            
            alert(`Price History for ${variant.supplier || variant.name}:\n\n${historyText}`);
        }

        // Edit variant
        function editVariant(variantId) {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            const variant = ingredients.find(ing => ing.id === variantId);
            
            if (!variant) {
                alert('Variant not found');
                return;
            }
            
            const newPrice = prompt(`Current price: $${(variant.cost || 0).toFixed(2)}\n\nEnter new price:`, variant.cost || 0);
            if (newPrice === null) return;
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            // Add to price history if price changed
            if (!variant.priceHistory) {
                variant.priceHistory = [];
            }
            
            const lastPrice = variant.priceHistory[variant.priceHistory.length - 1];
            if (!lastPrice || lastPrice.price !== price) {
                variant.priceHistory.push({
                    price: price,
                    date: new Date().toISOString(),
                    vendor: variant.supplier || 'Default'
                });
            }
            
            variant.cost = price;
            variant.lastPriceUpdate = new Date().toISOString();
            
            localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
            localStorage.setItem('ingredients', JSON.stringify(ingredients));
            
            loadIngredients();
            alert(`‚úÖ Price updated. Total price history: ${variant.priceHistory.length} entries.`);
        }

        // Update subcategory options based on selected category
        function updateSubcategoryOptions() {
            const category = document.getElementById('ingredient-category').value;
            const subcategoryInput = document.getElementById('ingredient-subcategory');
            const datalist = document.getElementById('subcategory-suggestions');
            
            // Clear existing options
            datalist.innerHTML = '';
            
            // Common subcategories by category
            const subcategoriesByCategory = {
                'vegetables': ['Organic', 'Baby', 'Heirloom', 'Fresh', 'Frozen', 'Canned'],
                'fruits': ['Organic', 'Fresh', 'Frozen', 'Dried', 'Premium', 'Local'],
                'proteins': ['Organic', 'Grass-Fed', 'Free-Range', 'Premium', 'Wild-Caught', 'Halal', 'Kosher'],
                'dairy': ['Organic', 'Whole Milk', '2%', 'Skim', 'Raw', 'Pasteurized', 'Lactose-Free'],
                'oils': ['Extra Virgin', 'Cold-Pressed', 'Organic', 'Refined', 'Unrefined'],
                'spices': ['Whole', 'Ground', 'Organic', 'Premium', 'Smoked'],
                'grains': ['Organic', 'Whole Grain', 'Refined', 'Gluten-Free', 'Ancient Grain'],
                'other': ['Organic', 'Premium', 'Artisanal', 'Local', 'Imported']
            };
            
            const suggestions = subcategoriesByCategory[category] || [];
            suggestions.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                datalist.appendChild(option);
            });
        }

        // Update subcategory filter options based on selected category
        function updateSubcategoryFilterOptions() {
            const category = document.getElementById('filter-category').value;
            const subcategoryFilter = document.getElementById('filter-subcategory');
            
            // Clear existing options
            subcategoryFilter.innerHTML = '<option value="">All Subcategories</option>';
            
            if (!category) {
                return; // Show all if no category selected
            }
            
            // Get all ingredients
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            
            // Get unique subcategories for selected category
            const subcategories = new Set();
            ingredients.forEach(ing => {
                if (ing.category === category && ing.subcategory) {
                    subcategories.add(ing.subcategory);
                }
            });
            
            // Sort and add options
            Array.from(subcategories).sort().forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subcategoryFilter.appendChild(option);
            });
        }

        async function previewURLImport() {
            const url = document.getElementById('ingredient-url').value.trim();
            if (!url) {
                alert('Please enter a URL to import from');
                return;
            }

            const previewDiv = document.getElementById('ingredient-import-preview');
            if (!previewDiv) {
                console.error('Preview div not found');
                return;
            }

            previewDiv.style.display = 'block';
            previewDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                    <div>Fetching ingredient data from ${url}...</div>
                </div>
            `;

            try {
                if (!window.fetchIngredientMetadata) {
                    throw new Error('Ingredient scraper not loaded. Please refresh the page.');
                }

                const metadata = await window.fetchIngredientMetadata(url);
                
                if (!metadata || !metadata.name) {
                    throw new Error('Could not extract ingredient information from this URL');
                }

                // Display preview
                const nutritionHTML = metadata.nutritional_info && Object.keys(metadata.nutritional_info).length > 0
                    ? `
                        <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">üìä Nutritional Info (per 100g)</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; font-size: 0.85rem;">
                                ${metadata.nutritional_info.calories ? `<div><strong>${metadata.nutritional_info.calories}</strong> cal</div>` : ''}
                                ${metadata.nutritional_info.protein ? `<div><strong>${metadata.nutritional_info.protein}g</strong> protein</div>` : ''}
                                ${metadata.nutritional_info.fat ? `<div><strong>${metadata.nutritional_info.fat}g</strong> fat</div>` : ''}
                                ${metadata.nutritional_info.carbohydrates ? `<div><strong>${metadata.nutritional_info.carbohydrates}g</strong> carbs</div>` : ''}
                            </div>
                        </div>
                    `
                    : '';

                previewDiv.innerHTML = `
                    <div style="padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 32px;">‚úÖ</span>
                            <div>
                                <div style="font-weight: 700; font-size: 1.1rem; color: #1e293b;">${metadata.name}</div>
                                <div style="font-size: 0.85rem; color: #64748b;">From ${metadata.source_host || new URL(url).hostname}</div>
                            </div>
                        </div>
                        ${metadata.description ? `<div style="color: #475569; font-size: 0.9rem; margin-bottom: 12px; line-height: 1.5;">${metadata.description}</div>` : ''}
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                            <span style="padding: 4px 10px; background: #e0e7ff; color: #3730a3; border-radius: 999px; font-size: 0.8rem; font-weight: 600;">${metadata.category || 'other'}</span>
                            <span style="padding: 4px 10px; background: #dbeafe; color: #1e40af; border-radius: 999px; font-size: 0.8rem;">Unit: ${metadata.unit || 'g'}</span>
                            ${metadata.allergens && metadata.allergens.length > 0 ? `<span style="padding: 4px 10px; background: #fee2e2; color: #991b1b; border-radius: 999px; font-size: 0.8rem;">‚ö†Ô∏è Allergens: ${metadata.allergens.join(', ')}</span>` : ''}
                        </div>
                        ${nutritionHTML}
                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <button onclick="importFromURLPreview()" class="btn btn-primary" style="flex: 1;">‚ûï Import This Ingredient</button>
                            <button onclick="document.getElementById('ingredient-import-preview').style.display='none'" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                `;

                // Store metadata for import
                window.lastScrapedIngredient = metadata;
            } catch (error) {
                console.error('‚ùå Error previewing URL:', error);
                previewDiv.innerHTML = `
                    <div style="padding: 16px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-weight: 600; color: #dc2626; margin-bottom: 8px;">Failed to fetch ingredient</div>
                        <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 12px;">${error.message}</div>
                        <button onclick="document.getElementById('ingredient-import-preview').style.display='none'" class="btn btn-secondary">Close</button>
                    </div>
                `;
            }
        }

        function importFromURLPreview() {
            if (!window.lastScrapedIngredient) {
                alert('No ingredient data to import. Please preview first.');
                return;
            }

            const metadata = window.lastScrapedIngredient;
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients') || '[]');

            // Check for duplicates
            const duplicate = ingredients.find(i => i.name.toLowerCase() === metadata.name.toLowerCase());
            if (duplicate) {
                if (!confirm(`Ingredient "${metadata.name}" already exists. Do you want to update it?`)) {
                    return;
                }
                // Update existing
                Object.assign(duplicate, {
                    ...metadata,
                    id: duplicate.id,
                    updatedAt: new Date().toISOString()
                });
            } else {
                // Add new
                const newIngredient = {
                    id: `ing_url_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`,
                    ...metadata,
                    dateAdded: new Date().toISOString(),
                    createdVia: 'url-import'
                };
                ingredients.push(newIngredient);
            }

            localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
            localStorage.setItem('ingredients', JSON.stringify(ingredients));

            alert(`‚úÖ Ingredient "${metadata.name}" ${duplicate ? 'updated' : 'imported'} successfully!`);
            
            // Clear preview and form
            document.getElementById('ingredient-import-preview').style.display = 'none';
            document.getElementById('ingredient-url').value = '';
            window.lastScrapedIngredient = null;

            // Refresh ingredient list
            if (typeof searchIngredients === 'function') {
                searchIngredients();
            } else {
                window.location.reload();
            }
        }

        function viewIngredient(id) {
            console.log('üëÅÔ∏è Viewing ingredient:', id);
            
            // Get ingredient
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients') || '[]');
            const ingredient = ingredients.find(i => i.id === id);
            
            if (!ingredient) {
                alert('Ingredient not found');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                padding: 20px;
                backdrop-filter: blur(5px);
            `;
            
            // Build nutritional info
            const nutritionHTML = ingredient.nutritional_info ? `
                <div style="padding: 25px; background: #f8fafc; border-bottom: 2px solid #f1f5f9;">
                    <h3 style="font-size: 1.2rem; font-weight: 700; color: #1e293b; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                        <span>üìä</span> Nutritional Information (per 100g)
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        ${ingredient.nutritional_info.calories ? `
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 12px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #5a67d8;">${ingredient.nutritional_info.calories}</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600;">Calories</div>
                            </div>
                        ` : ''}
                        ${ingredient.nutritional_info.protein ? `
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 12px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${ingredient.nutritional_info.protein}g</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600;">Protein</div>
                            </div>
                        ` : ''}
                        ${ingredient.nutritional_info.fat ? `
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 12px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${ingredient.nutritional_info.fat}g</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600;">Fat</div>
                            </div>
                        ` : ''}
                        ${ingredient.nutritional_info.carbohydrates ? `
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 12px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${ingredient.nutritional_info.carbohydrates}g</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600;">Carbs</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : '';
            
            // Build vendor info
            const vendorHTML = ingredient.preferred_vendor || ingredient.vendor_info ? `
                <div style="padding: 25px; background: white; border-bottom: 2px solid #f1f5f9;">
                    <h3 style="font-size: 1.2rem; font-weight: 700; color: #1e293b; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        <span>üè™</span> Vendor Information
                    </h3>
                    <div style="padding: 15px; background: #dbeafe; border-radius: 12px;">
                        <div style="font-weight: 700; color: #1e40af; margin-bottom: 8px;">${ingredient.preferred_vendor || 'No vendor specified'}</div>
                        ${ingredient.vendor_info ? `<div style="color: #1e40af; font-size: 0.9rem;">${ingredient.vendor_info}</div>` : ''}
                    </div>
                </div>
            ` : '';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 30px 90px rgba(0,0,0,0.5);">
                    
                    <!-- Header -->
                    <div style="padding: 30px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 1.5rem; cursor: pointer; color: white;">
                            ‚úï
                        </button>
                        <h2 style="font-size: 2rem; font-weight: 700; margin: 0 0 12px 0;">ü•¨ ${ingredient.name}</h2>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <span style="background: rgba(255,255,255,0.25); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                                ${ingredient.category}
                            </span>
                            ${ingredient.avg_price_per_lb ? `
                                <span style="background: rgba(255,255,255,0.25); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                                    $${ingredient.avg_price_per_lb}/lb
                                </span>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Content -->
                    <div style="overflow-y: auto; flex: 1;">
                        
                        <!-- Basic Info -->
                        <div style="padding: 25px; background: white; border-bottom: 2px solid #f1f5f9;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                ${ingredient.unit || ingredient.default_unit ? `
                                    <div>
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Base Unit</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #0f172a;">${ingredient.unit || ingredient.default_unit}</div>
                                    </div>
                                ` : ''}
                                ${ingredient.cost ? `
                                    <div>
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Cost per Base Unit</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #6B8E6F;">$${ingredient.cost.toFixed(4)}</div>
                                    </div>
                                ` : ''}
                                ${ingredient.storage ? `
                                    <div>
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Storage</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #0f172a;">${ingredient.storage}</div>
                                    </div>
                                ` : ''}
                                ${ingredient.shelf_life_days ? `
                                    <div>
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Shelf Life</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #0f172a;">${ingredient.shelf_life_days} days</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Phase 1: Case Pricing Info -->
                        ${ingredient.casePricing ? `
                            <div style="padding: 25px; background: #F5F7F9; border-bottom: 2px solid #E5E9EC;">
                                <h3 style="font-size: 1.2rem; font-weight: 700; color: #1F2D35; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                    <span>üì¶</span> Phase 1: Vendor Case Pricing (Source of Truth)
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                                    <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #E5E9EC;">
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Price per Case</div>
                                        <div style="font-size: 1.3rem; font-weight: 700; color: #1F2D35;">$${ingredient.casePricing.pricePerCase.toFixed(2)}</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #E5E9EC;">
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Case Size</div>
                                        <div style="font-size: 1.3rem; font-weight: 700; color: #1F2D35;">${ingredient.casePricing.caseSize}</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #E5E9EC;">
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Case Unit</div>
                                        <div style="font-size: 1.3rem; font-weight: 700; color: #1F2D35;">${ingredient.casePricing.caseUnit}</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #E5E9EC;">
                                        <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Conversion Factor</div>
                                        <div style="font-size: 1.3rem; font-weight: 700; color: #1F2D35;">${ingredient.casePricing.conversionFactor}</div>
                                    </div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 12px; margin-top: 15px; border: 2px solid #6B8E6F;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #3E4C54; font-weight: 700; font-size: 1rem;">Calculated Cost per Base Unit:</span>
                                        <span style="color: #6B8E6F; font-weight: 700; font-size: 1.5rem;">$${ingredient.cost.toFixed(4)} / ${ingredient.unit || 'unit'}</span>
                                    </div>
                                    <small style="color: #8A9299; font-size: 0.7rem; display: block; margin-top: 6px;">
                                        Formula: $${ingredient.casePricing.pricePerCase.toFixed(2)} √∑ (${ingredient.casePricing.caseSize} √ó ${ingredient.casePricing.conversionFactor}) = $${ingredient.cost.toFixed(4)}
                                    </small>
                                    ${ingredient.casePricing.lastUpdated ? `
                                        <small style="color: #8A9299; font-size: 0.7rem; display: block; margin-top: 4px;">
                                            Last updated: ${new Date(ingredient.casePricing.lastUpdated).toLocaleDateString()}
                                        </small>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Nutritional Info -->
                        ${nutritionHTML}

                        <!-- Vendor -->
                        ${vendorHTML}

                        <!-- Allergens & Dietary -->
                        ${ingredient.allergens && ingredient.allergens.length > 0 ? `
                            <div style="padding: 20px 25px; background: #fef3c7; border-bottom: 2px solid #fbbf24;">
                                <h3 style="font-size: 1.1rem; font-weight: 700; color: #92400e; margin: 0 0 15px 0;">‚ö†Ô∏è Allergens</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${ingredient.allergens.map(a => `
                                        <span style="background: #fee2e2; color: #991b1b; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${a}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${ingredient.dietary && ingredient.dietary.length > 0 ? `
                            <div style="padding: 20px 25px; background: #dcfce7; border-bottom: 2px solid #10b981;">
                                <h3 style="font-size: 1.1rem; font-weight: 700; color: #15803d; margin: 0 0 15px 0;">üå± Dietary</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${ingredient.dietary.map(d => `
                                        <span style="background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${d}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Substitutes -->
                        ${ingredient.substitutes && ingredient.substitutes.length > 0 ? `
                            <div style="padding: 25px; background: #f8fafc;">
                                <h3 style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0 0 15px 0;">üîÑ Substitutes</h3>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${ingredient.substitutes.map(s => `
                                        <span style="background: #e0e7ff; color: #3730a3; padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${s}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                    </div>

                    <!-- Footer -->
                    <div style="padding: 20px 25px; background: white; border-top: 2px solid #e5e7eb; display: flex; gap: 12px;">
                        <button onclick="editIngredient('${ingredient.id}'); this.closest('div[style*=fixed]').remove();" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 14px 28px; background: #f1f5f9; color: #64748b; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        function editIngredient(id) {
            console.log('‚úèÔ∏è Editing ingredient:', id);
            
            // Get ingredient
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients') || '[]');
            const ingredient = ingredients.find(i => i.id === id);
            const index = ingredients.findIndex(i => i.id === id);
            
            if (!ingredient) {
                alert('Ingredient not found');
                return;
            }
            
            // Close any open modals
            document.querySelectorAll('div[style*="position: fixed"]').forEach(el => el.remove());
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                padding: 20px;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 30px 90px rgba(0,0,0,0.5);">
                    
                    <!-- Header -->
                    <div style="padding: 25px; background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); color: white;">
                        <h2 style="font-size: 1.8rem; font-weight: 700; margin: 0;">‚úèÔ∏è Edit Ingredient</h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9;">${ingredient.name}</p>
                    </div>

                    <!-- Form -->
                    <div style="overflow-y: auto; flex: 1; padding: 25px;">
                        
                        <!-- Name -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Ingredient Name</label>
                            <input type="text" id="edit-ing-name" value="${ingredient.name}" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; color: #0f172a; font-weight: 600;">
                        </div>

                        <!-- Category & Unit -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Category</label>
                                <input type="text" id="edit-ing-category" value="${ingredient.category}" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Default Unit</label>
                                <select id="edit-ing-unit" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                    <option value="lb" ${ingredient.default_unit === 'lb' ? 'selected' : ''}>lb</option>
                                    <option value="kg" ${ingredient.default_unit === 'kg' ? 'selected' : ''}>kg</option>
                                    <option value="oz" ${ingredient.default_unit === 'oz' ? 'selected' : ''}>oz</option>
                                    <option value="g" ${ingredient.default_unit === 'g' ? 'selected' : ''}>g</option>
                                    <option value="ea" ${ingredient.default_unit === 'ea' ? 'selected' : ''}>each</option>
                                    <option value="gal" ${ingredient.default_unit === 'gal' ? 'selected' : ''}>gal</option>
                                    <option value="qt" ${ingredient.default_unit === 'qt' ? 'selected' : ''}>qt</option>
                                </select>
                            </div>
                        </div>

                        <!-- Price & Storage -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Price per lb</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2rem; font-weight: 700;">$</span>
                                    <input type="number" id="edit-ing-price" value="${ingredient.avg_price_per_lb || ''}" step="0.01" min="0" style="flex: 1; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Storage</label>
                                <select id="edit-ing-storage" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                    <option value="refrigerated" ${ingredient.storage === 'refrigerated' ? 'selected' : ''}>Refrigerated</option>
                                    <option value="frozen" ${ingredient.storage === 'frozen' ? 'selected' : ''}>Frozen</option>
                                    <option value="dry" ${ingredient.storage === 'dry' ? 'selected' : ''}>Dry/Pantry</option>
                                    <option value="room_temp" ${ingredient.storage === 'room_temp' ? 'selected' : ''}>Room Temp</option>
                                </select>
                            </div>
                        </div>

                        <!-- Shelf Life & Vendor -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Shelf Life (days)</label>
                                <input type="number" id="edit-ing-shelf-life" value="${ingredient.shelf_life_days || ''}" min="1" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Preferred Vendor</label>
                                <input type="text" id="edit-ing-vendor" value="${ingredient.supplier || ingredient.preferred_vendor || ''}" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                            </div>
                        </div>
                        
                        <!-- Phase 1: Case Pricing Section -->
                        <div style="background: #F5F7F9; border: 2px solid #5B9BAD; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="color: #1F2D35; font-size: 1rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <span>üì¶</span> Phase 1: Vendor Case Pricing (Source of Truth)
                            </h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Price per Case ($)</label>
                                    <input type="number" id="edit-price-per-case" value="${ingredient.casePricing?.pricePerCase || ''}" step="0.01" min="0" onchange="calculateEditBaseUnitCost()" oninput="calculateEditBaseUnitCost()" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Case Size</label>
                                    <input type="number" id="edit-case-size" value="${ingredient.casePricing?.caseSize || ''}" step="0.01" min="0" onchange="calculateEditBaseUnitCost()" oninput="calculateEditBaseUnitCost()" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Case Unit</label>
                                    <select id="edit-case-unit" onchange="calculateEditBaseUnitCost()" oninput="calculateEditBaseUnitCost()" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                        <option value="each" ${ingredient.casePricing?.caseUnit === 'each' ? 'selected' : ''}>Each (pieces)</option>
                                        <option value="lb" ${ingredient.casePricing?.caseUnit === 'lb' ? 'selected' : ''}>Pounds (lb)</option>
                                        <option value="oz" ${ingredient.casePricing?.caseUnit === 'oz' ? 'selected' : ''}>Ounces (oz)</option>
                                        <option value="g" ${ingredient.casePricing?.caseUnit === 'g' ? 'selected' : ''}>Grams (g)</option>
                                        <option value="kg" ${ingredient.casePricing?.caseUnit === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                                        <option value="gal" ${ingredient.casePricing?.caseUnit === 'gal' ? 'selected' : ''}>Gallons (gal)</option>
                                        <option value="qt" ${ingredient.casePricing?.caseUnit === 'qt' ? 'selected' : ''}>Quarts (qt)</option>
                                        <option value="l" ${ingredient.casePricing?.caseUnit === 'l' ? 'selected' : ''}>Liters (l)</option>
                                        <option value="ml" ${ingredient.casePricing?.caseUnit === 'ml' ? 'selected' : ''}>Milliliters (ml)</option>
                                        <option value="case" ${ingredient.casePricing?.caseUnit === 'case' ? 'selected' : ''}>Case</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: #0f172a; margin-bottom: 8px;">Conversion Factor</label>
                                    <input type="number" id="edit-conversion-factor" value="${ingredient.casePricing?.conversionFactor || '1.0'}" step="0.01" min="0" onchange="calculateEditBaseUnitCost()" oninput="calculateEditBaseUnitCost()" style="width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem;">
                                    <small style="color: #64748b; font-size: 0.7rem; display: block; margin-top: 4px;">
                                        Example: If case is in lbs and base unit is grams, use 453.592
                                    </small>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #E5E9EC;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #3E4C54; font-weight: 600; font-size: 0.875rem;">Cost per Base Unit:</span>
                                    <span id="edit-calculated-base-cost" style="color: #6B8E6F; font-weight: 700; font-size: 1.1rem;">$${(ingredient.cost || 0).toFixed(4)}</span>
                                </div>
                                <small style="color: #8A9299; font-size: 0.7rem; display: block; margin-top: 4px;">Formula: (Price per Case) √∑ (Case Size √ó Conversion Factor)</small>
                                <div id="edit-calculation-formula"></div>
                            </div>
                        </div>

                    </div>

                    <!-- Footer -->
                    <div style="padding: 20px 25px; background: white; border-top: 2px solid #e5e7eb; display: flex; gap: 12px;">
                        <button onclick="saveIngredientEdit(${index})" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                            üíæ Save Changes
                        </button>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 14px 28px; background: #f1f5f9; color: #64748b; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        // Phase 1: Calculate cost for edit modal
        function calculateEditBaseUnitCost() {
            const pricePerCase = parseFloat(document.getElementById('edit-price-per-case').value) || 0;
            const caseSize = parseFloat(document.getElementById('edit-case-size').value) || 0;
            const conversionFactor = parseFloat(document.getElementById('edit-conversion-factor').value) || 1.0;
            const baseUnit = document.getElementById('edit-ing-unit').value;
            
            if (pricePerCase > 0 && caseSize > 0 && conversionFactor > 0) {
                const costPerBaseUnit = pricePerCase / (caseSize * conversionFactor);
                document.getElementById('edit-calculated-base-cost').textContent = '$' + costPerBaseUnit.toFixed(4) + ' / ' + baseUnit;
            } else {
                const currentCost = document.getElementById('edit-calculated-base-cost').textContent.match(/\$([\d.]+)/);
                if (currentCost) {
                    document.getElementById('edit-calculated-base-cost').textContent = '$' + currentCost[1];
                } else {
                    document.getElementById('edit-calculated-base-cost').textContent = '$0.00';
                }
            }
        }

        function saveIngredientEdit(index) {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || localStorage.getItem('ingredients') || '[]');
            
            if (!ingredients[index]) {
                alert('Ingredient not found');
                return;
            }

            // Get form values
            const name = document.getElementById('edit-ing-name').value.trim();
            const category = document.getElementById('edit-ing-category').value.trim();
            const unit = document.getElementById('edit-ing-unit').value;
            const price = parseFloat(document.getElementById('edit-ing-price').value) || 0;
            const storage = document.getElementById('edit-ing-storage').value;
            const shelfLife = parseInt(document.getElementById('edit-ing-shelf-life').value) || null;
            const vendor = document.getElementById('edit-ing-vendor').value.trim();
            
            // Phase 1: Get case pricing values
            const pricePerCase = parseFloat(document.getElementById('edit-price-per-case').value) || 0;
            const caseSize = parseFloat(document.getElementById('edit-case-size').value) || 0;
            const caseUnit = document.getElementById('edit-case-unit').value;
            const conversionFactor = parseFloat(document.getElementById('edit-conversion-factor').value) || 1.0;
            
            // Phase 1: Calculate cost per base unit if case pricing provided
            let cost = ingredients[index].cost || 0;
            if (pricePerCase > 0 && caseSize > 0 && conversionFactor > 0) {
                cost = pricePerCase / (caseSize * conversionFactor);
            } else if (price > 0) {
                // Fallback to price per lb if no case pricing
                cost = price;
            }

            if (!name) {
                alert('Please enter an ingredient name');
                return;
            }

            // Update ingredient
            const updatedIngredient = {
                ...ingredients[index],
                name,
                category,
                unit: unit, // Base unit
                default_unit: unit, // Legacy support
                cost: cost, // Phase 1: Calculated cost per base unit
                avg_price_per_lb: price, // Legacy support
                storage,
                shelf_life_days: shelfLife,
                supplier: vendor,
                preferred_vendor: vendor // Legacy support
            };
            
            // Phase 1: Update case pricing (Source of Truth)
            if (pricePerCase > 0 && caseSize > 0 && conversionFactor > 0) {
                updatedIngredient.casePricing = {
                    pricePerCase: pricePerCase,
                    caseSize: caseSize,
                    caseUnit: caseUnit,
                    conversionFactor: conversionFactor,
                    lastUpdated: new Date().toISOString()
                };
            } else if (ingredients[index].casePricing) {
                // Keep existing case pricing if not updated
                updatedIngredient.casePricing = ingredients[index].casePricing;
            }
            
            ingredients[index] = updatedIngredient;
                avg_price_per_lb: price,
                storage,
                shelf_life_days: shelfLife,
                preferred_vendor: vendor,
                lastModified: new Date().toISOString()
            };

            // Save to both keys
            localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
            localStorage.setItem('ingredients', JSON.stringify(ingredients));

            // Close modal
            document.querySelectorAll('div[style*="position: fixed"]').forEach(el => el.remove());

            // Refresh display
            displayIngredients(ingredients);
            updateStats(ingredients);

            showToast('‚úÖ Ingredient updated!');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #10b981;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 999999;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 2000);
        }

        function deleteIngredient(id) {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            const ingredient = ingredients.find(i => i.id === id);
            
            // Check if it's a built-in ingredient
            if (ingredient && /^ing_\d+$/.test(ingredient.id)) {
                alert('‚ö†Ô∏è Cannot delete built-in ingredients. You can only delete your custom products.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this ingredient?')) {
                // Use enhanced manager for custom ingredients
                if (window.ingredientsManager) {
                    window.ingredientsManager.deleteCustomIngredient(id);
                } else {
                    const filtered = ingredients.filter(i => i.id !== id);
                    localStorage.setItem('ingredients_database', JSON.stringify(filtered));
                    localStorage.setItem('ingredients', JSON.stringify(filtered));
                }
                
                loadIngredients();
                console.log('üóëÔ∏è Ingredient deleted:', id);
            }
        }

        function manageVendorPrices(ingredientId) {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            const ingredient = ingredients.find(i => i.id === ingredientId);
            
            if (!ingredient) {
                alert('Ingredient not found');
                return;
            }

            const baseUnit = ingredient.unit || ingredient.default_unit || 'g';
            const vendorPrices = ingredient.vendorPrices || [];

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 32px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">üí∞ Vendor Prices: ${ingredient.name}</h2>
                    <p style="color: #64748b; margin-bottom: 24px;">Base Unit: <strong>${baseUnit}</strong></p>

                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">Add New Vendor Price</h3>
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <input type="text" id="new-vendor-name" placeholder="Vendor Name" style="padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px;">
                            <input type="number" id="new-vendor-price" placeholder="Price" step="0.01" style="padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px;">
                            <select id="new-vendor-unit" style="padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px;">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="oz">oz</option>
                                <option value="lb">lb</option>
                                <option value="ml">ml</option>
                                <option value="l">L</option>
                                <option value="fl oz">fl oz</option>
                                <option value="cup">cup</option>
                                <option value="piece">piece</option>
                            </select>
                            <button onclick="addVendorPriceToIngredient('${ingredientId}')" style="padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Add</button>
                        </div>
                    </div>

                    <div id="vendor-prices-list">
                        ${vendorPrices.length === 0 ? '<p style="color: #64748b; text-align: center; padding: 40px;">No vendor prices added yet</p>' : ''}
                        ${vendorPrices.map((vp, idx) => {
                            const normalized = window.unitConverter?.convertPrice(vp.price, vp.unit, baseUnit) || vp.price;
                            return `
                                <div style="padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #10b981;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;">${vp.vendor}</div>
                                            <div style="color: #64748b; font-size: 0.9rem;">
                                                $${vp.price.toFixed(2)} / ${vp.unit}
                                                ${vp.unit !== baseUnit ? ` = $${normalized.toFixed(4)} / ${baseUnit}` : ''}
                                            </div>
                                            ${vp.dateAdded ? `<div style="color: #8A9299; font-size: 0.75rem; margin-top: 4px;">Added: ${new Date(vp.dateAdded).toLocaleDateString()}</div>` : ''}
                                        </div>
                                        <button onclick="removeVendorPrice('${ingredientId}', ${idx})" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">Remove</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    ${ingredient.bestPrice ? `
                        <div style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 8px;">
                            <div style="font-weight: 700; margin-bottom: 8px;">üèÜ Best Price</div>
                            <div>${ingredient.bestPrice.vendor}: $${ingredient.bestPrice.price.toFixed(2)}/${ingredient.bestPrice.unit} = $${ingredient.bestPrice.normalizedPrice.toFixed(4)}/${baseUnit}</div>
                        </div>
                    ` : ''}

                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="flex: 1; padding: 14px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Close</button>
                    </div>
                </div>
            `;

            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            document.body.appendChild(modal);
        }

        function addVendorPriceToIngredient(ingredientId) {
            const vendor = document.getElementById('new-vendor-name').value.trim();
            const price = parseFloat(document.getElementById('new-vendor-price').value);
            const unit = document.getElementById('new-vendor-unit').value;

            if (!vendor || !price || price <= 0) {
                alert('Please enter vendor name and valid price');
                return;
            }

            window.vendorPriceComparator.addVendorPrice(ingredientId, {
                vendor,
                price,
                unit
            });

            // Refresh modal
            manageVendorPrices(ingredientId);
        }

        function removeVendorPrice(ingredientId, index) {
            const ingredients = JSON.parse(localStorage.getItem('ingredients_database') || '[]');
            const ingredient = ingredients.find(i => i.id === ingredientId);
            
            if (ingredient && ingredient.vendorPrices) {
                ingredient.vendorPrices.splice(index, 1);
                window.vendorPriceComparator.updateBestPrice(ingredient);
                
                localStorage.setItem('ingredients_database', JSON.stringify(ingredients));
                localStorage.setItem('ingredients', JSON.stringify(ingredients));
                
                // Refresh modal
                manageVendorPrices(ingredientId);
            }
        }

        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab) {
                dropdown.classList.toggle('active');
                userTab.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab && !userTab.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
                userTab.classList.remove('active');
            }
        });

        // Toggle mobile navigation
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobile-nav');
            if (mobileNav) {
                mobileNav.classList.toggle('active');
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobile-nav');
            const mobileToggle = document.querySelector('.header-mobile-toggle');
            
            if (mobileNav && mobileToggle && !mobileToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });
    </script>

    <!-- Initialize Unified Authentication System -->
    <script>
      // Initialize authentication system when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM loaded, initializing authentication system...');
        
        // Wait a moment for all scripts to load
        setTimeout(() => {
          if (typeof UnifiedAuthSystem !== 'undefined') {
            console.log('‚úÖ UnifiedAuthSystem class found, creating instance...');
            window.unifiedAuthSystem = new UnifiedAuthSystem();
            window.unifiedAuth = window.unifiedAuthSystem; // Alias for onclick handlers
            console.log('‚úÖ Authentication system initialized');
          } else {
            console.error('‚ùå UnifiedAuthSystem class not found');
          }
          
          // Initialize page protection if available
          if (typeof PageProtection !== 'undefined') {
            console.log('‚úÖ PageProtection class found, creating instance...');
            window.pageProtection = new PageProtection();
            console.log('‚úÖ Page protection system initialized');
          } else {
            console.warn('‚ö†Ô∏è PageProtection class not found');
          }
        }, 100);
      });
    </script>
    
    <!-- Load Firebase Modules -->
    <script type="module" src="assets/js/firebase-auth.js"></script>
    <script type="module" src="assets/js/firebase-auth-ui.js"></script>
    <script type="module" src="assets/js/firestore-sync.js"></script>
    
    <!-- Load User Display -->
    <script src="assets/js/header-user-display.js"></script>
    
    <!-- Load Profile Editor -->
    <script src="assets/js/profile-editor.js"></script>
    
    <!-- Load Email Verification Banner -->
    <script src="assets/js/email-verification-banner.js"></script>
    
    <!-- Load Base Ingredients Loader -->
    <script src="assets/js/base-ingredients-loader.js"></script>
    <script src="assets/js/ingredient-url-scraper.js"></script>
    
    <!-- Load Vendor-Ingredient Connector -->
    <script src="assets/js/vendor-ingredient-connector.js"></script>
    
    <!-- Project UI Manager -->
    <script defer src="assets/js/project-ui-manager.js"></script>
    
    <!-- Central Data Loader -->
    <script src="assets/js/central-data-loader.js"></script>
    
    <!-- State Persistence Manager - Ensures user and project persist across pages -->
    <script src="assets/js/state-persistence-manager.js"></script>
    
    <!-- Secure Storage Manager - Fast & Secure IndexedDB storage -->
    <script src="assets/js/secure-storage-manager.js"></script>
    
    <!-- UI Polish Systems -->
    <script src="assets/js/toast-notifications.js"></script>
    <script src="assets/js/loading-states.js"></script>
    <script src="assets/js/empty-states.js"></script>
</body>
</html>