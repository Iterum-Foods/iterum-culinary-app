<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Developer - Iterum R&D Chef Notebook</title>
    
    <!-- Auth System (v2.0) -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/auth-api-helper.js"></script>
    <script src="assets/js/auth-diagnostics.js"></script>
    <script src="assets/js/auth_guard.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shadows+Into+Light:wght@400&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- UNIFIED COLOR SYSTEM - MUST LOAD FIRST -->
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/modal-high-contrast.css">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="stylesheet" href="assets/css/premium-ui-system.css">
    <link rel="stylesheet" href="assets/css/unified-cards.css">
    <link rel="stylesheet" href="assets/css/page-layouts.css">
    <link rel="stylesheet" href="assets/css/high-contrast-universal.css">
    <link rel="stylesheet" href="assets/css/nordic-design-system.css">
    <link rel="stylesheet" href="assets/css/modern-nordic-vintage.css">
    <link rel="stylesheet" href="assets/css/dark-mode-enhancements.css">
    <link rel="stylesheet" href="assets/css/page-ui-improvements.css">
    <link rel="stylesheet" href="assets/css/recipe-developer-enhanced.css">
    <link rel="stylesheet" href="assets/css/header-universal.css">
    <link rel="stylesheet" href="assets/css/recipe-developer-contrast-fix.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
    
    <!-- Enhanced User Management now handled by Firebase Auth -->
    <script src="assets/js/project-management-system.js"></script>
    <script src="assets/js/error_handler.js"></script>
    
    <style>
        /* Recipe Developer Specific Styles - Light, Launch-Page Aligned */
        .recipe-canvas {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(226, 232, 240, 0.9);
        }
        
        .recipe-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            border-radius: 18px;
            background: #ffffff;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
        }
        
        .recipe-section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ingredient-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
        }
        
        .ingredient-row:last-child {
            border-bottom: none;
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--accent-main);
            color: var(--text-primary);
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.875rem;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .nutrition-item {
            text-align: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 14px;
            border: 1px solid rgba(226, 232, 240, 0.9);
        }
        
        .nutrition-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2563eb;
        }
        
        .nutrition-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 4px;
        }
        
        /* Recipe Development Layout */
        .recipe-development-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        /* Recipe Ideas Sidebar */
        .recipe-ideas-sidebar {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(226, 232, 240, 0.9);
            display: flex;
            flex-direction: column;
            height: fit-content;
            position: sticky;
            top: 24px;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0f172a;
            margin: 0;
        }

        .ideas-filter {
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .ideas-list-container {
            flex: 1;
            overflow-y: auto;
            max-height: 600px;
        }

        .ideas-list {
            padding: var(--spacing-4);
        }

        .idea-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-3);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
        }

        .idea-item:hover {
            background: var(--gray-100);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .idea-item.selected {
            background: var(--iterum-primary);
            color: white;
            border-color: var(--iterum-primary);
        }

        .idea-item.selected .idea-meta,
        .idea-item.selected .idea-description {
            color: rgba(255, 255, 255, 0.8);
        }

        .idea-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-2);
            font-size: var(--font-size-sm);
        }

        .idea-description {
            font-size: var(--font-size-xs);
            color: var(--gray-600);
            margin-bottom: var(--spacing-2);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .idea-url {
            margin-bottom: var(--spacing-2);
        }

        .idea-url a {
            font-size: var(--font-size-xs);
            color: var(--blue-600);
            text-decoration: none;
            transition: color var(--transition-normal);
        }

        .idea-url a:hover {
            color: var(--blue-800);
            text-decoration: underline;
        }

        .idea-meta {
            display: flex;
            gap: var(--spacing-2);
            font-size: var(--font-size-xs);
            color: var(--gray-500);
        }

        .idea-status-badge {
            position: absolute;
            top: var(--spacing-2);
            right: var(--spacing-2);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .idea-status-badge.new {
            background: var(--blue-100);
            color: var(--blue-700);
        }

        .idea-status-badge.in-progress {
            background: var(--yellow-100);
            color: var(--yellow-700);
        }

                 .idea-status-badge.completed {
             background: var(--green-100);
             color: var(--green-700);
         }
         
         .idea-status-badge.history {
             background: #f3e8ff;
             color: #7c3aed;
         }
         
         /* History View Styles */
         .history-item {
             border-left: 4px solid #a78bfa;
         }
         
         .history-modal {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.5);
             display: flex;
             align-items: center;
             justify-content: center;
             z-index: 1000;
         }
         
         .history-modal-content {
             background: white;
             border-radius: var(--radius-xl);
             padding: var(--spacing-6);
             max-width: 600px;
             max-height: 80vh;
             overflow-y: auto;
             box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
         }
         
         .history-entries {
             margin: var(--spacing-4) 0;
         }
         
         .history-entry {
             padding: var(--spacing-3);
             border: 1px solid var(--gray-200);
             border-radius: var(--radius-md);
             margin-bottom: var(--spacing-2);
             background: var(--gray-50);
         }
         
         .history-entry-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: var(--spacing-2);
         }
         
         .history-version {
             background: #f3e8ff;
             color: #7c3aed;
             padding: 0.25rem 0.5rem;
             border-radius: var(--radius-full);
             font-size: var(--font-size-xs);
             font-weight: var(--font-weight-medium);
         }
         
         .history-date {
             font-size: var(--font-size-sm);
             color: var(--gray-600);
         }
         
         .history-changes {
             display: flex;
             gap: var(--spacing-2);
             flex-wrap: wrap;
         }
         
         .history-changes span {
             background: #eff6ff;
             color: #1d4ed8;
             padding: 0.25rem 0.5rem;
             border-radius: var(--radius-full);
             font-size: var(--font-size-xs);
         }

                 .sidebar-footer {
             padding: var(--spacing-4);
             border-top: 1px solid var(--gray-200);
             display: flex;
             flex-direction: column;
             gap: var(--spacing-2);
         }
         
         /* User Data Info Display */
         .user-data-info {
             padding: var(--spacing-3);
             background: var(--blue-50);
             border: 1px solid var(--blue-200);
             border-radius: var(--radius-md);
             margin: 0 var(--spacing-4);
             font-size: var(--font-size-xs);
         }
         
         .user-data-path, .user-data-status {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: var(--spacing-1);
         }
         
         .user-data-path:last-child, .user-data-status:last-child {
             margin-bottom: 0;
         }
         
         .info-label {
             font-weight: var(--font-weight-medium);
             color: var(--blue-700);
         }
         
         .path-text, .user-name {
             color: var(--blue-800);
             font-family: monospace;
             font-size: 0.75rem;
             max-width: 150px;
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: nowrap;
         }

        /* Recipe Header */
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-6);
            padding: var(--spacing-4);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        .recipe-status-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .status-label {
            font-weight: var(--font-weight-medium);
            color: var(--gray-600);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .status-badge.new {
            background: var(--blue-100);
            color: var(--blue-700);
        }

        .status-badge.in-progress {
            background: var(--yellow-100);
            color: var(--yellow-700);
        }

        .status-badge.completed {
            background: var(--green-100);
            color: var(--green-700);
        }

        .recipe-actions {
            display: flex;
            gap: var(--spacing-2);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .recipe-development-layout {
                grid-template-columns: 1fr;
            }
            
            .recipe-ideas-sidebar {
                position: static;
                margin-bottom: var(--spacing-6);
            }
        }

        /* Recipe Sketch Section */
        .sketch-tools {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-4);
            align-items: center;
            padding: var(--spacing-4);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--spacing-4);
        }
        
        .sketch-canvas-container {
            position: relative;
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            background: var(--gray-50);
            height: 600px;
            overflow: hidden;
            margin-bottom: var(--spacing-4);
        }
        
        .sketch-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            display: block;
            background: white;
            position: relative;
            z-index: 1;
            touch-action: none;
        }
        
        .sketch-canvas:focus {
            outline: 2px solid var(--iterum-primary);
            outline-offset: 2px;
        }

        .tool-buttons {
            display: flex;
            gap: var(--spacing-2);
        }

        .tool-btn {
            padding: var(--spacing-2) var(--spacing-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            background: white;
            color: var(--gray-700);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .tool-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .tool-btn.active {
            background: var(--iterum-primary);
            color: white;
            border-color: var(--iterum-primary);
        }

        .color-palette {
            display: flex;
            gap: var(--spacing-2);
        }

        .color-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .color-btn:hover {
            transform: scale(1.1);
            border-color: var(--gray-500);
        }

        .color-btn.active {
            border-color: var(--gray-700);
            transform: scale(1.1);
        }

        .sketch-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-left: auto;
        }

        .sketch-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            background: var(--gray-50);
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-2);
        }

        .placeholder-text {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--spacing-1);
        }

        .placeholder-subtext {
            font-size: var(--font-size-sm);
            text-align: center;
            max-width: 300px;
        }

        .ingredient-selector {
            padding: var(--spacing-4);
            background: var(--blue-50);
            border: 1px solid var(--blue-200);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-4);
        }

        .ingredient-selector.hidden {
            display: none;
        }

        .sketch-notes {
            margin-top: var(--spacing-4);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-4);
            justify-content: center;
            margin-top: var(--spacing-8);
        }
        
        @media (max-width: 768px) {
            .ingredient-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-2);
            }
            
            .nutrition-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Canvas Ready Indicator Animation */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
    </style>
    
    <!-- Unified Navigation & Project Selector -->
    <script src="assets/js/unified-nav-header.js" defer></script>
    <script src="assets/js/unified-project-selector.js" defer></script>
    <script src="assets/js/user-data-manager.js" defer></script>
    <script src="assets/js/cloud-data-sync.js" defer></script>
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/header-universal.css">
</head>
<body class="page-body" style="padding-top: 90px;">
    <!-- Header injected by unified-nav-header.js -->

    <!-- Main Content -->
    <main class="page-shell">
        <div class="page-layout">
            <!-- Progress Indicator -->
            <div class="recipe-progress">
                <div class="progress-steps">
                    <div class="progress-step active" data-step="basics">
                        <div>Basic Info</div>
                    </div>
                    <div class="progress-connector"></div>
                    <div class="progress-step" data-step="ingredients">
                        <div>Ingredients</div>
                    </div>
                    <div class="progress-connector"></div>
                    <div class="progress-step" data-step="instructions">
                        <div>Instructions</div>
                    </div>
                    <div class="progress-connector"></div>
                    <div class="progress-step" data-step="details">
                        <div>Details</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Tips -->
            <div class="quick-tips">
                <div class="quick-tips-title">üí° Pro Tips</div>
                <ul>
                    <li>Use <strong>Ctrl+S</strong> to save your recipe anytime</li>
                    <li>Your work is auto-saved every 30 seconds</li>
                    <li>Scale recipes easily with the calculator in the recipe library</li>
                    <li>Add component recipes to build complex dishes</li>
                </ul>
            </div>
            
            <!-- Removed legacy page header to avoid duplicate with unified header -->

            <!-- Recipe Development Layout -->
            <div class="recipe-development-layout">
                <!-- Recipe Ideas Sidebar -->
                <div class="recipe-ideas-sidebar">
                    <div class="ideas-sidebar-header">
                        <h3>üí° Recipe Ideas & History</h3>
                        <div class="ideas-sidebar-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshRecipeIdeasOnDeveloperPage()" title="Refresh Ideas">
                                üîÑ Refresh
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="createNewRecipe()">
                                üß™ New Recipe
                            </button>
                        </div>
                    </div>
                    
                    <!-- User Data Path Display -->
                    <div class="user-data-info" id="user-data-info">
                        <div class="user-data-path">
                            <span class="info-label">üìÅ User Data:</span>
                            <span class="path-text" id="user-data-path">Loading...</span>
                        </div>
                        <div class="user-data-status">
                            <span class="info-label">üë§ User:</span>
                            <span class="user-name" id="sidebar-user-name">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Ideas Filter -->
                    <div class="ideas-filter">
                        <select id="ideas-status-filter" class="form-select" onchange="filterIdeas()">
                            <option value="all">All Ideas</option>
                            <option value="idea">New Ideas</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button class="btn btn-sm btn-secondary" onclick="toggleHistoryView()">üìö History</button>
                    </div>
                    
                    <!-- Ideas List -->
                    <div class="ideas-list-container">
                        <div id="ideas-list" class="ideas-list">
                            <!-- Ideas will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Sidebar Footer -->
                    <div class="sidebar-footer">
                        <button class="btn btn-secondary w-full" onclick="createNewRecipe()">üß™ New Recipe</button>
                        <button class="btn btn-primary w-full" onclick="importFromMainPage()">üì• Import Ideas</button>
                        <button class="btn btn-success w-full" onclick="exportAllUserData()">üì§ Export All Data</button>
                    </div>
                </div>
                
                <!-- Recipe Canvas -->
                <div class="recipe-canvas">
                    <!-- Recipe Header with Status -->
                    <div class="recipe-header">
                        <div class="recipe-status-display">
                            <span class="status-label">Status:</span>
                            <span id="recipe-status" class="status-badge new">New Recipe</span>
                        </div>
                        <div class="recipe-actions">
                            <button class="btn btn-secondary" onclick="saveRecipe()">üíæ Save</button>
                            <button class="btn btn-primary" onclick="saveAndContinue()">üíæ Save & Continue</button>
                        </div>
                    </div>
                    
                    <!-- Recipe Name Section -->
                    <div class="recipe-section">
                        <div class="recipe-section-title">
                            <span>üìù</span>
                            Recipe Information
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="recipe-name" class="form-label">Recipe Name</label>
                                <input type="text" id="recipe-name" class="form-input" placeholder="Enter recipe name">
                            </div>
                            <div class="form-group">
                                <label for="recipe-category" class="form-label">Category</label>
                                <select id="recipe-category" class="form-select">
                                    <option value="">Select category</option>
                                    <option value="appetizer">Appetizer</option>
                                    <option value="main-course">Main Course</option>
                                    <option value="dessert">Dessert</option>
                                    <option value="beverage">Beverage</option>
                                    <option value="sauce">Sauce</option>
                                    <option value="prep-recipe">Prep Recipe</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recipe-cuisine" class="form-label">Cuisine</label>
                                <input type="text" id="recipe-cuisine" class="form-input" placeholder="e.g., Italian, French, Asian">
                            </div>
                            <div class="form-group">
                                <label for="recipe-servings" class="form-label">Servings</label>
                                <input type="number" id="recipe-servings" class="form-input" min="1" value="4">
                            </div>
                        </div>
                    </div>

                <!-- Ingredients Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>ü•¨</span>
                        Ingredients
                    </div>
                    <div id="ingredients-container">
                        <div class="ingredient-row" data-ingredient-index="0">
                            <div id="ingredient-select-0" class="ingredient-select-container"></div>
                            <div id="ingredient-qty-unit-0" class="quantity-unit-container"></div>
                            <input type="text" class="form-input ingredient-notes" placeholder="Notes">
                            <button class="btn btn-secondary" onclick="removeIngredient(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="addIngredient()">‚ûï Add Ingredient</button>
                        <button class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" onclick="openCreateIngredientModal()">‚ú® Create New Ingredient</button>
                    </div>
                </div>

                <!-- Instructions Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>üìã</span>
                        Instructions
                    </div>
                    <div id="instructions-container">
                        <div class="instruction-step">
                            <div class="step-number">1</div>
                            <textarea class="form-textarea" placeholder="Describe this step..."></textarea>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addInstruction()">‚ûï Add Step</button>
                </div>

                <!-- Component Recipes Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>üîó</span>
                        Component Recipes
                        <span style="font-size: 12px; color: #64748b; font-weight: normal; margin-left: 10px;">(Link other recipes as sub-recipes or components)</span>
                    </div>
                    <div id="component-recipes-container" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
                        <!-- Component recipes will be added here -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="openAddComponentRecipeModal()">‚ûï Add Component Recipe</button>
                    </div>
                </div>

                <!-- Prep Items Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>üß∫</span>
                        Prep Items & Mise
                        <span style="font-size: 12px; color: #64748b; font-weight: normal; margin-left: 10px;">(Track prep components that still need development)</span>
                    </div>
                    <div id="prep-items-container" style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
                        <!-- Prep items render here -->
                    </div>
                    <div id="prep-queue-summary" style="font-size: 13px; color: #94a3b8; margin-bottom: 12px;"></div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="openAddPrepItemModal()">‚ûï Add Prep Item</button>
                        <button class="btn btn-secondary" onclick="showPrepQueueModal()">üìã View Prep Queue</button>
                    </div>
                </div>

                <!-- Equipment Needed Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>üîß</span>
                        Equipment Needed
                    </div>
                    <div id="equipment-container" class="mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="equipment-selections">
                            <!-- Equipment checkboxes will be populated here -->
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="refreshEquipmentList()">üîÑ Refresh Equipment List</button>
                </div>

                <!-- Recipe Sketch Section -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>üé®</span>
                        Recipe Sketch
                    </div>
                    
                    <!-- Sketch Tools -->
                    <div class="sketch-tools mb-4">
                        <div class="tool-buttons">
                            <button onclick="setSketchTool('pen')" id="tool-pen" class="tool-btn active">‚úèÔ∏è Pen</button>
                            <button onclick="setSketchTool('text')" id="tool-text" class="tool-btn">üìù Text</button>
                            <button onclick="setSketchTool('shape')" id="tool-shape" class="tool-btn">üî∑ Shape</button>
                            <button onclick="setSketchTool('label')" id="tool-label" class="tool-btn">üè∑Ô∏è Label</button>
                        </div>
                        
                        <div class="color-palette">
                            <button onclick="setSketchColor('#000000')" class="color-btn active" style="background-color: #000000;"></button>
                            <button onclick="setSketchColor('#dc2626')" class="color-btn" style="background-color: #dc2626;"></button>
                            <button onclick="setSketchColor('#059669')" class="color-btn" style="background-color: #059669;"></button>
                            <button onclick="setSketchColor('#2563eb')" class="color-btn" style="background-color: #2563eb;"></button>
                            <button onclick="setSketchColor('#7c3aed')" class="color-btn" style="background-color: #7c3aed;"></button>
                            <button onclick="setSketchColor('#f59e0b')" class="color-btn" style="background-color: #f59e0b;"></button>
                        </div>
                        
                        <div class="sketch-actions">
                            <button onclick="checkCanvasStatus()" class="btn btn-warning btn-sm">üîç Check Status</button>
                            <button onclick="testCanvasDrawing()" class="btn btn-success btn-sm">üß™ Test Draw</button>
                            <button onclick="forceReinitializeCanvas()" class="btn btn-danger btn-sm">üîÑ Force Reset</button>
                            <button onclick="initializeSketchCanvas()" class="btn btn-info btn-sm">üé® Init Canvas</button>
                            <button onclick="clearSketch()" class="btn btn-secondary btn-sm">üóëÔ∏è Clear</button>
                            <button onclick="downloadSketch()" class="btn btn-primary btn-sm">üì• Download</button>
                        </div>
                    </div>
                    
                    <!-- Sketch Canvas -->
                    <div class="sketch-canvas-container">
                        <canvas id="sketch-canvas" class="sketch-canvas"></canvas>
                        <div id="sketch-placeholder" class="sketch-placeholder">
                            <div class="placeholder-icon">üé®</div>
                            <p class="placeholder-text">Click to start sketching</p>
                            <p class="placeholder-subtext">Draw your recipe concept, plating ideas, or visual notes</p>
                        </div>
                    </div>
                    
                    <!-- Ingredient Selector for Labels -->
                    <div id="ingredient-selector" class="ingredient-selector hidden">
                        <label class="form-label">Select Ingredient to Label</label>
                        <select id="ingredient-dropdown" class="form-select">
                            <option value="">Choose an ingredient...</option>
                        </select>
                        <p class="text-sm text-gray-500 mt-2">Click on the sketch to place ingredient labels</p>
                    </div>
                    
                    <!-- Sketch Notes -->
                    <div class="sketch-notes mt-4">
                        <label for="sketch-notes" class="form-label">Sketch Notes</label>
                        <textarea id="sketch-notes" class="form-textarea" rows="3" placeholder="Add notes about your sketch, plating ideas, or visual concepts..."></textarea>
                    </div>
                </div>

                <!-- Nutritional Information -->
                <div class="recipe-section">
                    <div class="recipe-section-title">
                        <span>üìä</span>
                        Nutritional Information (per serving)
                    </div>
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="calories">0</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="protein">0g</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="carbs">0g</div>
                            <div class="nutrition-label">Carbohydrates</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="fat">0g</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="fiber">0g</div>
                            <div class="nutrition-label">Fiber</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value" id="sugar">0g</div>
                            <div class="nutrition-label">Sugar</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveRecipe()">üíæ Save Recipe</button>
                    <button class="btn btn-secondary" onclick="exportRecipe()">üì§ Export</button>
                    <button class="btn btn-secondary" onclick="calculateNutrition()">üßÆ Calculate Nutrition</button>
                    <button class="btn btn-secondary" onclick="previewRecipe()">üëÅÔ∏è Preview</button>
                </div>
            </div>
        </div>
    </div>
</div>
</main>

    <!-- Essential Scripts -->
    <script>
        // Global ingredients list
        let availableIngredients = [];

        // Load ingredients from database
        function loadIngredientsDatabase() {
            console.log('üì¶ Loading ingredients database...');
            
            try {
                // Load from localStorage (ingredients_database or ingredients)
                const ingredientsDb = localStorage.getItem('ingredients_database');
                const ingredients = localStorage.getItem('ingredients');
                
                if (ingredientsDb) {
                    availableIngredients = JSON.parse(ingredientsDb);
                    console.log(`‚úÖ Loaded ${availableIngredients.length} ingredients from database`);
                } else if (ingredients) {
                    availableIngredients = JSON.parse(ingredients);
                    console.log(`‚úÖ Loaded ${availableIngredients.length} ingredients from storage`);
                } else {
                    console.warn('‚ö†Ô∏è No ingredients found, using default list');
                    availableIngredients = getDefaultIngredients();
                }
                
                // Populate all ingredient dropdowns
                populateIngredientDropdowns();
                
            } catch (error) {
                console.error('‚ùå Error loading ingredients:', error);
                availableIngredients = getDefaultIngredients();
                populateIngredientDropdowns();
            }
        }

        // Get default ingredients if database is empty
        function getDefaultIngredients() {
            return [
                { id: 'ing_1', name: 'Salt', category: 'Spices & Herbs' },
                { id: 'ing_2', name: 'Black Pepper', category: 'Spices & Herbs' },
                { id: 'ing_3', name: 'Olive Oil', category: 'Oils & Fats' },
                { id: 'ing_4', name: 'Butter', category: 'Dairy' },
                { id: 'ing_5', name: 'Garlic', category: 'Vegetables' },
                { id: 'ing_6', name: 'Onion', category: 'Vegetables' },
                { id: 'ing_7', name: 'Flour', category: 'Grains' },
                { id: 'ing_8', name: 'Sugar', category: 'Other' },
                { id: 'ing_9', name: 'Eggs', category: 'Dairy' },
                { id: 'ing_10', name: 'Milk', category: 'Dairy' }
            ];
        }

        // Get ingredient options HTML
        function getIngredientOptions() {
            let options = '<option value="__CREATE_NEW__" style="color: #10b981; font-weight: 700;">‚ûï Create New Ingredient...</option>';
            
            if (!availableIngredients || availableIngredients.length === 0) {
                return options + '<option value="">No ingredients available</option>';
            }
            
            // Sort ingredients by name
            const sorted = [...availableIngredients].sort((a, b) => 
                (a.name || '').localeCompare(b.name || '')
            );
            
            options += sorted.map(ing => 
                `<option value="${ing.id || ing.name}">${ing.name}</option>`
            ).join('');
            
            return options;
        }

        // Populate all ingredient dropdowns
        function populateIngredientDropdowns() {
            const dropdowns = document.querySelectorAll('.ingredient-select');
            const optionsHTML = getIngredientOptions();
            
            dropdowns.forEach(dropdown => {
                const currentValue = dropdown.value;
                dropdown.innerHTML = '<option value="">Select ingredient...</option>' + optionsHTML;
                if (currentValue) {
                    dropdown.value = currentValue;
                }
            });
            
            console.log(`‚úÖ Populated ${dropdowns.length} ingredient dropdowns`);
        }

        // Handle ingredient selection
        function handleIngredientSelect(selectElement) {
            const ingredientId = selectElement.value;
            if (!ingredientId) return;
            
            // Check if user wants to create new ingredient
            if (ingredientId === '__CREATE_NEW__') {
                openCreateIngredientModal(selectElement);
                return;
            }
            
            console.log('ü•¨ Selected ingredient:', ingredientId);
            
            // Find the ingredient details
            const ingredient = availableIngredients.find(ing => 
                ing.id === ingredientId || ing.name === ingredientId
            );
            
            if (ingredient) {
                console.log('üìù Ingredient details:', ingredient);
                // You can add logic here to auto-fill unit or other fields if needed
            }
        }

        // Load equipment for recipe
        function loadEquipmentForRecipe() {
            console.log('üîß Loading equipment for recipe...');
            
            // Wait for equipment manager to be ready
            const checkEquipmentManager = setInterval(() => {
                if (window.equipmentManager && window.equipmentManager.initialized) {
                    clearInterval(checkEquipmentManager);
                    populateEquipmentSelections();
                }
            }, 100);
            
            // Stop checking after 5 seconds
            setTimeout(() => clearInterval(checkEquipmentManager), 5000);
        }

        // Populate equipment selections
        function populateEquipmentSelections() {
            const container = document.getElementById('equipment-selections');
            if (!container || !window.equipmentManager) return;
            
            const equipment = window.equipmentManager.equipment;
            
            if (equipment.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-6 text-gray-500">
                        <p>No equipment available.</p>
                        <a href="equipment-management.html" class="text-blue-600 hover:underline">Add equipment first</a>
                    </div>
                `;
                return;
            }
            
            // Group by category
            const byCategory = {};
            equipment.forEach(e => {
                if (!byCategory[e.category]) byCategory[e.category] = [];
                byCategory[e.category].push(e);
            });
            
            container.innerHTML = Object.entries(byCategory).map(([category, items]) => `
                <div class="mb-4">
                    <div class="font-semibold text-sm text-gray-700 mb-2">${category}</div>
                    ${items.map(e => `
                        <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input type="checkbox" class="equipment-checkbox" value="${e.id}" name="equipment">
                            <span class="text-sm">${e.name}</span>
                        </label>
                    `).join('')}
                </div>
            `).join('');
            
            console.log(`‚úÖ Populated ${equipment.length} equipment items`);
        }

        // Refresh equipment list
        function refreshEquipmentList(silent = false) {
            if (window.equipmentManager) {
                window.equipmentManager.loadEquipment();
                populateEquipmentSelections();
                if (!silent) {
                    alert('‚úÖ Equipment list refreshed!');
                }
            }
        }

        // Auto-refresh equipment list when imports complete elsewhere
        window.addEventListener('equipmentUpdated', () => {
            refreshEquipmentList(true);
        });

        // Collect selected equipment
        function collectEquipment() {
            const checkboxes = document.querySelectorAll('.equipment-checkbox:checked');
            const equipmentIds = Array.from(checkboxes).map(cb => cb.value);
            
            const equipmentDetails = equipmentIds.map(id => {
                const equip = window.equipmentManager?.getById(id);
                return equip ? {
                    id: equip.id,
                    name: equip.name,
                    category: equip.category
                } : null;
            }).filter(Boolean);
            
            return {
                ids: equipmentIds,
                details: equipmentDetails
            };
        }

        // Check and auto-load ingredients if empty
        function checkAndAutoLoadIngredients() {
            const ingredientsDb = localStorage.getItem('ingredients_database');
            const ingredients = localStorage.getItem('ingredients');
            
            // If both are empty, auto-import
            if ((!ingredientsDb || ingredientsDb === '[]') && (!ingredients || ingredients === '[]')) {
                console.log('üì¶ No ingredients found, auto-importing base database...');
                
                // Wait for base ingredients loader to be available
                const checkLoader = setInterval(() => {
                    if (window.baseIngredientsLoader) {
                        clearInterval(checkLoader);
                        
                        // Auto-import base ingredients
                        window.baseIngredientsLoader.importToLocalStorage(false).then(result => {
                            if (result.success) {
                                console.log(`‚úÖ Auto-imported ${result.total} ingredients!`);
                                // Reload ingredients
                                loadIngredientsDatabase();
                            } else {
                                console.warn('‚ö†Ô∏è Auto-import failed, using default ingredients');
                            }
                        });
                    }
                }, 100);
                
                // Stop checking after 5 seconds
                setTimeout(() => clearInterval(checkLoader), 5000);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Recipe Developer Page');
            
            // Auto-import base ingredients if none exist
            checkAndAutoLoadIngredients();
            
            // Initialize enhanced ingredients system
            if (window.ingredientsManager) {
                window.ingredientsManager.init();
            }
            
            // Initialize ingredient selector
            if (window.ingredientSelector) {
                window.ingredientSelector.init().then(() => {
                    initializeIngredientSelectors();
                });
            }
            
            // Load ingredients database
            loadIngredientsDatabase();
            
            // Load equipment list
            loadEquipmentForRecipe();
            
            // Initialize user system
            // User system now initializes automatically
            console.log('üîç User system auto-initialization enabled');
            
            // Initialize project manager
            if (window.projectManager) {
                window.projectManager.init();
                console.log('‚úÖ Project manager initialized');
            } else {
                console.log('‚ö†Ô∏è Project manager not available');
            }
            
            // Wait a bit for project manager to be ready, then initialize ideas
            setTimeout(() => {
                console.log('‚è≥ Initializing ideas sidebar after delay...');
                initializeIdeasSidebar();
                
                // Initialize sketch canvas
                initializeSketchCanvas();
                
                // Check for recipe to edit
                loadCurrentRecipe();
            }, 1000);
            
            // Listen for project changes to reload recipe ideas
            document.addEventListener('projectChanged', function(event) {
                console.log('üìã Project changed on recipe developer page, reloading ideas...');
                if (event.detail && event.detail.project) {
                    // Reload ideas for the new project
                    setTimeout(() => {
                        loadRecipeIdeasFromFiles();
                    }, 500);
                }
            });
            
            console.log('‚úÖ Recipe Developer Page initialized');
        });

        // Wait for app to be ready
        document.addEventListener('iterumAppReady', function() {
            initializeRecipeDeveloper();
            updateUserInfo();
            initializeProjectSelector();
        });
        
        // Listen for user switching events
        document.addEventListener('userSwitched', function(event) {
            console.log('üë§ User switched, reloading user data...');
            initializeUserFileStorage();
            loadRecipeIdeasFromFiles();
            clearRecipeForm();
            updateUserInfo();
        });
        
        document.addEventListener('userLoggedIn', function(event) {
            console.log('üîê User logged in, reloading user data...');
            initializeUserFileStorage();
            loadRecipeIdeasFromFiles();
            updateUserInfo();
        });
        
        document.addEventListener('userLoggedOut', function(event) {
            console.log('üö™ User logged out, clearing user data...');
            currentUser = null;
            userDataPath = null;
            clearRecipeForm();
            loadRecipeIdeasFromFiles(); // This will show empty state
            updateUserInfo();
        });

        // Wait for loading screen to be hidden
        document.addEventListener('loadingScreenHidden', function() {
            initializeRecipeDeveloper();
            updateUserInfo();
            initializeProjectSelector();
        });

        function initializeRecipeDeveloper() {
            console.log('üß™ Initializing Recipe Developer');
            // Initialize recipe developer functionality
            
            // Initialize ideas sidebar
            initializeIdeasSidebar();
            
            // Load current recipe if any
            loadCurrentRecipe();

            // Ensure prep UI is ready
            renderPrepItems();
            renderPrepQueueSummary();
        }

        // Recipe Ideas Sidebar System
        let currentRecipeId = null;
        let currentRecipeData = null;
        
        // User-specific file storage system
        let userDataPath = null;
        let currentUser = null;
        
        // View state management
        let isHistoryView = false;

        function initializeIdeasSidebar() {
            console.log('üí° Initializing Recipe Ideas Sidebar');
            
            // Initialize user-specific file storage
            initializeUserFileStorage();
            
            // Load ideas from user files
            loadRecipeIdeasFromFiles();
            
            // Set up event listeners
            setupIdeasEventListeners();
        }

        // User-specific file storage system
        function initializeUserFileStorage() {
            console.log('üíæ Initializing user file storage system...');
            
            // Get current user from user system
            currentUser = window.userSystem?.getCurrentUser();
            if (!currentUser) {
                console.warn('‚ö†Ô∏è No user logged in, using guest storage');
                currentUser = { id: 'guest', name: 'Guest User' };
            }
            
            // Set user data path (this would be configured based on your file system setup)
            userDataPath = `./user_data/${currentUser.id}`;
            
            console.log('‚úÖ User file storage initialized for:', currentUser.name);
        }
        
        function loadRecipeIdeasFromFiles() {
            const ideasList = document.getElementById('ideas-list');
            if (!ideasList) return;

            console.log('üìÇ Loading recipe ideas from project-aware storage...');
            
            // Try to load from project-aware storage first
            let recipeIdeas = [];
            let inProgressRecipes = [];
            
            try {
                // Try to load from project-aware storage
                if (window.projectManager && window.projectManager.getCurrentProject()) {
                    // Load recipe ideas from project-specific storage
                    const ideasProjectKey = window.projectManager.getProjectStorageKey('recipe_ideas');
                    const storedIdeas = localStorage.getItem(ideasProjectKey);
                    if (storedIdeas) {
                        recipeIdeas = JSON.parse(storedIdeas);
                        console.log('üì• Loaded', recipeIdeas.length, 'recipe ideas from project:', ideasProjectKey);
                    }
                    
                    // Load in-progress recipes from project-specific storage
                    const recipesProjectKey = window.projectManager.getProjectStorageKey('recipes_in_progress');
                    const storedRecipes = localStorage.getItem(recipesProjectKey);
                    if (storedRecipes) {
                        inProgressRecipes = JSON.parse(storedRecipes);
                        console.log('üì• Loaded', inProgressRecipes.length, 'in-progress recipes from project:', recipesProjectKey);
                    }
                } else {
                    // Fallback to global storage
                    recipeIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
                    inProgressRecipes = JSON.parse(localStorage.getItem('recipes_in_progress') || '[]');
                    console.log('üì• Loaded from global storage:', recipeIdeas.length, 'ideas,', inProgressRecipes.length, 'recipes');
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load from project storage, falling back to localStorage:', error);
                
                // Fallback to localStorage for existing data
                recipeIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
                inProgressRecipes = JSON.parse(localStorage.getItem('recipes_in_progress') || '[]');
            }
            
            // Combine ideas and in-progress recipes
            const allItems = [...recipeIdeas, ...inProgressRecipes];
            
            if (allItems.length === 0) {
                ideasList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üí°</div>
                        <p>No recipe ideas yet</p>
                        <p class="text-sm">Create ideas on the main page or start a new recipe</p>
                    </div>
                `;
                return;
            }

            // Sort by creation date (newest first)
            allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            ideasList.innerHTML = allItems.map(item => {
                const isRecipe = item.id && item.id.startsWith('recipe_');
                const status = isRecipe ? 'in-progress' : (item.status || 'idea');
                
                return `
                    <div class="idea-item" onclick="selectIdea('${item.id}', '${isRecipe ? 'recipe' : 'idea'}')" data-id="${item.id}" data-type="${isRecipe ? 'recipe' : 'idea'}">
                        <div class="idea-title">${item.title}</div>
                        <div class="idea-description">${item.description || 'No description'}</div>
                        ${item.url ? `<div class="idea-url"><a href="${item.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">üîó View Source</a></div>` : ''}
                        <div class="idea-meta">
                            ${item.cuisine ? `<span>üåç ${item.cuisine}</span>` : ''}
                            ${item.difficulty ? `<span>üìä ${item.difficulty}</span>` : ''}
                            <span>üìÖ ${new Date(item.createdAt).toLocaleDateString()}</span>
                        </div>
                        <span class="idea-status-badge ${status}">${status}</span>
                    </div>
                `;
            }).join('');
        }
        
        // File storage functions
        function loadUserFile(filename) {
            try {
                // This would integrate with your file system
                // For now, we'll simulate file loading
                const filePath = `${userDataPath}/${filename}`;
                console.log('üìÇ Attempting to load file:', filePath);
                
                // In a real implementation, this would use File System Access API or similar
                // For now, return null to trigger fallback
                return null;
            } catch (error) {
                console.error('‚ùå Error loading user file:', error);
                return null;
            }
        }
        
        function saveUserFile(filename, data) {
            try {
                const filePath = `${userDataPath}/${filename}`;
                console.log('üíæ Saving to user file:', filePath);
                
                // Convert data to JSON string
                const jsonData = JSON.stringify(data, null, 2);
                
                // In a real implementation, this would save to the file system
                // For now, we'll also save to localStorage as backup
                localStorage.setItem(`user_${currentUser.id}_${filename}`, jsonData);
                
                console.log('‚úÖ Data saved to user file:', filename);
                return true;
            } catch (error) {
                console.error('‚ùå Error saving user file:', error);
                return false;
            }
        }

        function setupIdeasEventListeners() {
            // Filter change event
            const filterSelect = document.getElementById('ideas-status-filter');
            if (filterSelect) {
                filterSelect.addEventListener('change', filterIdeas);
            }
        }

        function filterIdeas() {
            const filterValue = document.getElementById('ideas-status-filter').value;
            const ideaItems = document.querySelectorAll('.idea-item');
            
            ideaItems.forEach(item => {
                const status = item.querySelector('.idea-status-badge').textContent;
                const shouldShow = filterValue === 'all' || status === filterValue;
                item.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function selectIdea(ideaId, type) {
            console.log('üí° Selecting idea:', ideaId, 'Type:', type);
            
            // Remove previous selection
            document.querySelectorAll('.idea-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            const selectedItem = document.querySelector(`[data-id="${ideaId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            if (type === 'idea') {
                // Load idea into recipe form
                loadIdeaIntoRecipeForm(ideaId);
            } else {
                // Load existing recipe
                loadRecipeIntoForm(ideaId);
            }
        }

        function loadIdeaIntoRecipeForm(ideaId) {
            const recipeIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
            const idea = recipeIdeas.find(i => i.id === ideaId);
            
            if (!idea) {
                console.error('‚ùå Idea not found:', ideaId);
                return;
            }
            
            // Populate recipe form with idea data
            document.getElementById('recipe-name').value = idea.title;
            document.getElementById('recipe-cuisine').value = idea.cuisine || '';
            document.getElementById('recipe-category').value = '';
            document.getElementById('recipe-servings').value = '4';
            
            // Update status
            updateRecipeStatus('new', 'New Recipe from Idea');
            
            // Clear current recipe data
            currentRecipeId = null;
            currentRecipeData = null;
            
            console.log('üí° Idea loaded into recipe form:', idea);
        }

        function loadRecipeIntoForm(recipeId) {
            const inProgressRecipes = loadInProgressRecipesFromFile();
            const recipe = inProgressRecipes.find(r => r.id === recipeId);
            
            if (!recipe) {
                console.error('‚ùå Recipe not found:', recipeId);
                return;
            }
            
            // Populate recipe form with existing data
            document.getElementById('recipe-name').value = recipe.title || '';
            document.getElementById('recipe-cuisine').value = recipe.cuisine || '';
            document.getElementById('recipe-category').value = recipe.category || '';
            document.getElementById('recipe-servings').value = recipe.servings || '4';
            
            // Load ingredients if they exist
            if (recipe.ingredients) {
                loadIngredientsIntoForm(recipe.ingredients);
            }
            
            // Load instructions if they exist
            if (recipe.instructions) {
                loadInstructionsIntoForm(recipe.instructions);
            }
            
            // Update status
            updateRecipeStatus('in-progress', 'Recipe in Progress');
            
            // Set current recipe
            currentRecipeId = recipeId;
            currentRecipeData = recipe;
            
            console.log('üß™ Recipe loaded into form from user file:', recipe);
        }

        function loadIngredientsIntoForm(ingredients) {
            const container = document.getElementById('ingredients-container');
            if (!container) return;
            
            // Clear existing ingredients
            container.innerHTML = '';
            
            // Add ingredients
            ingredients.forEach((ingredient, index) => {
                addIngredient(ingredient.name, ingredient.amount, ingredient.unit, ingredient.notes);
            });
        }

        function loadInstructionsIntoForm(instructions) {
            const container = document.getElementById('instructions-container');
            if (!container) return;
            
            // Clear existing instructions
            container.innerHTML = '';
            
            // Add instructions
            instructions.forEach((instruction, index) => {
                addInstruction(instruction);
            });
        }

        function updateRecipeStatus(status, text) {
            const statusElement = document.getElementById('recipe-status');
            if (statusElement) {
                statusElement.className = `status-badge ${status}`;
                statusElement.textContent = text;
            }
        }

        function refreshIdeasList() {
            console.log('üîÑ Refreshing ideas list from user files...');
            if (isHistoryView) {
                loadRecipeHistory();
            } else {
                loadRecipeIdeasFromFiles();
            }
        }
        
        // Toggle between ideas and history view
        function toggleHistoryView() {
            isHistoryView = !isHistoryView;
            const historyBtn = document.querySelector('.ideas-filter .btn-secondary');
            
            if (isHistoryView) {
                historyBtn.textContent = 'üí° Ideas';
                historyBtn.classList.remove('btn-secondary');
                historyBtn.classList.add('btn-primary');
                document.querySelector('.sidebar-title').textContent = 'üìö Recipe History';
                loadRecipeHistory();
            } else {
                historyBtn.textContent = 'üìö History';
                historyBtn.classList.remove('btn-primary');
                historyBtn.classList.add('btn-secondary');
                document.querySelector('.sidebar-title').textContent = 'üí° Recipe Ideas';
                loadRecipeIdeasFromFiles();
            }
        }
        
        // Load recipe history from user files
        function loadRecipeHistory() {
            const ideasList = document.getElementById('ideas-list');
            if (!ideasList) return;
            
            console.log('üìö Loading recipe history from user files...');
            
            try {
                // Try to load from user-specific file first
                let recipeHistory = [];
                const historyData = loadUserFile('recipe_history.json');
                if (historyData) {
                    recipeHistory = JSON.parse(historyData);
                    console.log('üì• Loaded', recipeHistory.length, 'history entries from user file');
                } else {
                    // Fallback to localStorage
                    recipeHistory = JSON.parse(localStorage.getItem(`user_${currentUser?.id || 'guest'}_recipe_history`) || '[]');
                    console.log('üì• Loaded', recipeHistory.length, 'history entries from localStorage fallback');
                }
                
                if (recipeHistory.length === 0) {
                    ideasList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üìö</div>
                            <p>No recipe history yet</p>
                            <p class="text-sm">Start creating and saving recipes to build history</p>
                        </div>
                    `;
                    return;
                }
                
                // Group history by recipe
                const recipeHistoryMap = new Map();
                recipeHistory.forEach(entry => {
                    if (!recipeHistoryMap.has(entry.recipeId)) {
                        recipeHistoryMap.set(entry.recipeId, []);
                    }
                    recipeHistoryMap.get(entry.recipeId).push(entry);
                });
                
                // Display history grouped by recipe
                ideasList.innerHTML = Array.from(recipeHistoryMap.entries()).map(([recipeId, entries]) => {
                    const latestEntry = entries[0]; // Most recent entry
                    const totalVersions = entries.length;
                    
                    return `
                        <div class="idea-item history-item" onclick="viewRecipeHistory('${recipeId}')" data-id="${recipeId}">
                            <div class="idea-title">${latestEntry.title}</div>
                            <div class="idea-description">
                                üìö ${totalVersions} version${totalVersions > 1 ? 's' : ''} ‚Ä¢ Last updated: ${new Date(latestEntry.timestamp).toLocaleDateString()}
                            </div>
                            <div class="idea-meta">
                                <span>üïí ${new Date(latestEntry.timestamp).toLocaleTimeString()}</span>
                                <span>üë§ ${latestEntry.userName}</span>
                            </div>
                            <span class="idea-status-badge history">History</span>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error loading recipe history:', error);
                ideasList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">‚ùå</div>
                        <p>Error loading history</p>
                        <p class="text-sm">Please try refreshing</p>
                    </div>
                `;
            }
        }
        
        // View detailed recipe history
        function viewRecipeHistory(recipeId) {
            console.log('üìö Viewing recipe history for:', recipeId);
            
            try {
                // Load recipe history
                let recipeHistory = [];
                const historyData = loadUserFile('recipe_history.json');
                if (historyData) {
                    recipeHistory = JSON.parse(historyData);
                } else {
                    recipeHistory = JSON.parse(localStorage.getItem(`user_${currentUser?.id || 'guest'}_recipe_history`) || '[]');
                }
                
                // Filter history for this recipe
                const recipeEntries = recipeHistory.filter(entry => entry.recipeId === recipeId);
                
                if (recipeEntries.length === 0) {
                    alert('No history found for this recipe');
                    return;
                }
                
                // Sort by timestamp (newest first)
                recipeEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Create history summary
                const historySummary = recipeEntries.map((entry, index) => {
                    const date = new Date(entry.timestamp).toLocaleDateString();
                    const time = new Date(entry.timestamp).toLocaleTimeString();
                    const changes = entry.changes;
                    
                    return `
                        <div class="history-entry">
                            <div class="history-entry-header">
                                <span class="history-version">v${entry.version || (index + 1)}</span>
                                <span class="history-date">${date} at ${time}</span>
                            </div>
                            <div class="history-changes">
                                <span>üìù ${changes.ingredients} ingredients</span>
                                <span>üìã ${changes.instructions} steps</span>
                                ${changes.hasSketch ? '<span>üé® Has sketch</span>' : ''}
                                ${changes.hasNutrition ? '<span>üìä Has nutrition</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Show history in modal or expand the item
                const historyModal = `
                    <div class="history-modal">
                        <div class="history-modal-content">
                            <h3>üìö Recipe History: ${recipeEntries[0].title}</h3>
                            <div class="history-entries">
                                ${historySummary}
                            </div>
                            <button class="btn btn-primary" onclick="closeHistoryModal()">Close</button>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', historyModal);
                
            } catch (error) {
                console.error('‚ùå Error viewing recipe history:', error);
                alert('Error loading recipe history');
            }
        }
        
        // Close history modal
        function closeHistoryModal() {
            const modal = document.querySelector('.history-modal');
            if (modal) {
                modal.remove();
            }
        }

        function createNewRecipe() {
            console.log('üß™ Creating new recipe...');
            
            // Clear form
            clearRecipeForm();
            
            // Update status
            updateRecipeStatus('new', 'New Recipe');
            
            // Clear current recipe
            currentRecipeId = null;
            currentRecipeData = null;
            
            // Remove selection from sidebar
            document.querySelectorAll('.idea-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        function clearRecipeForm() {
            document.getElementById('recipe-name').value = '';
            document.getElementById('recipe-cuisine').value = '';
            document.getElementById('recipe-category').value = '';
            document.getElementById('recipe-servings').value = '4';
            
            // Clear ingredients
            const ingredientsContainer = document.getElementById('ingredients-container');
            if (ingredientsContainer) {
                ingredientsContainer.innerHTML = `
                    <div class="ingredient-row">
                        <input type="text" class="form-input" placeholder="Ingredient name">
                        <input type="text" class="form-input" placeholder="Amount">
                        <select class="form-select">
                            <option value="g">grams</option>
                            <option value="kg">kilograms</option>
                            <option value="ml">milliliters</option>
                            <option value="l">liters</option>
                            <option value="tsp">teaspoon</option>
                            <option value="tbsp">tablespoon</option>
                            <option value="cup">cup</option>
                            <option value="piece">piece</option>
                        </select>
                        <input type="text" class="form-input" placeholder="Notes">
                        <button class="btn btn-secondary" onclick="removeIngredient(this)">üóëÔ∏è</button>
                    </div>
                `;
            }
            
            // Clear instructions
            const instructionsContainer = document.getElementById('instructions-container');
            if (instructionsContainer) {
                instructionsContainer.innerHTML = `
                    <div class="instruction-step">
                        <div class="step-number">1</div>
                        <textarea class="form-textarea" placeholder="Describe this step..."></textarea>
                    </div>
                `;
            }
        }

        function importFromMainPage() {
            console.log('üì• Importing ideas from main page...');
            
            // Refresh the ideas list
            loadRecipeIdeas();
            
            // Show success message
            alert('Ideas imported successfully! Check the sidebar for your recipe ideas.');
        }

        function saveAndContinue() {
            console.log('üíæ Saving and continuing recipe...');
            
            // Save the current recipe
            saveRecipe();
            
            // Keep the form open for continued editing
            console.log('‚úÖ Recipe saved, continue editing...');
        }

        function loadCurrentRecipe() {
            console.log('üîç Checking for recipe to edit...');
            
            // Check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            const recipeId = editId || urlParams.get('recipe') || localStorage.getItem('current_recipe_id');
            
            if (recipeId || editId) {
                console.log('üìù Edit mode detected! Recipe ID:', recipeId || editId);
                
                // Method 1: Try localStorage recipe_to_edit
                let recipeToEdit = localStorage.getItem('recipe_to_edit');
                if (!recipeToEdit) {
                    // Method 2: Try sessionStorage
                    recipeToEdit = sessionStorage.getItem('recipe_to_edit');
                    console.log('üîç Checking sessionStorage...');
                }
                
                if (recipeToEdit) {
                    try {
                        const recipe = JSON.parse(recipeToEdit);
                        console.log('‚úÖ Found recipe in storage:', recipe.name || recipe.title);
                        loadRecipeDataIntoForm(recipe);
                        return;
                    } catch (e) {
                        console.error('‚ùå Error parsing recipe_to_edit:', e);
                    }
                }
                
                // Method 3: Load by ID from data managers
                console.log('üîç Recipe not in temp storage, searching by ID...');
                const foundRecipe = findRecipeById(recipeId || editId);
                if (foundRecipe) {
                    console.log('‚úÖ Found recipe by ID:', foundRecipe.name || foundRecipe.title);
                    loadRecipeDataIntoForm(foundRecipe);
                    return;
                }
                
                console.error('‚ùå Recipe not found anywhere!');
                alert('‚ùå Could not load recipe for editing. Please try again from the recipe library.');
            } else {
                console.log('‚ÑπÔ∏è No recipe to edit - new recipe mode');
            }
            
            // Load nutrition data if available
            loadNutritionData();
        }
        
        function findRecipeById(id) {
            console.log('üîç Searching for recipe by ID:', id);
            
            // Try User Data Manager
            if (window.userDataManager) {
                const allRecipes = window.userDataManager.loadData('recipes', { filterByProject: false });
                const recipe = allRecipes.find(r => r.id === id);
                if (recipe) {
                    console.log('‚úÖ Found in userDataManager');
                    return recipe;
                }
            }
            
            // Try Universal Recipe Manager
            if (window.universalRecipeManager) {
                const recipe = window.universalRecipeManager.getRecipe(id);
                if (recipe) {
                    console.log('‚úÖ Found in universalRecipeManager');
                    return recipe;
                }
            }
            
            // Try all localStorage keys
            const user = window.authManager?.currentUser;
            const userId = user?.userId || user?.id;
            
            const keysToCheck = [
                `recipes_${userId}`,
                'recipes'
            ];
            
            for (const key of keysToCheck) {
                const dataJson = localStorage.getItem(key);
                if (dataJson) {
                    try {
                        const recipes = JSON.parse(dataJson);
                        const recipe = recipes.find(r => r.id === id);
                        if (recipe) {
                            console.log(`‚úÖ Found in ${key}`);
                            return recipe;
                        }
                    } catch (e) {
                        console.warn(`‚ö†Ô∏è Error parsing ${key}:`, e);
                    }
                }
            }
            
            console.log('‚ùå Recipe not found in any storage location');
            return null;
        }
        
        function loadRecipeDataIntoForm(recipe) {
            console.log('üìù Loading recipe data into form...', recipe);
            
            // Populate basic fields with safety checks
            const fields = {
                'recipe-name': recipe.name || recipe.title || '',
                'description': recipe.description || '',
                'recipe-category': recipe.category || '',
                'servings': recipe.servings || recipe.yield || '',
                'prep-time': recipe.prep_time || recipe.prepTime || '',
                'cook-time': recipe.cook_time || recipe.cookTime || ''
            };
            
            Object.entries(fields).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value;
                    console.log(`‚úÖ Set ${fieldId}:`, value);
                } else {
                    console.warn(`‚ö†Ô∏è Field not found: ${fieldId}`);
                }
            });
            
            // Load ingredients if available
            if (recipe.ingredients && Array.isArray(recipe.ingredients)) {
                console.log(`üìù Loading ${recipe.ingredients.length} ingredients...`);
                // TODO: Add ingredients to the form
            }
            
            // Load instructions if available
            if (recipe.instructions && Array.isArray(recipe.instructions)) {
                console.log(`üìù Loading ${recipe.instructions.length} instructions...`);
                // TODO: Add instructions to the form
            }
            
            // üîó Load component recipes if available
            if (recipe.componentRecipes && Array.isArray(recipe.componentRecipes)) {
                console.log(`üîó Loading ${recipe.componentRecipes.length} component recipes...`);
                componentRecipes = recipe.componentRecipes;
                displayComponentRecipes();
            } else {
                componentRecipes = [];
                displayComponentRecipes();
            }

            if (recipe.prepItems && Array.isArray(recipe.prepItems)) {
                prepItems = recipe.prepItems;
            } else {
                prepItems = [];
            }
            renderPrepItems();
            
            // Show page title as "Edit Recipe"
            const pageTitle = document.querySelector('.page-header h1');
            if (pageTitle) {
                pageTitle.innerHTML = `‚úèÔ∏è Edit Recipe: ${recipe.name || recipe.title}`;
                console.log('‚úÖ Updated page title');
            }
            
            // Update status badge
            const statusBadge = document.getElementById('recipe-status');
            if (statusBadge) {
                statusBadge.textContent = 'Editing';
                statusBadge.className = 'status-badge editing';
                console.log('‚úÖ Updated status badge');
            }
            
            // Store original recipe ID and full recipe for updating
            localStorage.setItem('editing_recipe_id', recipe.id);
            localStorage.setItem('editing_recipe_data', JSON.stringify(recipe));
            
            console.log('‚úÖ Recipe data loaded into form successfully!');
            
            // Show success notification
            showNotification(`üìù Now editing: ${recipe.name || recipe.title}`, 'info');
            
            // Clear temporary storage after a delay
            setTimeout(() => {
                localStorage.removeItem('recipe_to_edit');
                sessionStorage.removeItem('recipe_to_edit');
                console.log('üßπ Cleared temporary edit storage');
            }, 2000);
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#10b981' : type === 'info' ? '#3b82f6' : '#ef4444';
            notification.style.cssText = `
                position: fixed;
                top: 90px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 99999;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Load nutrition data from user files
        function loadNutritionData() {
            try {
                // Try to load from user-specific file first
                let nutritionData = loadUserFile('nutrition_data.json');
                if (nutritionData) {
                    nutritionData = JSON.parse(nutritionData);
                    console.log('üì• Nutrition data loaded from user file');
                } else {
                    // Fallback to localStorage
                    nutritionData = localStorage.getItem(`user_${currentUser?.id || 'guest'}_nutrition_data`);
                    if (nutritionData) {
                        nutritionData = JSON.parse(nutritionData);
                        console.log('üì• Nutrition data loaded from localStorage fallback');
                    }
                }
                
                if (nutritionData) {
                    // Update nutrition display
                    document.getElementById('calories').textContent = nutritionData.calories || '0';
                    document.getElementById('protein').textContent = (nutritionData.protein || '0') + 'g';
                    document.getElementById('carbs').textContent = (nutritionData.carbs || '0') + 'g';
                    document.getElementById('fat').textContent = (nutritionData.fat || '0') + 'g';
                    document.getElementById('fiber').textContent = (nutritionData.fiber || '0') + 'g';
                    document.getElementById('sugar').textContent = (nutritionData.sugar || '0') + 'g';
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load nutrition data:', error);
            }
        }

        // Recipe Sketch Canvas System
        let sketchCanvas, sketchCtx;
        let isDrawing = false;
        let currentSketchTool = 'pen';
        let currentSketchColor = '#000000';
        let lastX = 0;
        let lastY = 0;
        let ingredientLabels = [];

        function initializeSketchCanvas() {
            console.log('üé® Initializing Recipe Sketch Canvas');
            
            sketchCanvas = document.getElementById('sketch-canvas');
            if (!sketchCanvas) {
                console.warn('‚ö†Ô∏è Sketch canvas element not found');
                return;
            }
            
            sketchCtx = sketchCanvas.getContext('2d');
            if (!sketchCtx) {
                console.error('‚ùå Could not get canvas context');
                return;
            }
            
            // Set canvas size to match container
            const container = sketchCanvas.parentElement;
            const rect = container.getBoundingClientRect();
            sketchCanvas.width = rect.width;
            sketchCanvas.height = rect.height;
            
            // Set initial styles
            sketchCtx.strokeStyle = currentSketchColor;
            sketchCtx.lineWidth = 2;
            sketchCtx.lineCap = 'round';
            sketchCtx.lineJoin = 'round';
            
            // Load ingredients for labeling
            loadIngredientsForLabeling();
            
            // Remove any existing event listeners to prevent duplicates
            sketchCanvas.removeEventListener('mousedown', startSketchDrawing);
            sketchCanvas.removeEventListener('mousemove', sketchDraw);
            sketchCanvas.removeEventListener('mouseup', stopSketchDrawing);
            sketchCanvas.removeEventListener('mouseout', stopSketchDrawing);
            sketchCanvas.removeEventListener('click', handleSketchCanvasClick);
            sketchCanvas.removeEventListener('touchstart', handleSketchTouchStart);
            sketchCanvas.removeEventListener('touchmove', handleSketchTouchMove);
            sketchCanvas.removeEventListener('touchend', stopSketchDrawing);
            
            // Add event listeners
            sketchCanvas.addEventListener('mousedown', startSketchDrawing);
            sketchCanvas.addEventListener('mousemove', sketchDraw);
            sketchCanvas.addEventListener('mouseup', stopSketchDrawing);
            sketchCanvas.addEventListener('mouseout', stopSketchDrawing);
            sketchCanvas.addEventListener('click', handleSketchCanvasClick);
            
            // Touch events for mobile
            sketchCanvas.addEventListener('touchstart', handleSketchTouchStart);
            sketchCanvas.addEventListener('touchmove', handleSketchTouchMove);
            sketchCanvas.addEventListener('touchend', stopSketchDrawing);
            
            // Hide placeholder when drawing starts
            sketchCanvas.addEventListener('mousedown', hideSketchPlaceholder);
            sketchCanvas.addEventListener('touchstart', hideSketchPlaceholder);
            
            // Add resize handler
            window.removeEventListener('resize', handleCanvasResize);
            window.addEventListener('resize', handleCanvasResize);
            
            // Show success indicator
            showCanvasReadyIndicator();
            
            // Make canvas visible and clickable
            sketchCanvas.style.pointerEvents = 'auto';
            sketchCanvas.style.cursor = 'crosshair';
            
            console.log('‚úÖ Sketch canvas initialized successfully');
            console.log('üé® Canvas size:', sketchCanvas.width, 'x', sketchCanvas.height);
            console.log('üé® Canvas element:', sketchCanvas);
            console.log('üé® Canvas context:', sketchCtx);
        }
        
        // Show canvas ready indicator
        function showCanvasReadyIndicator() {
            const container = document.querySelector('.sketch-canvas-container');
            if (container) {
                // Add a temporary success message
                const indicator = document.createElement('div');
                indicator.className = 'canvas-ready-indicator';
                indicator.innerHTML = 'üé® Canvas Ready - Click and drag to draw!';
                indicator.style.cssText = `
                    position: absolute;
                    top: 10px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #10b981;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 500;
                    z-index: 10;
                    animation: fadeInOut 3s ease-in-out;
                `;
                
                container.appendChild(indicator);
                
                // Remove after animation
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.parentNode.removeChild(indicator);
                    }
                }, 3000);
                
                // Test the canvas by drawing a small test line
                setTimeout(() => {
                    testCanvasDrawing();
                }, 1000);
            }
        }
        
        // Test canvas drawing functionality
        function testCanvasDrawing() {
            if (!sketchCanvas || !sketchCtx) {
                console.warn('‚ö†Ô∏è Cannot test drawing - canvas not ready');
                return;
            }
            
            try {
                // Draw a small test line to verify canvas is working
                sketchCtx.save();
                sketchCtx.strokeStyle = '#10b981';
                sketchCtx.lineWidth = 3;
                sketchCtx.beginPath();
                sketchCtx.moveTo(10, 10);
                sketchCtx.lineTo(30, 10);
                sketchCtx.stroke();
                sketchCtx.restore();
                
                console.log('‚úÖ Canvas drawing test successful');
                
                // Remove test line after 2 seconds
                setTimeout(() => {
                    if (sketchCanvas && sketchCtx) {
                        sketchCtx.clearRect(0, 0, sketchCanvas.width, sketchCanvas.height);
                        console.log('üßπ Test line cleared');
                    }
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Canvas drawing test failed:', error);
            }
        }
        
        // Handle canvas resize
        function handleCanvasResize() {
            if (sketchCanvas) {
                const container = sketchCanvas.parentElement;
                sketchCanvas.width = container.clientWidth;
                sketchCanvas.height = container.clientHeight;
                
                // Redraw all labels after resize
                redrawAllLabels();
                console.log('üîÑ Canvas resized');
            }
        }

        function hideSketchPlaceholder() {
            const placeholder = document.getElementById('sketch-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        }

        function startSketchDrawing(e) {
            console.log('üé® Start drawing event triggered');
            
            if (!sketchCanvas || !sketchCtx) {
                console.warn('‚ö†Ô∏è Canvas not initialized in startSketchDrawing');
                return;
            }
            
            isDrawing = true;
            const rect = sketchCanvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            console.log('‚úèÔ∏è Started drawing at:', lastX, lastY);
            
            // Hide placeholder immediately when drawing starts
            hideSketchPlaceholder();
        }

        function sketchDraw(e) {
            if (!isDrawing || !sketchCanvas || !sketchCtx) {
                if (!isDrawing) console.log('üé® Not drawing');
                if (!sketchCanvas) console.log('üé® No canvas');
                if (!sketchCtx) console.log('üé® No context');
                return;
            }
            
            const rect = sketchCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Ensure we're within canvas bounds
            if (x < 0 || x > sketchCanvas.width || y < 0 || y > sketchCanvas.height) {
                return;
            }
            
            sketchCtx.beginPath();
            sketchCtx.moveTo(lastX, lastY);
            sketchCtx.lineTo(x, y);
            sketchCtx.stroke();
            
            lastX = x;
            lastY = y;
            
            console.log('‚úèÔ∏è Drawing line to:', x, y);
        }

        function stopSketchDrawing() {
            if (isDrawing) {
                isDrawing = false;
                console.log('‚úèÔ∏è Stopped drawing');
            }
        }

        function handleSketchTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            sketchCanvas.dispatchEvent(mouseEvent);
        }

        function handleSketchTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            sketchCanvas.dispatchEvent(mouseEvent);
        }

        function setSketchTool(tool) {
            currentSketchTool = tool;
            
            // Update button styles
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`tool-${tool}`).classList.add('active');
            
            // Show/hide ingredient selector
            const ingredientSelector = document.getElementById('ingredient-selector');
            if (tool === 'label') {
                ingredientSelector.classList.remove('hidden');
            } else {
                ingredientSelector.classList.add('hidden');
            }
            
            // Update cursor
            if (tool === 'pen') {
                sketchCanvas.style.cursor = 'crosshair';
            } else if (tool === 'text') {
                sketchCanvas.style.cursor = 'text';
            } else if (tool === 'shape') {
                sketchCanvas.style.cursor = 'crosshair';
            } else if (tool === 'label') {
                sketchCanvas.style.cursor = 'pointer';
            }
            
            console.log('üé® Sketch tool changed to:', tool);
        }

        function setSketchColor(color) {
            currentSketchColor = color;
            sketchCtx.strokeStyle = color;
            sketchCtx.fillStyle = color;
            
            // Update color button styles
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked color button
            const colorButtons = document.querySelectorAll('.color-btn');
            colorButtons.forEach(btn => {
                if (btn.style.backgroundColor === color) {
                    btn.classList.add('active');
                }
            });
            
            console.log('üé® Sketch color changed to:', color);
        }

        function clearSketch() {
            if (confirm('Are you sure you want to clear the sketch?')) {
                sketchCtx.clearRect(0, 0, sketchCanvas.width, sketchCanvas.height);
                ingredientLabels = [];
                const placeholder = document.getElementById('sketch-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
                console.log('üóëÔ∏è Sketch cleared');
            }
        }

        function downloadSketch() {
            const link = document.createElement('a');
            link.download = `recipe-sketch-${Date.now()}.png`;
            link.href = sketchCanvas.toDataURL();
            link.click();
            console.log('üì• Sketch downloaded');
        }

        function loadIngredientsForLabeling() {
            const dropdown = document.getElementById('ingredient-dropdown');
            if (!dropdown) return;
            
            // Get ingredients from the form
            const ingredientRows = document.querySelectorAll('.ingredient-row input');
            const ingredients = [];
            
            ingredientRows.forEach((input, index) => {
                if (index % 4 === 0 && input.value.trim()) { // Every 4th input is ingredient name
                    ingredients.push(input.value.trim());
                }
            });
            
            // Populate dropdown
            dropdown.innerHTML = '<option value="">Choose an ingredient...</option>';
            ingredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient;
                option.textContent = ingredient;
                dropdown.appendChild(option);
            });
        }

        function handleSketchCanvasClick(e) {
            if (currentSketchTool === 'label') {
                const rect = sketchCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const selectedIngredient = document.getElementById('ingredient-dropdown').value;
                if (selectedIngredient) {
                    addIngredientLabel(x, y, selectedIngredient);
                }
            }
        }

        function addIngredientLabel(x, y, ingredientName) {
            const label = {
                x: x,
                y: y,
                ingredient: ingredientName,
                timestamp: Date.now()
            };
            
            ingredientLabels.push(label);
            drawIngredientLabel(label);
            console.log('üè∑Ô∏è Added ingredient label:', ingredientName, 'at', x, y);
        }

        function drawIngredientLabel(label) {
            sketchCtx.save();
            sketchCtx.fillStyle = '#ffffff';
            sketchCtx.strokeStyle = currentSketchColor;
            sketchCtx.lineWidth = 2;
            
            // Draw label background
            const text = label.ingredient;
            sketchCtx.font = '12px Arial';
            const textMetrics = sketchCtx.measureText(text);
            const padding = 4;
            const labelWidth = textMetrics.width + padding * 2;
            const labelHeight = 16;
            
            sketchCtx.fillRect(label.x, label.y - labelHeight, labelWidth, labelHeight);
            sketchCtx.strokeRect(label.x, label.y - labelHeight, labelWidth, labelHeight);
            
            // Draw text
            sketchCtx.fillStyle = currentSketchColor;
            sketchCtx.fillText(text, label.x + padding, label.y - 4);
            
            // Draw connecting line
            sketchCtx.beginPath();
            sketchCtx.moveTo(label.x + labelWidth / 2, label.y);
            sketchCtx.lineTo(label.x + labelWidth / 2, label.y + 10);
            sketchCtx.stroke();
            
            sketchCtx.restore();
        }

        function redrawAllLabels() {
            ingredientLabels.forEach(label => {
                drawIngredientLabel(label);
            });
        }

        // Save sketch data with recipe
        function saveSketchData() {
            if (sketchCanvas) {
                const sketchData = {
                    canvasData: sketchCanvas.toDataURL(),
                    notes: document.getElementById('sketch-notes').value,
                    ingredientLabels: ingredientLabels,
                    recipeId: currentRecipeId,
                    userId: currentUser?.id || 'guest',
                    userName: currentUser?.name || 'Guest User',
                    savedAt: new Date().toISOString()
                };
                
                // Save to user-specific file
                const success = saveUserFile('sketch_data.json', sketchData);
                
                if (success) {
                    console.log('üíæ Sketch data saved to user file');
                } else {
                    console.warn('‚ö†Ô∏è Failed to save sketch data to user file, using localStorage fallback');
                    localStorage.setItem(`user_${currentUser?.id || 'guest'}_sketch_data`, JSON.stringify(sketchData));
                }
            }
        }

        // Load sketch data
        function loadSketchData() {
            // Try to load from user-specific file first
            let sketchData = null;
            
            try {
                sketchData = loadUserFile('sketch_data.json');
                if (sketchData) {
                    sketchData = JSON.parse(sketchData);
                    console.log('üì• Sketch data loaded from user file');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load sketch data from user file, trying localStorage fallback');
                // Fallback to localStorage
                sketchData = localStorage.getItem(`user_${currentUser?.id || 'guest'}_sketch_data`);
                if (sketchData) {
                    sketchData = JSON.parse(sketchData);
                    console.log('üì• Sketch data loaded from localStorage fallback');
                }
            }
            
            if (sketchData && sketchCanvas) {
                try {
                    // Load canvas image
                    if (sketchData.canvasData) {
                        const img = new Image();
                        img.onload = function() {
                            sketchCtx.clearRect(0, 0, sketchCanvas.width, sketchCanvas.height);
                            sketchCtx.drawImage(img, 0, 0);
                            hideSketchPlaceholder();
                        };
                        img.src = sketchData.canvasData;
                    }
                    
                    // Load notes
                    if (sketchData.notes) {
                        document.getElementById('sketch-notes').value = sketchData.notes;
                    }
                    
                    // Load ingredient labels
                    if (sketchData.ingredientLabels) {
                        ingredientLabels = sketchData.ingredientLabels;
                        redrawAllLabels();
                    }
                    
                    console.log('üì• Sketch data loaded successfully');
                } catch (error) {
                    console.error('‚ùå Error loading sketch data:', error);
                }
            }
        }

        // Recipe Form Functions
        function addIngredient(name = '', amount = '', unit = 'g', notes = '', wastePercentage = 0) {
            const container = document.getElementById('ingredients-container');
            if (!container) return;
            
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'ingredient-row';
            ingredientRow.innerHTML = `
                <input type="text" class="form-input" placeholder="Ingredient name" value="${name}">
                <input type="text" class="form-input" placeholder="Amount" value="${amount}">
                <select class="form-select">
                    <option value="g" ${unit === 'g' ? 'selected' : ''}>grams</option>
                    <option value="kg" ${unit === 'kg' ? 'selected' : ''}>kilograms</option>
                    <option value="ml" ${unit === 'ml' ? 'selected' : ''}>milliliters</option>
                    <option value="l" ${unit === 'l' ? 'selected' : ''}>liters</option>
                    <option value="tsp" ${unit === 'tsp' ? 'selected' : ''}>teaspoon</option>
                    <option value="tbsp" ${unit === 'tbsp' ? 'selected' : ''}>tablespoon</option>
                    <option value="cup" ${unit === 'cup' ? 'selected' : ''}>cup</option>
                    <option value="piece" ${unit === 'piece' ? 'selected' : ''}>piece</option>
                </select>
                <input type="number" class="form-input" placeholder="Waste %" min="0" max="100" step="0.1" value="${wastePercentage}" style="width: 90px;" title="Phase 2: Trim/Waste percentage (e.g., 10 for 10% waste)">
                <input type="text" class="form-input" placeholder="Notes" value="${notes}">
                <button class="btn btn-secondary" onclick="removeIngredient(this)">üóëÔ∏è</button>
            `;
            
            container.appendChild(ingredientRow);
        }

        function removeIngredient(button) {
            const row = button.closest('.ingredient-row');
            if (row) {
                row.remove();
            }
        }

        function addInstruction(instruction = '') {
            const container = document.getElementById('instructions-container');
            if (!container) return;
            
            const stepNumber = container.children.length + 1;
            const instructionStep = document.createElement('div');
            instructionStep.className = 'instruction-step';
            instructionStep.innerHTML = `
                <div class="step-number">${stepNumber}</div>
                <textarea class="form-textarea" placeholder="Describe this step...">${instruction}</textarea>
            `;
            
            container.appendChild(instructionStep);
        }

        function removeInstruction(button) {
            const step = button.closest('.instruction-step');
            if (step) {
                step.remove();
                // Renumber remaining steps
                const steps = document.querySelectorAll('.instruction-step');
                steps.forEach((step, index) => {
                    const number = step.querySelector('.step-number');
                    if (number) {
                        number.textContent = index + 1;
                    }
                });
            }
        }

        // Save recipe function
        function saveRecipe() {
            console.log('üíæ Saving recipe...');
            
            // Collect equipment
            const equipmentData = collectEquipment();
            
            // Collect recipe data
            const recipeData = {
                id: currentRecipeId || 'recipe_' + Date.now(),
                title: document.getElementById('recipe-name').value,
                category: document.getElementById('recipe-category').value,
                cuisine: document.getElementById('recipe-cuisine').value,
                servings: parseInt(document.getElementById('recipe-servings').value) || 4,
                yieldQuantity: parseInt(document.getElementById('recipe-servings').value) || 4, // Phase 2: Yield quantity
                yield: parseInt(document.getElementById('recipe-servings').value) || 4, // Legacy support
                ingredients: collectIngredients(),
                instructions: collectInstructions(),
                equipmentNeeded: equipmentData.ids,
                equipmentDetails: equipmentData.details,
                componentRecipes: componentRecipes || [],  // üîó NEW: Save component recipes
                prepItems: prepItems || [],
                status: 'in-progress',
                lastUpdated: new Date().toISOString(),
                userId: currentUser?.id || 'guest',
                userName: currentUser?.name || 'Guest User',
                // Additional metadata
                notes: document.getElementById('sketch-notes')?.value || '',
                sketchData: {
                    hasSketch: ingredientLabels.length > 0,
                    labelCount: ingredientLabels.length,
                    lastSketchUpdate: new Date().toISOString()
                },
                nutritionData: {
                    calories: document.getElementById('calories')?.textContent || '0',
                    protein: document.getElementById('protein')?.textContent || '0g',
                    carbs: document.getElementById('carbs')?.textContent || '0g',
                    fat: document.getElementById('fat')?.textContent || '0g',
                    fiber: document.getElementById('fiber')?.textContent || '0g',
                    sugar: document.getElementById('sugar')?.textContent || '0g'
                },
                metadata: {
                    createdFromIdea: currentRecipeId ? false : true,
                    totalIngredients: collectIngredients().length,
                    totalInstructions: collectInstructions().length,
                    totalEquipment: equipmentData.ids.length,
                    complexity: calculateRecipeComplexity(),
                    estimatedPrepTime: estimatePrepTime(),
                    tags: generateRecipeTags()
                }
            };
            
            if (!recipeData.title.trim()) {
                alert('Please enter a recipe name');
                return;
            }
            
            // Save to user-specific file
            const existingRecipes = loadInProgressRecipesFromFile();
            const existingIndex = existingRecipes.findIndex(r => r.id === recipeData.id);
            
            if (existingIndex !== -1) {
                // Update existing recipe
                existingRecipes[existingIndex] = { ...existingRecipes[existingIndex], ...recipeData };
            } else {
                // Add new recipe
                existingRecipes.push(recipeData);
            }
            
            // Save to user file (with localStorage fallback)
            let saveSuccess = false;
            
            try {
                saveSuccess = saveUserFile('recipes_in_progress.json', existingRecipes);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error saving to user file, using localStorage fallback:', error);
            }
            
            // Always save to localStorage as backup
            try {
                localStorage.setItem('recipes', JSON.stringify(existingRecipes));
                localStorage.setItem(`user_${currentUser?.id || 'guest'}_recipes_in_progress`, JSON.stringify(existingRecipes));
                console.log('‚úÖ Recipe saved to localStorage');
                saveSuccess = true; // Mark as successful if localStorage works
            } catch (error) {
                console.error('‚ùå Error saving to localStorage:', error);
            }
            
            if (saveSuccess) {
                // Update current recipe
                currentRecipeId = recipeData.id;
                currentRecipeData = recipeData;
                
                // Update status
                updateRecipeStatus('in-progress', 'Recipe Saved Successfully');
                
                // Save recipe history
                saveRecipeHistory(recipeData);
                
                // Refresh ideas list
                loadRecipeIdeasFromFiles();
                
                console.log('‚úÖ Recipe saved:', recipeData);
                
                // ‚úÖ NEW: Add to universal recipe library
                if (window.universalRecipeManager) {
                    window.universalRecipeManager.addToLibrary(recipeData, 'recipe-developer');
                    console.log('üìö Recipe added to universal library');
                }
                
                // Dispatch event for universal recipe manager
                window.dispatchEvent(new CustomEvent('recipeSaved', {
                    detail: {
                        recipe: recipeData,
                        source: 'recipe-developer'
                    }
                }));
                
                // Show success message with recipe details
                alert(`‚úÖ Recipe saved successfully!\n\nTitle: ${recipeData.title}\nIngredients: ${recipeData.ingredients.length}\nSteps: ${recipeData.instructions.length}\n\nüìö Added to Recipe Library!`);
            } else {
                console.error('‚ùå Failed to save recipe');
                alert('Failed to save recipe. Please check console for errors.');
            }
        }
        
        // Save recipe history for versioning
        function saveRecipeHistory(recipeData) {
            try {
                // Load existing history
                let recipeHistory = [];
                try {
                    const historyData = loadUserFile('recipe_history.json');
                    if (historyData) {
                        recipeHistory = JSON.parse(historyData);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load recipe history, starting fresh');
                }
                
                // Create history entry
                const historyEntry = {
                    recipeId: recipeData.id,
                    title: recipeData.title,
                    action: 'saved',
                    timestamp: new Date().toISOString(),
                    userId: currentUser?.id || 'guest',
                    userName: currentUser?.name || 'Guest User',
                    version: recipeData.version || 1,
                    changes: {
                        ingredients: recipeData.ingredients.length,
                        instructions: recipeData.instructions.length,
                        hasSketch: recipeData.sketchData.hasSketch,
                        hasNutrition: recipeData.nutritionData.calories !== '0'
                    }
                };
                
                // Add to history
                recipeHistory.push(historyEntry);
                
                // Keep only last 100 entries per recipe to prevent excessive storage
                const maxHistoryPerRecipe = 100;
                const recipeHistoryMap = new Map();
                recipeHistory.forEach(entry => {
                    if (!recipeHistoryMap.has(entry.recipeId)) {
                        recipeHistoryMap.set(entry.recipeId, []);
                    }
                    recipeHistoryMap.get(entry.recipeId).push(entry);
                });
                
                // Limit history per recipe
                recipeHistory = [];
                recipeHistoryMap.forEach((entries, recipeId) => {
                    const sortedEntries = entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    recipeHistory.push(...sortedEntries.slice(0, maxHistoryPerRecipe));
                });
                
                // Save history to user file
                const success = saveUserFile('recipe_history.json', recipeHistory);
                
                if (success) {
                    console.log('üìö Recipe history saved to user file');
                } else {
                    console.warn('‚ö†Ô∏è Failed to save recipe history to user file, using localStorage fallback');
                    localStorage.setItem(`user_${currentUser?.id || 'guest'}_recipe_history`, JSON.stringify(recipeHistory));
                }
                
            } catch (error) {
                console.error('‚ùå Error saving recipe history:', error);
            }
        }
        
        // Load in-progress recipes from user file
        function loadInProgressRecipesFromFile() {
            try {
                const recipesData = loadUserFile('recipes_in_progress.json');
                if (recipesData) {
                    return JSON.parse(recipesData);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load from user file, using empty array');
            }
            return [];
        }

        function collectIngredients() {
            const ingredients = [];
            const rows = document.querySelectorAll('.ingredient-row');
            
            rows.forEach(row => {
                // Get the ingredient select dropdown (first element)
                const ingredientSelect = row.querySelector('.ingredient-select');
                const inputs = row.querySelectorAll('input');
                const amountInput = inputs[0];
                const wasteInput = inputs[1] && inputs[1].type === 'number' && inputs[1].placeholder.includes('Waste') ? inputs[1] : null;
                const notesInput = inputs.find(inp => inp.type === 'text' && inp.placeholder && inp.placeholder.toLowerCase().includes('note'));
                const unitSelect = row.querySelectorAll('select')[1];
                
                if (ingredientSelect && ingredientSelect.value) {
                    // Get ingredient name from dropdown
                    const ingredientId = ingredientSelect.value;
                    const ingredientName = ingredientSelect.options[ingredientSelect.selectedIndex].text;
                    
                    // Phase 2: Get waste/trim percentage
                    const wastePercentage = wasteInput ? parseFloat(wasteInput.value) || 0 : 0;
                    
                    ingredients.push({
                        id: ingredientId,
                        name: ingredientName,
                        quantity: amountInput ? amountInput.value.trim() : '',
                        amount: amountInput ? amountInput.value.trim() : '', // Legacy support
                        unit: unitSelect ? unitSelect.value : '',
                        wastePercentage: wastePercentage, // Phase 2: Trim/Waste %
                        trimPercentage: wastePercentage, // Alias for compatibility
                        waste: wastePercentage, // Legacy support
                        notes: notesInput ? notesInput.value.trim() : ''
                    });
                }
            });
            
            return ingredients;
        }

        function collectInstructions() {
            const instructions = [];
            const steps = document.querySelectorAll('.instruction-step textarea');
            
            steps.forEach(step => {
                if (step.value.trim()) {
                    instructions.push(step.value.trim());
                }
            });
            
            return instructions;
        }

        // Export and other functions
        function exportRecipe() {
            console.log('üì§ Exporting recipe...');
            
            if (!currentRecipeData) {
                alert('No recipe to export. Please save a recipe first.');
                return;
            }
            
            // Create export data
            const exportData = {
                ...currentRecipeData,
                exportedAt: new Date().toISOString(),
                exportFormat: 'Iterum Recipe'
            };
            
            // Create downloadable file
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Create download link
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${currentRecipeData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_recipe.json`;
            link.click();
            
            console.log('‚úÖ Recipe exported as JSON file');
            alert('Recipe exported successfully!');
        }
        
                // Export all user data to computer files
        function exportAllUserData() {
            console.log('üì§ Exporting all user data...');
            
            if (!currentUser) {
                alert('No user logged in. Please log in to export data.');
                return;
            }
            
            try {
                // Get all user data from files
                const recipeIdeas = loadUserFile('recipe_ideas.json') ? JSON.parse(loadUserFile('recipe_ideas.json')) : [];
                const inProgressRecipes = loadInProgressRecipesFromFile();
                const sketchData = loadUserFile('sketch_data.json') ? JSON.parse(loadUserFile('sketch_data.json')) : [];
                const nutritionData = loadUserFile('nutrition_data.json') ? JSON.parse(loadUserFile('nutrition_data.json')) : [];
                const recipeHistory = loadUserFile('recipe_history.json') ? JSON.parse(loadUserFile('recipe_history.json')) : [];
                
                // Try to load additional data types if available
                let dailyNotes = [];
                let ingredients = [];
                let vendors = [];
                let menus = [];
                let calendarData = {};
                let haccpData = {};
                let inventory = [];
                let errors = [];
                
                if (window.userDataManager && window.userDataManager.isUserLoggedIn()) {
                    const userId = window.userDataManager.getCurrentUserId();
                    
                    // Load additional data types
                    dailyNotes = window.userDataManager.loadUserFile(`user_${userId}_daily_notes.json`) || [];
                    ingredients = window.userDataManager.loadUserFile(`user_${userId}_ingredients.json`) || [];
                    vendors = window.userDataManager.loadUserFile(`user_${userId}_vendors.json`) || [];
                    menus = window.userDataManager.loadUserFile(`user_${userId}_menus.json`) || [];
                    calendarData = {
                        journalEntries: window.userDataManager.loadUserFile(`user_${userId}_journal_entries.json`) || [],
                        recipeChanges: window.userDataManager.loadUserFile(`user_${userId}_recipe_changes.json`) || [],
                        maintenanceLog: window.userDataManager.loadUserFile(`user_${userId}_maintenance_log.json`) || []
                    };
                    haccpData = {
                        temperature: window.userDataManager.loadUserFile(`user_${userId}_haccp_temperature.json`) || [],
                        sanitizer: window.userDataManager.loadUserFile(`user_${userId}_haccp_sanitizer.json`) || [],
                        dishwasher: window.userDataManager.loadUserFile(`user_${userId}_haccp_dishwasher.json`) || []
                    };
                    inventory = window.userDataManager.loadUserFile(`user_${userId}_inventory.json`) || [];
                    errors = window.userDataManager.loadUserFile(`user_${userId}_errors.json`) || [];
                }
                
                // Create comprehensive user data package
                const userDataPackage = {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    exportedAt: new Date().toISOString(),
                    exportVersion: '3.0',
                    dataTypes: {
                        recipeIdeas: recipeIdeas.length,
                        inProgressRecipes: inProgressRecipes.length,
                        sketchData: sketchData.length,
                        nutritionData: nutritionData.length,
                        recipeHistory: recipeHistory.length,
                        dailyNotes: dailyNotes.length,
                        ingredients: ingredients.length,
                        vendors: vendors.length,
                        menus: menus.length,
                        calendarData: Object.values(calendarData).reduce((sum, arr) => sum + arr.length, 0),
                        haccpData: Object.values(haccpData).reduce((sum, arr) => sum + arr.length, 0),
                        inventory: inventory.length,
                        errors: errors.length
                    },
                    recipeIdeas: recipeIdeas,
                    inProgressRecipes: inProgressRecipes,
                    sketchData: sketchData,
                    nutritionData: nutritionData,
                    recipeHistory: recipeHistory,
                    dailyNotes: dailyNotes,
                    ingredients: ingredients,
                    vendors: vendors,
                    menus: menus,
                    calendarData: calendarData,
                    haccpData: haccpData,
                    inventory: inventory,
                    errors: errors,
                    metadata: {
                        totalDataSize: JSON.stringify(userDataPackage).length,
                        userCreatedAt: currentUser.createdAt || 'Unknown',
                        lastActivity: new Date().toISOString(),
                        systemInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language
                        }
                    }
                };
                
                // Create downloadable file
                const dataStr = JSON.stringify(userDataPackage, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `${currentUser.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_complete_culinary_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                console.log('‚úÖ Complete user data exported');
                alert(`Complete data exported for ${currentUser.name}! Includes all recipe data, daily notes, ingredients, vendors, menus, calendar events, HACCP data, inventory, and error logs.`);
                
            } catch (error) {
                console.error('‚ùå Error exporting user data:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        function calculateNutrition() {
            console.log('üßÆ Calculating nutrition...');
            
            // Collect ingredients for nutrition calculation
            const ingredients = collectIngredients();
            if (ingredients.length === 0) {
                alert('Please add ingredients before calculating nutrition.');
                return;
            }
            
            // Simple nutrition calculation (this would be enhanced with a real nutrition database)
            const nutritionData = {
                calories: ingredients.length * 150, // Placeholder calculation
                protein: ingredients.length * 8,
                carbs: ingredients.length * 20,
                fat: ingredients.length * 5,
                fiber: ingredients.length * 3,
                sugar: ingredients.length * 2,
                recipeId: currentRecipeId,
                userId: currentUser?.id || 'guest',
                userName: currentUser?.name || 'Guest User',
                calculatedAt: new Date().toISOString(),
                ingredients: ingredients
            };
            
            // Update nutrition display
            document.getElementById('calories').textContent = nutritionData.calories;
            document.getElementById('protein').textContent = nutritionData.protein + 'g';
            document.getElementById('carbs').textContent = nutritionData.carbs + 'g';
            document.getElementById('fat').textContent = nutritionData.fat + 'g';
            document.getElementById('fiber').textContent = nutritionData.fiber + 'g';
            document.getElementById('sugar').textContent = nutritionData.sugar + 'g';
            
            // Save nutrition data to user file
            const success = saveUserFile('nutrition_data.json', nutritionData);
            
            if (success) {
                console.log('üíæ Nutrition data saved to user file');
                alert('Nutrition calculated and saved!');
            } else {
                console.warn('‚ö†Ô∏è Failed to save nutrition data to user file, using localStorage fallback');
                localStorage.setItem(`user_${currentUser?.id || 'guest'}_nutrition_data`, JSON.stringify(nutritionData));
                alert('Nutrition calculated!');
            }
        }

        function previewRecipe() {
            console.log('üëÅÔ∏è Previewing recipe...');
            // Implementation for recipe preview
            alert('Preview functionality coming soon!');
        }

        function updateUserInfo() {
            const currentUser = window.userSystem?.getCurrentUser();
            if (currentUser) {
                document.getElementById('current-user').textContent = currentUser.name || 'User';
                document.getElementById('dropdown-user-name').textContent = currentUser.name || 'User';
                document.getElementById('user-avatar-initial').textContent = (currentUser.name || 'U')[0].toUpperCase();
                
                // Update sidebar user info
                updateSidebarUserInfo();
            }
        }
        
        function updateSidebarUserInfo() {
            const pathElement = document.getElementById('user-data-path');
            const nameElement = document.getElementById('sidebar-user-name');
            
            if (pathElement && nameElement && currentUser) {
                pathElement.textContent = userDataPath || 'Not set';
                nameElement.textContent = currentUser.name || 'Unknown User';
            }
        }

        function initializeProjectSelector() {
            // Project management now handled by new system
        }

        function getCurrentUserId() {
            const currentUser = window.userSystem?.getCurrentUser();
            return currentUser?.id || null;
        }
        
        // Recipe metadata helper functions
        function calculateRecipeComplexity() {
            const ingredients = collectIngredients();
            const instructions = collectInstructions();
            
            let complexity = 1; // Base complexity
            
            // Factor in number of ingredients
            if (ingredients.length > 10) complexity += 2;
            else if (ingredients.length > 5) complexity += 1;
            
            // Factor in number of instructions
            if (instructions.length > 8) complexity += 2;
            else if (instructions.length > 4) complexity += 1;
            
            // Factor in ingredient types (check for complex ingredients)
            const complexIngredients = ingredients.filter(ing => 
                ing.name.toLowerCase().includes('yeast') || 
                ing.name.toLowerCase().includes('dough') ||
                ing.name.toLowerCase().includes('sauce') ||
                ing.name.toLowerCase().includes('stock')
            );
            complexity += complexIngredients.length;
            
            return Math.min(complexity, 5); // Cap at 5
        }
        
        function estimatePrepTime() {
            const ingredients = collectIngredients();
            const instructions = collectInstructions();
            
            let baseTime = 15; // Base 15 minutes
            
            // Add time for each ingredient
            baseTime += ingredients.length * 2;
            
            // Add time for each instruction step
            baseTime += instructions.length * 3;
            
            // Add time for complex operations
            const complexOps = instructions.filter(step => 
                step.toLowerCase().includes('marinate') ||
                step.toLowerCase().includes('rest') ||
                step.toLowerCase().includes('chill') ||
                step.toLowerCase().includes('rise')
            );
            baseTime += complexOps.length * 10;
            
            return baseTime;
        }
        
        function generateRecipeTags() {
            const tags = [];
            const title = document.getElementById('recipe-name').value.toLowerCase();
            const category = document.getElementById('recipe-category').value;
            const cuisine = document.getElementById('recipe-cuisine').value;
            const ingredients = collectIngredients();
            
            // Add category tag
            if (category) tags.push(category);
            
            // Add cuisine tag
            if (cuisine) tags.push(cuisine);
            
            // Add ingredient-based tags
            ingredients.forEach(ingredient => {
                const name = ingredient.name.toLowerCase();
                if (name.includes('chicken')) tags.push('poultry');
                if (name.includes('beef') || name.includes('steak')) tags.push('beef');
                if (name.includes('fish') || name.includes('salmon')) tags.push('seafood');
                if (name.includes('vegetable') || name.includes('carrot')) tags.push('vegetarian');
                if (name.includes('spice') || name.includes('chili')) tags.push('spicy');
            });
            
            // Add complexity tag
            const complexity = calculateRecipeComplexity();
            if (complexity >= 4) tags.push('advanced');
            else if (complexity >= 2) tags.push('intermediate');
            else tags.push('beginner');
            
            // Remove duplicates
            return [...new Set(tags)];
        }

        // Recipe Development Functions
        // Open create ingredient modal
        let pendingIngredientSelect = null;
        
        function openCreateIngredientModal(selectElement = null) {
            pendingIngredientSelect = selectElement;
            
            const modal = document.createElement('div');
            modal.id = 'create-ingredient-modal';
            modal.className = 'modal-backdrop';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            modal.onclick = (e) => { if (e.target === modal) closeCreateIngredientModal(); };
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px; width: 90%;">
                    <div class="modal-header">
                        <h2>‚ú® Create New Ingredient</h2>
                    </div>
                    <div class="modal-body">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div>
                                <label class="form-label">Ingredient Name *</label>
                                <input type="text" id="new-ing-name" class="form-input" placeholder="e.g., Fresh Basil" required>
                            </div>
                            <div>
                                <label class="form-label">Category</label>
                                <select id="new-ing-category" class="form-select">
                                    <option value="Vegetables">Vegetables</option>
                                    <option value="Fruits">Fruits</option>
                                    <option value="Proteins">Proteins</option>
                                    <option value="Dairy">Dairy</option>
                                    <option value="Grains">Grains</option>
                                    <option value="Spices & Herbs">Spices & Herbs</option>
                                    <option value="Oils & Fats">Oils & Fats</option>
                                    <option value="Condiments">Condiments</option>
                                    <option value="Beverages">Beverages</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Common Units (comma-separated)</label>
                                <input type="text" id="new-ing-units" class="form-input" placeholder="e.g., g, kg, bunch, leaf">
                            </div>
                            <div>
                                <label class="form-label">Default Unit</label>
                                <input type="text" id="new-ing-default-unit" class="form-input" placeholder="e.g., g">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label class="form-label">Unit Size</label>
                                    <input type="text" id="new-ing-unit-size" class="form-input" placeholder="e.g., 1 lb, 500ml">
                                </div>
                                <div>
                                    <label class="form-label">Case Size</label>
                                    <input type="number" id="new-ing-case-size" class="form-input" placeholder="e.g., 12" min="1">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Notes (optional)</label>
                                <textarea id="new-ing-notes" class="form-input" rows="3" placeholder="Any additional information..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="saveNewIngredient()" class="btn btn-primary">üíæ Save Ingredient</button>
                        <button onclick="closeCreateIngredientModal()" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus on name input
            setTimeout(() => {
                document.getElementById('new-ing-name').focus();
            }, 100);
        }
        
        function closeCreateIngredientModal() {
            const modal = document.getElementById('create-ingredient-modal');
            if (modal) {
                modal.remove();
            }
            
            // Reset pending select if user canceled
            if (pendingIngredientSelect) {
                pendingIngredientSelect.value = '';
                pendingIngredientSelect = null;
            }
        }
        
        function saveNewIngredient() {
            const name = document.getElementById('new-ing-name').value.trim();
            const category = document.getElementById('new-ing-category').value;
            const units = document.getElementById('new-ing-units').value.trim();
            const defaultUnit = document.getElementById('new-ing-default-unit').value.trim();
            const unitSize = document.getElementById('new-ing-unit-size').value.trim();
            const caseSize = document.getElementById('new-ing-case-size').value.trim();
            const notes = document.getElementById('new-ing-notes').value.trim();
            
            if (!name) {
                alert('Please enter an ingredient name');
                return;
            }
            
            // Create new ingredient object
            const newIngredient = {
                id: 'ing_' + Date.now(),
                name: name,
                category: category,
                common_units: units ? units.split(',').map(u => u.trim()) : [],
                default_unit: defaultUnit || 'g',
                unit_size: unitSize || '',
                case_size: caseSize ? parseInt(caseSize) : null,
                notes: notes,
                createdAt: new Date().toISOString(),
                createdBy: 'user',
                userId: window.authManager?.currentUser?.uid || 'guest',
                userEmail: window.authManager?.currentUser?.email || 'guest'
            };
            
            // Add to available ingredients
            availableIngredients.push(newIngredient);
            
            // Save to localStorage - use BOTH keys for compatibility
            try {
                // Save to ingredients_database (primary)
                localStorage.setItem('ingredients_database', JSON.stringify(availableIngredients));
                
                // Also save to 'ingredients' for compatibility with ingredients page
                localStorage.setItem('ingredients', JSON.stringify(availableIngredients));
                
                console.log('‚úÖ Saved new ingredient:', name, newIngredient);
                console.log('üìä Total ingredients in database:', availableIngredients.length);
                
                // Trigger storage event for cross-component sync
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'ingredients_database',
                    newValue: JSON.stringify(availableIngredients),
                    url: window.location.href
                }));
                
                // Update all dropdowns
                populateIngredientDropdowns();
                
                // If triggered from a select, set the new ingredient as selected
                if (pendingIngredientSelect) {
                    pendingIngredientSelect.value = newIngredient.id;
                    pendingIngredientSelect = null;
                }
                
                // Close modal
                closeCreateIngredientModal();
                
                // Show success message with details
                let successMsg = `‚úÖ Ingredient "${name}" created successfully!`;
                if (unitSize) successMsg += `\nüì¶ Unit Size: ${unitSize}`;
                if (caseSize) successMsg += `\nüì¶ Case Size: ${caseSize} units`;
                alert(successMsg);
                
            } catch (error) {
                console.error('‚ùå Error saving ingredient:', error);
                alert('Error saving ingredient. Please try again.');
            }
        }
        
        function addIngredient() {
            const container = document.getElementById('ingredients-container');
            const index = container.querySelectorAll('.ingredient-row').length;
            
            const newRow = document.createElement('div');
            newRow.className = 'ingredient-row';
            newRow.setAttribute('data-ingredient-index', index);
            
            newRow.innerHTML = `
                <div id="ingredient-select-${index}" class="ingredient-select-container" style="flex: 2;"></div>
                <div id="ingredient-qty-unit-${index}" class="quantity-unit-container" style="display: flex; gap: 8px; flex: 1.5;"></div>
                <input type="number" class="form-input ingredient-waste" placeholder="Waste %" min="0" max="100" step="0.1" style="width: 90px;" title="Trim/Waste percentage">
                <input type="text" class="form-input ingredient-notes" placeholder="Notes" style="flex: 1;">
                <button class="btn btn-secondary" onclick="removeIngredient(this)">üóëÔ∏è</button>
            `;
            
            container.appendChild(newRow);
            
            // Initialize selector for new row
            if (window.ingredientSelector && window.ingredientSelector.initialized) {
                const selectContainer = newRow.querySelector('.ingredient-select-container');
                const qtyContainer = newRow.querySelector('.quantity-unit-container');
                
                // Create ingredient selector
                const selector = window.ingredientSelector.createSelector({
                    id: `ingredient-select-${index}`,
                    name: `ingredient_${index}`,
                    onSelect: (ingredient) => {
                        updateQuantityUnitSelector(index, ingredient);
                    }
                });
                selectContainer.appendChild(selector);
            } else {
                console.warn('‚ö†Ô∏è Ingredient selector not ready, using fallback');
                // Fallback to old dropdown
                const selectContainer = newRow.querySelector('.ingredient-select-container');
                selectContainer.innerHTML = `
                    <select class="form-select ingredient-select" onchange="handleIngredientSelect(this)">
                        <option value="">Select ingredient...</option>
                        ${getIngredientOptions()}
                    </select>
                `;
            }
        }
        
        // Component Recipes Management
        let componentRecipes = [];
        // Prep Items Management
        let prepItems = [];
        const PREP_QUEUE_KEY = 'prep_items_queue';
        let prepQueue = loadPrepQueue();
        
        function openAddComponentRecipeModal() {
            console.log('üîó Opening Add Component Recipe modal');
            
            // Load all available recipes
            let allRecipes = [];
            
            if (window.userDataManager) {
                allRecipes = window.userDataManager.loadData('recipes', { filterByProject: false });
            } else if (window.universalRecipeManager) {
                allRecipes = window.universalRecipeManager.getAllRecipes();
            } else {
                allRecipes = JSON.parse(localStorage.getItem('recipes') || '[]');
            }
            
            if (allRecipes.length === 0) {
                alert('No recipes available to link. Create some recipes first!');
                return;
            }
            
            // Get current recipe ID to avoid self-linking
            const currentRecipeId = localStorage.getItem('editing_recipe_id');
            
            // Filter out current recipe and already linked recipes
            const linkedIds = componentRecipes.map(r => r.id);
            const availableRecipes = allRecipes.filter(r => 
                r.id !== currentRecipeId && !linkedIds.includes(r.id)
            );
            
            if (availableRecipes.length === 0) {
                alert('No more recipes available to link!');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'add-component-modal';
            modal.className = 'modal-backdrop';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            modal.onclick = (e) => { if (e.target === modal) closeComponentModal(); };
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2>üîó Add Component Recipe</h2>
                    </div>
                    <div class="modal-body">
                        <p style="color: #64748b; margin-bottom: 20px;">Select a recipe to add as a component (e.g., a sauce, side dish, or sub-recipe)</p>
                        
                        <input type="text" id="component-search" class="form-input" placeholder="üîç Search recipes..." style="margin-bottom: 16px;" onkeyup="filterComponentRecipes()">
                        
                        <div id="component-recipes-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto;">
                            ${availableRecipes.map(recipe => `
                                <div class="component-recipe-option" data-recipe-id="${recipe.id}" onclick="selectComponentRecipe('${recipe.id}')" style="padding: 16px; background: linear-gradient(145deg, #4A4136 0%, #3D3729 100%); border: 2px solid #6B5D47; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 700; color: #F5F2EB; margin-bottom: 4px;">
                                                ${recipe.name || recipe.title}
                                            </div>
                                            <div style="font-size: 12px; color: #D8D4CC;">
                                                ${recipe.category || 'Uncategorized'} ‚Ä¢ ${recipe.cuisine || 'Unknown Cuisine'}
                                            </div>
                                            ${recipe.description ? `<div style="font-size: 13px; color: #C8C4BC; margin-top: 8px;">${recipe.description.substring(0, 100)}${recipe.description.length > 100 ? '...' : ''}</div>` : ''}
                                        </div>
                                        <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">Add</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeComponentModal()" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function filterComponentRecipes() {
            const search = document.getElementById('component-search').value.toLowerCase();
            const options = document.querySelectorAll('.component-recipe-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(search) ? 'block' : 'none';
            });
        }
        
        function selectComponentRecipe(recipeId) {
            console.log('üîó Selected component recipe:', recipeId);
            
            // Load recipe data
            let recipe = null;
            
            if (window.userDataManager) {
                const allRecipes = window.userDataManager.loadData('recipes', { filterByProject: false });
                recipe = allRecipes.find(r => r.id === recipeId);
            } else if (window.universalRecipeManager) {
                recipe = window.universalRecipeManager.getRecipe(recipeId);
            } else {
                const recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
                recipe = recipes.find(r => r.id === recipeId);
            }
            
            if (!recipe) {
                alert('Recipe not found!');
                return;
            }
            
            // Add to component recipes
            componentRecipes.push({
                id: recipe.id,
                name: recipe.name || recipe.title,
                description: recipe.description || '',
                category: recipe.category || 'Uncategorized'
            });
            
            // Update display
            displayComponentRecipes();
            
            // Close modal
            closeComponentModal();
            
            console.log('‚úÖ Component recipe added:', recipe.name || recipe.title);
        }
        
        function displayComponentRecipes() {
            const container = document.getElementById('component-recipes-container');
            
            if (componentRecipes.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">No component recipes added yet</div>';
                return;
            }
            
            container.innerHTML = componentRecipes.map((recipe, index) => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: linear-gradient(145deg, #3D3729 0%, #35301E 100%); border: 2px solid #6B5D47; border-radius: 10px;">
                    <div style="font-size: 24px;">üîó</div>
                    <div style="flex: 1;">
                        <div style="font-size: 15px; font-weight: 700; color: #F5F2EB; margin-bottom: 2px;">
                            ${recipe.name}
                        </div>
                        <div style="font-size: 12px; color: #D8D4CC;">
                            ${recipe.category} ${recipe.description ? `‚Ä¢ ${recipe.description.substring(0, 60)}...` : ''}
                        </div>
                    </div>
                    <button onclick="viewComponentRecipe('${recipe.id}')" class="btn" style="padding: 8px 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: 13px;">
                        üëÅÔ∏è View
                    </button>
                    <button onclick="removeComponentRecipe(${index})" class="btn btn-secondary" style="padding: 8px 12px; font-size: 13px;">
                        üóëÔ∏è Remove
                    </button>
                </div>
            `).join('');
        }
        
        function viewComponentRecipe(recipeId) {
            console.log('üëÅÔ∏è Viewing component recipe:', recipeId);
            window.open(`recipe-library.html?view=${recipeId}`, '_blank');
        }
        
        function removeComponentRecipe(index) {
            const recipe = componentRecipes[index];
            if (confirm(`Remove "${recipe.name}" from component recipes?`)) {
                componentRecipes.splice(index, 1);
                displayComponentRecipes();
                console.log('üóëÔ∏è Removed component recipe');
            }
        }
        
        function closeComponentModal() {
            const modal = document.getElementById('add-component-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Prep Items Management
        function loadPrepQueue() {
            try {
                const data = localStorage.getItem(PREP_QUEUE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.warn('‚ö†Ô∏è Unable to load prep queue:', error);
                return [];
            }
        }

        function savePrepQueue() {
            try {
                localStorage.setItem(PREP_QUEUE_KEY, JSON.stringify(prepQueue));
            } catch (error) {
                console.error('‚ùå Failed to save prep queue:', error);
            }
            renderPrepQueueSummary();
        }

        function renderPrepQueueSummary() {
            const summary = document.getElementById('prep-queue-summary');
            if (!summary) return;
            const pending = prepQueue.filter(item => item.status !== 'finished').length;
            summary.textContent = `Prep queue: ${pending} pending / ${prepQueue.length} total`;
        }

        function renderPrepItems() {
            const container = document.getElementById('prep-items-container');
            if (!container) return;

            if (!prepItems || prepItems.length === 0) {
                container.innerHTML = '<div style="padding:16px;border:1px dashed #6b5d47;border-radius:10px;color:#94a3b8;text-align:center;">No prep items tracked yet. Use "Add Prep Item" to create mise components.</div>';
                renderPrepQueueSummary();
                return;
            }

            container.innerHTML = prepItems.map((item, index) => `
                <div style="display:flex;flex-direction:column;gap:6px;padding:14px;border-radius:10px;border:2px solid #6B5D47;background:linear-gradient(145deg,#3D3729 0%,#35301E 100%);">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
                        <div>
                            <div style="font-size:15px;font-weight:700;color:#F5F2EB;">${item.name}</div>
                            ${item.description ? `<div style="font-size:13px;color:#C8C4BC;margin-top:4px;">${item.description}</div>` : ''}
                        </div>
                        <span class="status-badge ${item.status || 'needs-development'}">${formatPrepStatus(item.status)}</span>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="markPrepItemStatus(${index}, 'needs-development')">‚è≥ Needs Dev</button>
                        <button class="btn btn-secondary btn-sm" onclick="markPrepItemStatus(${index}, 'in-progress')">üë©‚Äçüç≥ In Progress</button>
                        <button class="btn btn-secondary btn-sm" onclick="markPrepItemStatus(${index}, 'finished')">‚úÖ Finished</button>
                        <button class="btn btn-primary btn-sm" onclick="convertPrepItemToRecipe(${index})">üßæ Create Prep Recipe</button>
                        <button class="btn btn-secondary btn-sm" onclick="removePrepItem(${index})">üóëÔ∏è Remove</button>
                    </div>
                    ${item.queueId ? `<div style="font-size:12px;color:#94a3b8;">In prep queue (#${item.queueId.slice(-4)})</div>` : ''}
                </div>
            `).join('');

            renderPrepQueueSummary();
        }

        function formatPrepStatus(status = 'needs-development') {
            switch (status) {
                case 'in-progress':
                    return 'In Progress';
                case 'finished':
                    return 'Finished';
                case 'queued':
                    return 'Queued';
                default:
                    return 'Needs Development';
            }
        }

        function openAddPrepItemModal() {
            const modal = document.createElement('div');
            modal.id = 'prep-item-modal';
            modal.className = 'modal-backdrop';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.onclick = (e) => { if (e.target === modal) closePrepItemModal(); };

            modal.innerHTML = `
                <div class="modal" style="max-width:520px;width:90%;padding:0;">
                    <div class="modal-header">
                        <h2>üß∫ Add Prep Item</h2>
                    </div>
                    <div class="modal-body" style="display:flex;flex-direction:column;gap:16px;">
                        <div class="form-group">
                            <label class="form-label">Prep Item Name</label>
                            <input type="text" id="prep-item-name" class="form-input" placeholder="e.g., Celery Salt Cure" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes / Purpose</label>
                            <textarea id="prep-item-notes" class="form-textarea" placeholder="Describe what needs to be developed..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="prep-item-status" class="form-select">
                                <option value="needs-development">Needs Development</option>
                                <option value="in-progress">In Progress</option>
                                <option value="finished">Finished</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closePrepItemModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="addPrepItem()">Add Prep Item</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closePrepItemModal() {
            const modal = document.getElementById('prep-item-modal');
            if (modal) modal.remove();
        }

        function addPrepItem() {
            const name = document.getElementById('prep-item-name')?.value.trim();
            const description = document.getElementById('prep-item-notes')?.value.trim();
            const status = document.getElementById('prep-item-status')?.value || 'needs-development';

            if (!name) {
                alert('Please enter a prep item name');
                return;
            }

            prepItems.push({
                id: `prep_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
                name,
                description,
                status,
                createdAt: new Date().toISOString()
            });

            closePrepItemModal();
            renderPrepItems();
        }

        function removePrepItem(index) {
            if (!prepItems[index]) return;
            if (!confirm(`Remove prep item "${prepItems[index].name}"?`)) return;
            prepItems.splice(index, 1);
            renderPrepItems();
        }

        function markPrepItemStatus(index, status) {
            if (!prepItems[index]) return;
            prepItems[index].status = status;
            renderPrepItems();
        }

        function convertPrepItemToRecipe(index) {
            const prepItem = prepItems[index];
            if (!prepItem) return;

            if (prepItem.status === 'finished') {
                alert('This prep item is already marked as finished.');
                return;
            }

            const stub = {
                id: prepItem.stubId || `prep_recipe_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`,
                title: prepItem.name,
                description: prepItem.description || `Prep component for ${currentRecipeData?.title || document.getElementById('recipe-name')?.value || 'recipe'}`,
                category: 'prep-recipe',
                type: 'prep-recipe',
                tags: ['prep-item', 'component'],
                status: 'needs-development',
                parentRecipeId: currentRecipeId,
                ingredients: [],
                instructions: [],
                servings: 1,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (window.universalRecipeManager) {
                window.universalRecipeManager.addToLibrary(stub, 'prep-item');
            } else {
                const allRecipes = JSON.parse(localStorage.getItem('recipes') || '[]');
                allRecipes.push(stub);
                localStorage.setItem('recipes', JSON.stringify(allRecipes));
            }

            prepItem.status = 'queued';
            prepItem.stubId = stub.id;

            prepQueue.push({
                queueId: stub.id,
                name: stub.title,
                status: 'needs-development',
                parentRecipeId: currentRecipeId,
                createdAt: new Date().toISOString()
            });

            savePrepQueue();
            renderPrepItems();

            alert(`Prep recipe stub created for "${prepItem.name}" and added to the prep queue.`);
        }

        function showPrepQueueModal() {
            const modal = document.createElement('div');
            modal.id = 'prep-queue-modal';
            modal.className = 'modal-backdrop';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.onclick = (e) => { if (e.target === modal) closePrepQueueModal(); };

            const queueContent = prepQueue.length
                ? prepQueue.map(item => `
                    <div style="padding:14px;border-radius:10px;border:1px solid #6B5D47;background:rgba(0,0,0,0.2);display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:600;color:#F5F2EB;">${item.name}</div>
                            <div style="font-size:12px;color:#94a3b8;">${formatPrepStatus(item.status)} ‚Ä¢ ${new Date(item.createdAt).toLocaleDateString()}</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="updatePrepQueueStatus('${item.queueId}', 'finished')">‚úÖ Mark Done</button>
                    </div>
                `).join('')
                : '<div style="padding:20px;text-align:center;color:#94a3b8;">No prep items queued.</div>';

            modal.innerHTML = `
                <div class="modal" style="max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
                    <div class="modal-header">
                        <h2>üìã Prep Queue</h2>
                    </div>
                    <div class="modal-body" style="display:flex;flex-direction:column;gap:12px;">
                        ${queueContent}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closePrepQueueModal()">Close</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function updatePrepQueueStatus(queueId, status) {
            const entry = prepQueue.find(item => item.queueId === queueId);
            if (entry) {
                entry.status = status;
                savePrepQueue();
                renderPrepItems();
                showNotification(`Prep item "${entry.name}" marked as ${formatPrepStatus(status)}.`, 'info');
                closePrepQueueModal();
                showPrepQueueModal(); // re-render modal
            }
        }

        function closePrepQueueModal() {
            const modal = document.getElementById('prep-queue-modal');
            if (modal) modal.remove();
        }

        function removeIngredient(button) {
            button.closest('.ingredient-row').remove();
        }

        function addInstruction() {
            const container = document.getElementById('instructions-container');
            const stepCount = container.children.length + 1;
            const newStep = document.createElement('div');
            newStep.className = 'instruction-step';
            newStep.innerHTML = `
                <div class="step-number">${stepCount}</div>
                <textarea class="form-textarea" placeholder="Describe this step..."></textarea>
            `;
            container.appendChild(newStep);
        }

        // Placeholder functions (real implementations exist elsewhere in the file)
        function exportRecipe() {
            console.log('üì§ Exporting recipe...');
            if (!currentRecipeData) {
                alert('Please save the recipe first before exporting.');
                return;
            }
            // Export logic handled by the main exportRecipe function
        }

        function calculateNutrition() {
            console.log('üßÆ Calculating nutrition...');
            alert('Nutrition calculation feature coming soon!');
        }

        function previewRecipe() {
            console.log('üëÅÔ∏è Previewing recipe...');
            alert('Recipe preview feature coming soon!');
        }

        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab) {
                dropdown.classList.toggle('active');
                userTab.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab && !userTab.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
                userTab.classList.remove('active');
            }
        });

        // Toggle mobile navigation
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobile-nav');
            if (mobileNav) {
                mobileNav.classList.toggle('active');
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobile-nav');
            const mobileToggle = document.querySelector('.header-mobile-toggle');
            
            if (mobileNav && mobileToggle && !mobileToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });

        // Manual refresh function for debugging
        function refreshRecipeIdeasOnDeveloperPage() {
            console.log('üîÑ Manually refreshing recipe ideas on developer page...');
            loadRecipeIdeasFromFiles();
        }
        
        // Manual import function to get ideas from main page
        function importFromMainPage() {
            console.log('üì• Manually importing ideas from main page...');
            
            try {
                // Try to get ideas from main page localStorage
                const mainPageIdeas = JSON.parse(localStorage.getItem('recipe_ideas') || '[]');
                console.log('üì• Found', mainPageIdeas.length, 'ideas on main page');
                
                if (mainPageIdeas.length > 0) {
                    // Save these ideas to the current project
                    if (window.projectManager && window.projectManager.getCurrentProject()) {
                        const projectKey = window.projectManager.getProjectStorageKey('recipe_ideas');
                        localStorage.setItem(projectKey, JSON.stringify(mainPageIdeas));
                        console.log('üíæ Saved ideas to project:', projectKey);
                        
                        // Reload the ideas display
                        loadRecipeIdeasFromFiles();
                        
                        alert(`Successfully imported ${mainPageIdeas.length} ideas from main page!`);
                    } else {
                        alert('No current project selected. Please select a project first.');
                    }
                } else {
                    alert('No ideas found on main page. Create some ideas first!');
                }
            } catch (error) {
                console.error('‚ùå Error importing ideas:', error);
                alert('Error importing ideas: ' + error.message);
            }
        }
        
        // Make functions globally available for debugging
        window.refreshRecipeIdeasOnDeveloperPage = refreshRecipeIdeasOnDeveloperPage;
        window.importFromMainPage = importFromMainPage;
        
        // Canvas status check function
        function checkCanvasStatus() {
            const status = {
                canvasElement: !!sketchCanvas,
                canvasContext: !!sketchCtx,
                canvasSize: sketchCanvas ? `${sketchCanvas.width}x${sketchCanvas.height}` : 'N/A',
                canvasStyle: sketchCanvas ? {
                    pointerEvents: sketchCanvas.style.pointerEvents,
                    cursor: sketchCanvas.style.cursor,
                    display: sketchCanvas.style.display,
                    visibility: sketchCanvas.style.visibility
                } : 'N/A',
                isDrawing: isDrawing,
                currentTool: currentSketchTool,
                currentColor: currentSketchColor,
                containerSize: sketchCanvas ? {
                    containerWidth: sketchCanvas.parentElement.clientWidth,
                    containerHeight: sketchCanvas.parentElement.clientHeight,
                    rectWidth: sketchCanvas.parentElement.getBoundingClientRect().width,
                    rectHeight: sketchCanvas.parentElement.getBoundingClientRect().height
                } : 'N/A'
            };
            
            console.log('üé® Canvas Status:', status);
            
            if (!sketchCanvas) {
                alert('Canvas element not found. Please click "üé® Init Canvas" button.');
            } else if (!sketchCtx) {
                alert('Canvas context not available. Please click "üé® Init Canvas" button.');
            } else {
                alert(`Canvas is working!\n\nSize: ${status.canvasSize}\nTool: ${status.currentTool}\nColor: ${status.currentColor}\n\nTry clicking and dragging on the canvas to draw!`);
            }
            
            return status;
        }
        
        // Make canvas status check globally available
        window.checkCanvasStatus = checkCanvasStatus;
        
        // Force reinitialize canvas function
        function forceReinitializeCanvas() {
            console.log('üîÑ Force reinitializing canvas...');
            
            // Clear any existing canvas
            if (sketchCanvas) {
                sketchCanvas.width = 0;
                sketchCanvas.height = 0;
            }
            
            // Reset variables
            sketchCanvas = null;
            sketchCtx = null;
            isDrawing = false;
            
            // Wait a moment then reinitialize
            setTimeout(() => {
                initializeSketchCanvas();
            }, 100);
        }
        
        // Make force reinitialize globally available
        window.forceReinitializeCanvas = forceReinitializeCanvas;
    </script>

    <!-- Initialize Unified Authentication System -->
    <script>
      // Initialize authentication system when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM loaded, initializing authentication system...');
        
        // Wait a moment for all scripts to load
        setTimeout(() => {
          if (typeof UnifiedAuthSystem !== 'undefined') {
            console.log('‚úÖ UnifiedAuthSystem class found, creating instance...');
            window.unifiedAuthSystem = new UnifiedAuthSystem();
            window.unifiedAuth = window.unifiedAuthSystem; // Alias for onclick handlers
            console.log('‚úÖ Authentication system initialized');
          } else {
            console.error('‚ùå UnifiedAuthSystem class not found');
          }
          
          // Initialize page protection if available
          if (typeof PageProtection !== 'undefined') {
            console.log('‚úÖ PageProtection class found, creating instance...');
            window.pageProtection = new PageProtection();
            console.log('‚úÖ Page protection system initialized');
          } else {
            console.warn('‚ö†Ô∏è PageProtection class not found');
          }
        }, 100);
      });
    </script>
    
    <!-- Load Firebase Modules -->
    <script type="module" src="assets/js/firebase-auth.js"></script>
    <script type="module" src="assets/js/firebase-auth-ui.js"></script>
    <script type="module" src="assets/js/firestore-sync.js"></script>
    
    <!-- Load User Display -->
    <script src="assets/js/header-user-display.js"></script>
    
    <!-- Load Profile Editor -->
    <script src="assets/js/profile-editor.js"></script>
    
    <!-- Load Email Verification Banner -->
    <script src="assets/js/email-verification-banner.js"></script>
    
    <!-- Base Ingredients Loader - Auto-imports ingredients -->
    <script src="assets/js/base-ingredients-loader.js"></script>
    
    <!-- Enhanced Ingredients Manager -->
    <script src="assets/js/ingredients-manager-enhanced.js"></script>
    
    <!-- Unit Converter -->
    <script src="assets/js/unit-converter.js"></script>
    
    <!-- Vendor Price Comparator -->
    <script src="assets/js/vendor-price-comparator.js"></script>
    
    <!-- Integrated Ingredient Selector -->
    <script src="assets/js/ingredient-selector-integrated.js"></script>
    
    <!-- Enhanced Recipe Cost Integration -->
    <script src="assets/js/recipe-cost-integration-enhanced.js"></script>
    
    <!-- Universal Recipe Manager - Ensures all recipes go to library -->
    <script src="assets/js/universal-recipe-manager.js"></script>
    
    <!-- Secure Storage Manager - Fast & Secure IndexedDB storage -->
    <script src="assets/js/secure-storage-manager.js"></script>
    
    <!-- Equipment Manager - Equipment management & linking -->
    <script src="assets/js/equipment-manager.js"></script>
    
    <!-- Central Data Loader -->
    <script src="assets/js/central-data-loader.js"></script>
    
    <!-- State Persistence Manager -->
    <script src="assets/js/state-persistence-manager.js"></script>
    
    <!-- Recipe Developer Enhancements - Autosave, validation, UX improvements -->
    <script src="assets/js/recipe-developer-enhancements.js"></script>
</body>
</html>

