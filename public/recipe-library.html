<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Library - Iterum R&D Chef Notebook</title>
    
    <!-- Auth System (v2.0) -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-manager.js"></script>
    <script src="assets/js/auth-api-helper.js"></script>
    <script src="assets/js/auth-diagnostics.js"></script>
    <script src="assets/js/auth_guard.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shadows+Into+Light:wght@400&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- UNIFIED COLOR SYSTEM - MUST LOAD FIRST -->
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/modal-high-contrast.css">
    <link rel="stylesheet" href="assets/css/tailwind-output.css">
    <link rel="stylesheet" href="assets/css/iterum-design-system.css">
    <link rel="stylesheet" href="assets/css/premium-ui-system.css">
    <link rel="stylesheet" href="assets/css/unified-cards.css">
    <link rel="stylesheet" href="assets/css/page-layouts.css">
    <link rel="stylesheet" href="assets/css/high-contrast-universal.css">
    <link rel="stylesheet" href="assets/css/nordic-design-system.css">
    <link rel="stylesheet" href="assets/css/modern-nordic-vintage.css">
    <link rel="stylesheet" href="assets/css/dark-mode-enhancements.css">
    <link rel="stylesheet" href="assets/css/ui-polish.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/iterum.ico">
    
    
    <!-- Load Enhanced User Management System -->
    <!-- Enhanced User Management now handled by Firebase Auth -->
    
    <!-- Project management now handled by new system -->
    <script src="assets/js/error_handler.js"></script>
    <script src="assets/js/project-management-system.js"></script>
    
    <!-- State Persistence & Recipe Management -->
    <script src="assets/js/state-persistence-manager.js"></script>
    <script src="assets/js/universal-recipe-manager.js"></script>
    <script src="assets/js/user-data-isolator.js"></script>
    
    <!-- Unified Navigation -->
    <script src="assets/js/unified-nav-header.js" defer></script>
    <script src="assets/js/unified-project-selector.js" defer></script>
    <script src="assets/js/recipe-viewer.js"></script>
    
    <style>
        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Recipe Library Specific Styles */
        .recipe-filters {
            background: var(--brand-card-bg);
            padding: var(--spacing-6);
            border-radius: var(--radius-lg);
            border: 1px solid var(--brand-border-light);
            margin-bottom: var(--spacing-6);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-4);
        }
        
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-8);
        }
        
        .recipe-card {
            background: var(--brand-card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--brand-border-light);
            overflow: hidden;
            transition: all var(--transition-normal);
        }
        
        .recipe-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--brand-border-medium);
        }
        
        .recipe-card-header {
            background: var(--brand-btn-primary);
            color: #ffffff;
            padding: var(--spacing-4);
        }
        
        .recipe-card-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-2);
        }
        
        .recipe-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }
        
        .recipe-card-body {
            padding: var(--spacing-4);
        }
        
        .recipe-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--brand-text-primary);
        }
        
        .info-label {
            font-size: var(--font-size-sm);
            color: var(--brand-text-tertiary);
        }
        
        .recipe-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .recipe-description {
            color: var(--brand-text-secondary);
            margin-bottom: var(--spacing-4);
            line-height: var(--line-height-relaxed);
        }
        
        .recipe-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }
        
        .recipe-tag {
            background: var(--brand-card-bg-subtle);
            color: var(--brand-text-tertiary);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            border: 1px solid var(--brand-border-light);
        }
        
        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .recipe-grid {
                grid-template-columns: 1fr;
            }
            
            .recipe-info {
                grid-template-columns: 1fr;
            }
            
            .recipe-actions {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="assets/css/iterum-brand-kit.css">
    <link rel="stylesheet" href="assets/css/header-universal.css">
</head>
<body class="bg-gray-50 min-h-screen" style="padding-top: 80px;">
    <!-- Uniform Centered Header -->
    <!-- Header injected by unified-nav-header.js -->

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="page-header">
                <h1 class="heading-1">Recipe Library</h1>
                <p class="body-large">Browse, search, and manage your complete recipe collection with advanced filtering and organization tools.</p>
            </div>

            <!-- Recipe Filters -->
            <div class="recipe-filters">
                <h2 class="heading-2">Search & Filter Recipes</h2>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="search-query" class="form-label">Search</label>
                        <input type="text" id="search-query" class="form-input" placeholder="Search recipes...">
                    </div>
                    <div class="form-group">
                        <label for="filter-category" class="form-label">Category</label>
                        <select id="filter-category" class="form-select">
                            <option value="">All Categories</option>
                            <option value="appetizer">Appetizer</option>
                            <option value="main-course">Main Course</option>
                            <option value="dessert">Dessert</option>
                            <option value="beverage">Beverage</option>
                            <option value="sauce">Sauce</option>
                            <option value="prep-recipe">Prep Recipe</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-cuisine" class="form-label">Cuisine</label>
                        <select id="filter-cuisine" class="form-select">
                            <option value="">All Cuisines</option>
                            <option value="italian">Italian</option>
                            <option value="french">French</option>
                            <option value="asian">Asian</option>
                            <option value="mediterranean">Mediterranean</option>
                            <option value="american">American</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-difficulty" class="form-label">Difficulty</label>
                        <select id="filter-difficulty" class="form-select">
                            <option value="">All Levels</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="form-group">
                        <label for="filter-time" class="form-label">Prep Time</label>
                        <select id="filter-time" class="form-select">
                            <option value="">Any Time</option>
                            <option value="quick">Quick (< 30 min)</option>
                            <option value="medium">Medium (30-60 min)</option>
                            <option value="long">Long (> 60 min)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-servings" class="form-label">Servings</label>
                        <select id="filter-servings" class="form-select">
                            <option value="">Any</option>
                            <option value="1-2">1-2 people</option>
                            <option value="3-4">3-4 people</option>
                            <option value="5-6">5-6 people</option>
                            <option value="7+">7+ people</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sort-by" class="form-label">Sort By</label>
                        <select id="sort-by" class="form-select">
                            <option value="name">Name</option>
                            <option value="date-added">Date Added</option>
                            <option value="difficulty">Difficulty</option>
                            <option value="prep-time">Prep Time</option>
                            <option value="rating">Rating</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="searchRecipes()">üîç Search</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                    <button class="btn btn-secondary" onclick="exportRecipes()">üì§ Export</button>
                </div>
            </div>

            <!-- Recipes Grid -->
            <div id="recipes-container">
                <div class="recipe-grid" id="recipes-grid">
                    <!-- Recipes will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Essential Scripts -->
    <script>
        // Force load recipes when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üìñ Page visible, reloading recipes...');
                setTimeout(() => loadRecipes(), 200);
            }
        });
        
        // Force load on page show (back/forward navigation)
        window.addEventListener('pageshow', function(event) {
            console.log('üìñ Page shown, reloading recipes...');
            setTimeout(() => loadRecipes(), 200);
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initializing Recipe Library Page');
            
            // Wait for authentication system to be ready
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Ensure unified auth system is initialized and user state is maintained
            if (window.unifiedAuth) {
                console.log('üîê Unified auth system found, checking user state...');
                
                // Check if there's a current user session
                const currentUser = localStorage.getItem('current_user');
                const sessionActive = localStorage.getItem('session_active');
                
                if (currentUser && sessionActive === 'true') {
                    try {
                        const user = JSON.parse(currentUser);
                        console.log('‚úÖ User session found:', user.name);
                        
                        // Update the header display with current user
                        updateHeaderUserDisplay(user);
                        
                        // Ensure unified auth system has the current user
                        window.unifiedAuth.currentUser = user;
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error parsing current user:', error);
                    }
                } else {
                    console.log('‚ö†Ô∏è No active user session found');
                }
            } else {
                console.warn('‚ö†Ô∏è Unified auth system not available');
            }
            
            // Initialize header user synchronization
            if (window.HeaderUserSync) {
                try {
                    const headerSync = new window.HeaderUserSync();
                    headerSync.initialize();
                    console.log('‚úÖ Header user synchronization initialized');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Header user sync initialization failed:', error);
                }
            }
            
            console.log('‚úÖ Recipe Library Page initialized');
        });

        // Wait for app to be ready
        document.addEventListener('iterumAppReady', function() {
            initializeRecipeLibrary();
            updateUserInfo();
            initializeProjectSelector();
        });

        // Wait for loading screen to be hidden
        document.addEventListener('loadingScreenHidden', function() {
            initializeRecipeLibrary();
            updateUserInfo();
            initializeProjectSelector();
        });

        async function initializeRecipeLibrary() {
            console.log('üìö Initializing Recipe Library');
            
            // Wait for data managers to be ready
            await waitForDataManagers();
            
            // Auto-load recipes from file for current user
            await autoLoadUserRecipes();
            
            // Load recipes immediately
            loadRecipes();
            setupEventListeners();
            
            // Listen for recipe library updates from any source
            window.addEventListener('recipeLibraryUpdated', function(event) {
                console.log('üîÑ Recipe library updated, reloading...');
                loadRecipes();
            });
            
            // Listen for recipe saved events
            window.addEventListener('recipeSaved', function(event) {
                console.log('üîÑ Recipe saved event received, reloading...');
                setTimeout(() => loadRecipes(), 100);
            });
            
            // Listen for data manager ready
            window.addEventListener('userDataManagerReady', function() {
                console.log('üíæ User Data Manager ready, reloading recipes...');
                setTimeout(() => loadRecipes(), 100);
            });
            
            // Listen for cloud sync complete
            window.addEventListener('cloudSyncComplete', function() {
                console.log('‚òÅÔ∏è Cloud sync complete, reloading recipes...');
                setTimeout(() => loadRecipes(), 500);
            });
        }
        
        async function waitForDataManagers() {
            console.log('‚è≥ Waiting for data managers...');
            
            let attempts = 0;
            const maxAttempts = 50; // 10 seconds max
            
            while (attempts < maxAttempts) {
                if (window.authManager?.currentUser) {
                    console.log('‚úÖ Auth manager ready');
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
            
            console.log('‚úÖ Data managers ready');
        }
        
        async function autoLoadUserRecipes() {
            console.log('üöÄ Auto-loading user recipes...');
            
            // Check if user is chefmcpherson@gmail.com
            const user = window.authManager?.currentUser;
            
            if (user && user.email === 'chefmcpherson@gmail.com') {
                try {
                    console.log('üë®‚Äçüç≥ Loading 89 Charles recipes...');
                    
                    // Load recipes from JSON file
                    const response = await fetch('89-charles-recipes.json');
                    if (response.ok) {
                        const recipes = await response.json();
                        console.log(`üì¶ Found ${recipes.length} 89 Charles recipes`);
                        
                        // Add to universal recipe manager
                        recipes.forEach(recipe => {
                            if (window.universalRecipeManager) {
                                window.universalRecipeManager.addToLibrary(recipe);
                            }
                        });
                        
                        console.log(`‚úÖ Loaded ${recipes.length} recipes into library`);
                    }
                } catch (error) {
                    console.log('‚ÑπÔ∏è 89 Charles recipes file not found or already loaded');
                }
            }
        }

        function updateUserInfo() {
            const currentUser = window.userSystem?.getCurrentUser();
            if (currentUser) {
                document.getElementById('current-user').textContent = currentUser.name || 'User';
                document.getElementById('dropdown-user-name').textContent = currentUser.name || 'User';
                document.getElementById('user-avatar-initial').textContent = (currentUser.name || 'U')[0].toUpperCase();
            }
        }

        function initializeProjectSelector() {
            if (window.projectManager) {
                window.projectManager.loadUserProjects();
            }
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('search-query').addEventListener('input', function() {
                searchRecipes();
            });

            // Filter changes
            document.getElementById('filter-category').addEventListener('change', searchRecipes);
            document.getElementById('filter-cuisine').addEventListener('change', searchRecipes);
            document.getElementById('filter-difficulty').addEventListener('change', searchRecipes);
            document.getElementById('filter-time').addEventListener('change', searchRecipes);
            document.getElementById('filter-servings').addEventListener('change', searchRecipes);
            document.getElementById('sort-by').addEventListener('change', searchRecipes);
        }

        function loadRecipes() {
            console.log('üìö ========== LOADING RECIPES ==========');
            
            // Show loading state
            const grid = document.getElementById('recipes-grid');
            if (grid) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; grid-column: 1/-1;">
                        <div style="width: 60px; height: 60px; border: 4px solid #e5e7eb; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p style="color: #64748b; font-weight: 600;">Loading recipes...</p>
                    </div>
                `;
            }
            
            let recipes = [];
            
            // Use new User Data Manager if available (handles filtering automatically)
            if (window.userDataManager) {
                recipes = window.userDataManager.loadData('recipes');
                console.log(`üìä Loaded ${recipes.length} recipes from User Data Manager`);
            } else if (window.universalRecipeManager) {
                // Fallback to universal recipe manager with manual filtering
                recipes = window.universalRecipeManager.getAllRecipes();
                
                // Get current project
                const user = window.authManager?.currentUser;
                const userId = user?.userId || user?.id;
                let currentProjectId = 'master';
                
                if (window.unifiedProjectSelector) {
                    currentProjectId = window.unifiedProjectSelector.currentProjectId;
                } else if (window.projectManager?.currentProject) {
                    currentProjectId = window.projectManager.currentProject.id;
                } else {
                    const storedProjectId = localStorage.getItem(`iterum_current_project_user_${userId}`) ||
                                           localStorage.getItem('iterum_current_project');
                    if (storedProjectId) currentProjectId = storedProjectId;
                }
                
                // Filter by user
                recipes = recipes.filter(r => !r.userId || r.userId === userId);
                
                // Filter by project (unless master)
                if (currentProjectId !== 'master') {
                    const beforeFilter = recipes.length;
                    recipes = recipes.filter(recipe => 
                        !recipe.projectId || 
                        recipe.projectId === currentProjectId || 
                        recipe.project === currentProjectId
                    );
                    console.log(`üìä Filtered to ${recipes.length} recipes for project "${currentProjectId}" (from ${beforeFilter})`);
                } else {
                    console.log(`üìä Showing all ${recipes.length} recipes (Master Project)`);
                }
            } else {
                // Last resort fallback
                recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
                console.log(`üì¶ Fallback: Loaded ${recipes.length} recipes from localStorage`);
            }
            
            displayRecipes(recipes);
        }

        function displayRecipes(recipes) {
            const grid = document.getElementById('recipes-grid');
            
            if (!recipes || recipes.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; grid-column: 1/-1;">
                        <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">üìñ</div>
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 10px;">No Recipes Found</h3>
                        <p style="color: #64748b; margin-bottom: 25px;">Start creating recipes to build your collection</p>
                        <a href="recipe-developer.html" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; text-decoration: none;">
                            üß™ Create First Recipe
                        </a>
                    </div>
                `;
                console.log('üìä No recipes to display');
                return;
            }

            console.log(`üìä Displaying ${recipes.length} recipes`);
            grid.innerHTML = '';
            
            recipes.forEach((recipe, index) => {
                const card = createRecipeCard(recipe);
                grid.appendChild(card);
            });
            
            console.log(`‚úÖ ${recipes.length} recipe cards rendered`);
        }

        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card';
            
            // Get primary photo if available
            const primaryPhoto = window.recipePhotoManager ? window.recipePhotoManager.getPrimaryPhoto(recipe.id) : null;
            const photoHTML = primaryPhoto ? `
                <div class="recipe-card-photo" style="position: relative; height: 200px; overflow: hidden; border-radius: 12px 12px 0 0; margin: -16px -16px 16px -16px;">
                    <img src="${primaryPhoto.data || primaryPhoto.firebaseUrl}" alt="${recipe.name}" 
                         style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;"
                         onmouseover="this.style.transform='scale(1.05)'"
                         onmouseout="this.style.transform='scale(1)'">
                    <div style="position: absolute; top: 12px; right: 12px; background: rgba(102, 126, 234, 0.95); color: white; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        üì∏ ${window.recipePhotoManager.getRecipePhotos(recipe.id).length}
                    </div>
                </div>
            ` : '';
            
            card.innerHTML = `
                ${photoHTML}
                <div class="recipe-card-header">
                    <div class="recipe-card-title">${recipe.name || 'Untitled Recipe'}</div>
                    <div class="recipe-card-meta">
                        <span>${recipe.category || 'Uncategorized'}</span>
                        <span>${recipe.difficulty || 'Medium'}</span>
                    </div>
                </div>
                <div class="recipe-card-body">
                    <div class="recipe-description">${recipe.description || 'No description available.'}</div>
                    
                    <div class="recipe-tags">
                        ${(recipe.tags || []).map(tag => `<span class="recipe-tag">${tag}</span>`).join('')}
                    </div>
                    
                    <div class="recipe-info">
                        <div class="info-item">
                            <div class="info-value">${recipe.prepTime || '0'}</div>
                            <div class="info-label">Prep Time</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value">${recipe.servings || '0'}</div>
                            <div class="info-label">Servings</div>
                        </div>
                    </div>
                    
                    <div class="recipe-actions">
                        <button class="btn btn-primary" onclick="viewRecipe('${recipe.id}')">üëÅÔ∏è View</button>
                        <button class="btn btn-secondary" onclick="editRecipe('${recipe.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-secondary" onclick="duplicateRecipe('${recipe.id}')">üìã Copy</button>
                        <button class="btn btn-secondary danger" onclick="deleteRecipe('${recipe.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            return card;
        }

        function searchRecipes() {
            const query = document.getElementById('search-query').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            const cuisine = document.getElementById('filter-cuisine').value;
            const difficulty = document.getElementById('filter-difficulty').value;
            const time = document.getElementById('filter-time').value;
            const servings = document.getElementById('filter-servings').value;
            const sortBy = document.getElementById('sort-by').value;

            // Load from universal recipe manager (all sources)
            let recipes = [];
            if (window.universalRecipeManager) {
                recipes = window.universalRecipeManager.getAllRecipes();
            } else {
                recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
            }

            // Filter
            recipes = recipes.filter(recipe => {
                const matchesQuery = !query || recipe.name.toLowerCase().includes(query) || 
                                   (recipe.description && recipe.description.toLowerCase().includes(query));
                const matchesCategory = !category || recipe.category === category;
                const matchesCuisine = !cuisine || recipe.cuisine === cuisine;
                const matchesDifficulty = !difficulty || recipe.difficulty === difficulty;
                const matchesTime = !time || recipe.prepTime === time;
                const matchesServings = !servings || recipe.servings === servings;
                
                return matchesQuery && matchesCategory && matchesCuisine && 
                       matchesDifficulty && matchesTime && matchesServings;
            });

            // Sort
            recipes.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return (a.name || '').localeCompare(b.name || '');
                    case 'date-added': return new Date(b.dateAdded || 0) - new Date(a.dateAdded || 0);
                    case 'difficulty': return (a.difficulty || '').localeCompare(b.difficulty || '');
                    case 'prep-time': return (a.prepTime || 0) - (b.prepTime || 0);
                    case 'rating': return (b.rating || 0) - (a.rating || 0);
                    default: return 0;
                }
            });

            displayRecipes(recipes);
        }

        function resetFilters() {
            document.getElementById('search-query').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-cuisine').value = '';
            document.getElementById('filter-difficulty').value = '';
            document.getElementById('filter-time').value = '';
            document.getElementById('filter-servings').value = '';
            document.getElementById('sort-by').value = 'name';
            searchRecipes();
        }

        function exportRecipes() {
            console.log('üì§ Exporting recipes...');
            // Implement export logic
        }

        function viewRecipe(id) {
            console.log('üëÅÔ∏è Viewing recipe:', id);
            
            // Get recipe data
            let recipe = null;
            
            if (window.universalRecipeManager) {
                recipe = window.universalRecipeManager.getRecipe(id);
            }
            
            if (!recipe) {
                // Fallback to local storage
                const recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
                recipe = recipes.find(r => r.id === id);
            }
            
            if (!recipe) {
                alert('‚ùå Recipe not found!');
                return;
            }
            
            // Show recipe in modal
            showRecipeModal(recipe);
        }
        
        function showRecipeModal(recipe) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 16px 16px 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 10px;">${recipe.name || recipe.title || 'Recipe'}</h2>
                                <p style="opacity: 0.9;">${recipe.category || 'Uncategorized'} | <span id="modal-servings">${recipe.servings || '4'}</span> servings</p>
                                
                                <!-- Recipe Scaling Controls -->
                                <div style="margin-top: 20px; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; opacity: 0.95;">üìê Scale Recipe:</div>
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <button onclick="scaleRecipe(0.5)" style="background: rgba(255,255,255,0.9); color: #667eea; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px;">√ó 0.5</button>
                                        <button onclick="scaleRecipe(2)" style="background: rgba(255,255,255,0.9); color: #667eea; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px;">√ó 2</button>
                                        <button onclick="scaleRecipe(3)" style="background: rgba(255,255,255,0.9); color: #667eea; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px;">√ó 3</button>
                                        <button onclick="scaleRecipe(4)" style="background: rgba(255,255,255,0.9); color: #667eea; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px;">√ó 4</button>
                                        <input type="number" id="custom-scale" placeholder="Custom" min="0.1" step="0.1" style="width: 80px; padding: 8px; border-radius: 6px; border: none; font-weight: 600;">
                                        <button onclick="scaleRecipe(parseFloat(document.getElementById('custom-scale').value) || 1)" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px;">Apply</button>
                                        <button onclick="resetScale()" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">‚Ü∫ Reset</button>
                                    </div>
                                    <div style="margin-top: 8px; font-size: 12px; opacity: 0.85;">Current scale: <span id="current-scale" style="font-weight: 700;">1x</span></div>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" style="background: rgba(255,255,255,0.2); border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; color: white; font-size: 24px; flex-shrink: 0; margin-left: 15px;">‚úï</button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 30px;">
                        ${recipe.description ? `<p style="color: #64748b; margin-bottom: 25px; font-size: 1.1rem;">${recipe.description}</p>` : ''}
                        
                        <!-- Photo Gallery -->
                        <div style="margin-bottom: 25px;" id="recipe-photo-gallery-${recipe.id}"></div>
                        
                        <!-- Ingredients -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 15px; color: #1e293b;">ü•¨ Ingredients</h3>
                            <div id="ingredients-list" style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                                ${(recipe.ingredients || []).map((ing, idx) => `
                                    <div class="ingredient-item" data-index="${idx}" data-original-quantity="${ing.quantity || ing.amount || ''}" style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between;">
                                        <span>${ing.name || ing.ingredient || ing}</span>
                                        <span class="ingredient-quantity" style="font-weight: 600;">${ing.quantity || ing.amount || ''} ${ing.unit || ''}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Instructions -->
                        <div style="margin-bottom: 25px;">
                            <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 15px; color: #1e293b;">üìù Instructions</h3>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                                ${(recipe.instructions || recipe.steps || []).map((step, index) => `
                                    <div style="margin-bottom: 15px; display: flex; gap: 15px;">
                                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">${index + 1}</div>
                                        <div style="flex: 1; padding-top: 5px;">${step.text || step.instruction || step}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 12px;">
                            <button onclick="editRecipe('${recipe.id}')" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ‚úèÔ∏è Edit Recipe
                            </button>
                            <button onclick="this.closest('.fixed').remove()" style="flex: 1; background: #f3f4f6; color: #374151; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store original recipe data for scaling
            window.currentRecipeForScaling = recipe;
            window.currentScaleFactor = 1;
            
            // Load photo gallery if available
            if (window.recipePhotoManager) {
                const photos = window.recipePhotoManager.getRecipePhotos(recipe.id);
                const galleryContainer = document.getElementById(`recipe-photo-gallery-${recipe.id}`);
                if (galleryContainer && photos.length > 0) {
                    galleryContainer.innerHTML = `
                        <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 15px; color: #1e293b;">üì∏ Recipe Photos (${photos.length})</h3>
                        ${window.recipePhotoManager.createGalleryHTML(photos, false)}
                    `;
                }
            }
        }
        
        // Recipe scaling functions
        function scaleRecipe(factor) {
            if (!factor || factor <= 0) {
                alert('Please enter a valid scale factor!');
                return;
            }
            
            window.currentScaleFactor = factor;
            const recipe = window.currentRecipeForScaling;
            const originalServings = recipe.servings || 4;
            const newServings = Math.round(originalServings * factor);
            
            // Update servings display
            document.getElementById('modal-servings').textContent = newServings;
            document.getElementById('current-scale').textContent = factor + 'x';
            
            // Update all ingredient quantities
            const ingredientItems = document.querySelectorAll('.ingredient-item');
            ingredientItems.forEach(item => {
                const originalQty = parseFloat(item.dataset.originalQuantity);
                if (!isNaN(originalQty)) {
                    const newQty = (originalQty * factor).toFixed(2);
                    const quantitySpan = item.querySelector('.ingredient-quantity');
                    const unit = quantitySpan.textContent.split(' ').slice(1).join(' '); // Get the unit
                    quantitySpan.textContent = `${newQty} ${unit}`;
                    
                    // Add visual feedback
                    item.style.background = 'linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%)';
                    setTimeout(() => {
                        item.style.background = '';
                    }, 500);
                }
            });
            
            console.log(`‚úÖ Recipe scaled by ${factor}x: ${originalServings} ‚Üí ${newServings} servings`);
        }
        
        function resetScale() {
            scaleRecipe(1);
            document.getElementById('custom-scale').value = '';
            console.log('‚Ü∫ Recipe scale reset to original');
        }

        function editRecipe(id) {
            console.log('‚úèÔ∏è EDIT BUTTON CLICKED! Recipe ID:', id);
            
            // Validate ID
            if (!id) {
                console.error('‚ùå No recipe ID provided!');
                alert('‚ùå Error: No recipe ID found. Please try again.');
                return;
            }
            
            // Get recipe data using multiple methods
            let recipe = null;
            
            // Method 1: User Data Manager (NEW - best)
            if (window.userDataManager) {
                try {
                    const allRecipes = window.userDataManager.loadData('recipes', { filterByProject: false });
                    recipe = allRecipes.find(r => r.id === id);
                    console.log('üîç Search in userDataManager:', recipe ? 'Found ‚úÖ' : 'Not found ‚ùå');
                    if (recipe) {
                        console.log('   Recipe name:', recipe.name || recipe.title);
                    }
                } catch (e) {
                    console.error('‚ùå Error searching userDataManager:', e);
                }
            } else {
                console.warn('‚ö†Ô∏è userDataManager not available');
            }
            
            // Method 2: Universal Recipe Manager
            if (!recipe && window.universalRecipeManager) {
                try {
                    recipe = window.universalRecipeManager.getRecipe(id);
                    console.log('üîç Search in universalRecipeManager:', recipe ? 'Found ‚úÖ' : 'Not found ‚ùå');
                    if (recipe) {
                        console.log('   Recipe name:', recipe.name || recipe.title);
                    }
                } catch (e) {
                    console.error('‚ùå Error searching universalRecipeManager:', e);
                }
            } else if (!recipe) {
                console.warn('‚ö†Ô∏è universalRecipeManager not available');
            }
            
            // Method 3: Direct localStorage (all keys)
            if (!recipe) {
                console.log('üîç Trying direct localStorage search...');
                const user = window.authManager?.currentUser;
                const userId = user?.uid || user?.userId || user?.id;
                console.log('   User ID:', userId);
                
                // Try user-specific key
                if (userId) {
                    const recipesKey = `recipes_${userId}`;
                    try {
                        const recipesJson = localStorage.getItem(recipesKey);
                        if (recipesJson) {
                            const recipes = JSON.parse(recipesJson);
                            recipe = recipes.find(r => r.id === id);
                            console.log(`   ${recipesKey}:`, recipe ? 'Found ‚úÖ' : 'Not found ‚ùå');
                            if (recipe) {
                                console.log('   Recipe name:', recipe.name || recipe.title);
                            }
                        }
                    } catch (e) {
                        console.error(`‚ùå Error parsing ${recipesKey}:`, e);
                    }
                }
                
                // Try global recipes key
                if (!recipe) {
                    try {
                        const globalRecipes = localStorage.getItem('recipes');
                        if (globalRecipes) {
                            const recipes = JSON.parse(globalRecipes);
                            recipe = recipes.find(r => r.id === id);
                            console.log('   Global recipes:', recipe ? 'Found ‚úÖ' : 'Not found ‚ùå');
                            if (recipe) {
                                console.log('   Recipe name:', recipe.name || recipe.title);
                            }
                        }
                    } catch (e) {
                        console.error('‚ùå Error parsing global recipes:', e);
                    }
                }
            }
            
            // Final check
            if (!recipe) {
                console.error('‚ùå RECIPE NOT FOUND ANYWHERE with ID:', id);
                console.log('üìä Available localStorage keys:', Object.keys(localStorage));
                alert('‚ùå Recipe not found!\n\nThe recipe might have been deleted or not saved properly.\nPlease refresh the page and try again.');
                return;
            }
            
            console.log('‚úÖ SUCCESS! Found recipe:', recipe.name || recipe.title);
            console.log('üì¶ Full recipe data:', recipe);
            
            // Save recipe to multiple storage locations for reliability
            try {
                localStorage.setItem('recipe_to_edit', JSON.stringify(recipe));
                localStorage.setItem('editing_recipe_id', id);
                sessionStorage.setItem('recipe_to_edit', JSON.stringify(recipe));
                console.log('üíæ Recipe saved to edit storage successfully');
            } catch (e) {
                console.error('‚ùå Error saving to storage:', e);
                alert('‚ùå Error preparing recipe for editing. Please try again.');
                return;
            }
            
            // Navigate to recipe developer in edit mode
            console.log('üîÑ Navigating to recipe-developer.html?edit=' + id);
            
            // Add a small delay to ensure storage is written
            setTimeout(() => {
                window.location.href = `recipe-developer.html?edit=${encodeURIComponent(id)}`;
            }, 100);
        }

        function duplicateRecipe(id) {
            console.log('üìã Duplicating recipe:', id);
            
            // Get recipe data
            let recipe = null;
            
            if (window.universalRecipeManager) {
                recipe = window.universalRecipeManager.getRecipe(id);
            }
            
            if (!recipe) {
                // Fallback to local storage
                const recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
                recipe = recipes.find(r => r.id === id);
            }
            
            if (!recipe) {
                alert('‚ùå Recipe not found!');
                return;
            }
            
            // Create duplicate with new ID
            const duplicate = {
                ...recipe,
                id: `recipe_${Date.now()}`,
                name: `${recipe.name || recipe.title} (Copy)`,
                title: `${recipe.name || recipe.title} (Copy)`,
                createdAt: new Date().toISOString()
            };
            
            // Save duplicate
            if (window.universalRecipeManager) {
                window.universalRecipeManager.addRecipe(duplicate);
            }
            
            // Reload recipes
            loadRecipes();
            
            alert(`‚úÖ Recipe "${recipe.name || recipe.title}" duplicated!`);
        }

        function deleteRecipe(id) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                const recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
                const filtered = recipes.filter(r => r.id !== id);
                localStorage.setItem('recipes', JSON.stringify(filtered));
                loadRecipes();
                console.log('üóëÔ∏è Recipe deleted:', id);
            }
        }

        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab) {
                dropdown.classList.toggle('active');
                userTab.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const userTab = document.querySelector('.header-user-tab');
            
            if (dropdown && userTab && !userTab.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
                userTab.classList.remove('active');
            }
        });

        // Toggle mobile navigation
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobile-nav');
            if (mobileNav) {
                mobileNav.classList.toggle('active');
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobile-nav');
            const mobileToggle = document.querySelector('.header-mobile-toggle');
            
            if (mobileNav && mobileToggle && !mobileToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });

        // Function to update header user display
        function updateHeaderUserDisplay(user) {
            if (!user) return;
            
            // Update user avatar initial
            const avatarInitial = document.getElementById('user-avatar-initial');
            if (avatarInitial) {
                avatarInitial.textContent = user.name.charAt(0).toUpperCase();
            }
            
            // Update current user name
            const currentUserName = document.getElementById('current-user');
            if (currentUserName) {
                currentUserName.textContent = user.name;
            }
            
            // Update dropdown user name
            const dropdownUserName = document.getElementById('dropdown-user-name');
            if (dropdownUserName) {
                dropdownUserName.textContent = user.name;
            }
            
            // Update dropdown user role
            const dropdownUserRole = document.getElementById('dropdown-user-role');
            if (dropdownUserRole) {
                dropdownUserRole.textContent = user.role || 'Chef';
            }
            
            console.log('‚úÖ Header user display updated for:', user.name);
        }

        // Listen for user authentication events to keep header synchronized
        document.addEventListener('userLoggedIn', function(event) {
            console.log('üîê User logged in event received on recipe library page');
            if (event.detail && event.detail.user) {
                updateHeaderUserDisplay(event.detail.user);
            }
        });

        document.addEventListener('userSwitched', function(event) {
            console.log('üîÑ User switched event received on recipe library page');
            if (event.detail && event.detail.user) {
                updateHeaderUserDisplay(event.detail.user);
            }
        });

        document.addEventListener('userLoggedOut', function(event) {
            console.log('üö™ User logged out event received on recipe library page');
            // Reset header to guest state
            updateHeaderUserDisplay({
                name: 'Guest User',
                role: 'Guest'
            });
        });

        document.addEventListener('iterumUserDataLoaded', function(event) {
            console.log('üì• User data loaded event received on recipe library page');
            if (event.detail && event.detail.user) {
                updateHeaderUserDisplay(event.detail.user);
            }
        });
    </script>

    <!-- Initialize Unified Authentication System -->
    <script>
      // Initialize authentication system when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM loaded, initializing authentication system...');
        
        // Wait a moment for all scripts to load
        setTimeout(() => {
          if (typeof UnifiedAuthSystem !== 'undefined') {
            console.log('‚úÖ UnifiedAuthSystem class found, creating instance...');
            window.unifiedAuthSystem = new UnifiedAuthSystem();
            window.unifiedAuth = window.unifiedAuthSystem; // Alias for onclick handlers
            console.log('‚úÖ Authentication system initialized');
          } else {
            console.error('‚ùå UnifiedAuthSystem class not found');
          }
          
          // Initialize page protection if available
          if (typeof PageProtection !== 'undefined') {
            console.log('‚úÖ PageProtection class found, creating instance...');
            window.pageProtection = new PageProtection();
            console.log('‚úÖ Page protection system initialized');
          } else {
            console.warn('‚ö†Ô∏è PageProtection class not found');
          }
        }, 100);
      });
    </script>
    
    <!-- Load Firebase Modules -->
    <script type="module" src="assets/js/firebase-auth.js"></script>
    <script type="module" src="assets/js/firebase-auth-ui.js"></script>
    <script type="module" src="assets/js/firestore-sync.js"></script>
    
    <!-- Load User Display -->
    <script src="assets/js/header-user-display.js"></script>
    
    <!-- Load Profile Editor -->
    <script src="assets/js/profile-editor.js"></script>
    
    <!-- Load Email Verification Banner -->
    <script src="assets/js/email-verification-banner.js"></script>
    
    <!-- Central Data Loader -->
    <script src="assets/js/central-data-loader.js"></script>
    
    <!-- State Persistence Manager - Ensures user and project persist across pages -->
    <script src="assets/js/state-persistence-manager.js"></script>
    
    <!-- Universal Recipe Manager - Ensures all recipes go to library -->
    <script src="assets/js/universal-recipe-manager.js"></script>
    
    <!-- Secure Storage Manager - Fast & Secure IndexedDB storage -->
    <script src="assets/js/secure-storage-manager.js"></script>
    
    <!-- Load Project UI Manager -->
    <script defer src="assets/js/project-ui-manager.js"></script>
    
    <!-- UI Polish Systems -->
    <script src="assets/js/toast-notifications.js"></script>
    <script src="assets/js/loading-states.js"></script>
    <script src="assets/js/empty-states.js"></script>
    
    <!-- Recipe Photo Manager -->
    <script src="assets/js/recipe-photo-manager.js"></script>
</body>
</html>